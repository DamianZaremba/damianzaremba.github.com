<!DOCTYPE html> <html lang=en> <head> <title>Damian Zaremba - Blog</title> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta http-equiv=Content-Type content="text/html; charset=UTF-8"/> <meta name=description content="Damian Zaremba's Blog"/> <meta name=google-site-verification content=qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo /> <meta name=author content="Damian Zaremba"/> <link rel=alternate type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba"/> <meta name=robots content=INDEX /> <meta name=robots content=FOLLOW /> <meta name=robots content="INDEX,FOLLOW"/> <link href="/assests/css/bootstrap.min.css?_v=58a49b3689d699cb72ffda7252d99fcb" rel=stylesheet> <link href="/assests/css/main.css?_v=d2c89647dc3d0886383e347a9048f62c" rel=stylesheet> </head> <body> <nav class="navbar navbar-default navbar-fixed-top"> <div class=container> <div class=navbar-header> <button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target="#navbar" aria-expanded=false aria-controls=navbar> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href="/">Damian Zaremba</a> </div> <div id=navbar class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li class=active><a href="/">Blog</a></li> <li class=""><a href="/about/">About</a></li> <li class=""><a href="/cv/">CV</a></li> <li class=""><a href="/archive/">Archive</a></li> <li class=""><a href="/projects/">Projects</a></li> </ul> <div class="social-icons navbar-right visible-md visible-lg"> <a href="http://twitter.com/DamianZaremba"> <img class=twitter src="/assests/images/twitter.png?_v=5c9d07bd2ff1f5224934583b6be57b0a" alt=Twitter /> </a> <a href="https://github.com/DamianZaremba"> <img class=github src="/assests/images/github.png?_v=438c17272c5f0e9f4a6da34d3e4bc5bd" alt=GitHub /> </a> <a href="http://feeds.feedburner.com/DamianZaremba"> <img class=rss src="/assests/images/rss.png?_v=f6fa89d6cfe5f5e95f0f87205d8c4b11" alt=RSS /> </a> </div> </div> </div> </nav> <div class=container> <article class=post> <h1 class=title><a href="/2017/12/decoding-ipfix-options-using-go/">Decoding IPFIX options using Go</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />28 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/decoding-ipfix-options-using-go/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/go'>Go</a></li></ul> </div> <div class=entry> <p>The IPFIX (IP Flow Information Export) protocol provides an extensible standard for transmitting network flow data.</p> <p>A key difference compared to the likes of <a href="http://www.sflow.org/">sflow</a>, is the template-based nature of data.</p> <p>While very similar to NetFlow version 9, IPFIX enables variable length fields and vendor extensions. This makes the protocol suitable for different types of performance data, as desired by any vendor.</p> <p>A recent project required some processing of IPFIX flow data, which this post will focus on.</p> <p><em>TL;DR The full implementation can be found on <a href="https://github.com/DamianZaremba/ipfix_options_demo">Github</a></em></p> <h2>Parsing options</h2> <p>A number of IPFIX decoder implementations exist in Go, most are included in flow decoder implementations, rather than standalone libraries.</p> <p>The best stand-alone library I could fix is <a href="https://github.com/calmh/ipfix">github.com/calmh/ipfix</a>, but this doesn't support <a href="https://github.com/calmh/ipfix/blob/master/parser.go#L296-L301">decoding options</a>.</p> <p>To better understand the scope of implementation and overall structure of IPFIX, a stand-alone decoder was implemented.</p> <h2>Data structure</h2> <p>To begin implementing our own decoder, we first need to understand the format of packets used in IPFIX.</p> <p>We can use both the <a href="https://www.iana.org/assignments/ipfix/ipfix.xhtml">IANA field assignments</a> and <a href="https://tools.ietf.org/html/rfc7011">RFC</a> to construct our base expectations.</p> <p>At a high level, there is 1 common header then 3 different payload types</p> <ul> <li>Data template</li> <li>Options template</li> <li>Data set</li> </ul> <p>We are interested in the options template and data set (where we have a matching template ID, more on this later).</p> <h2>Decoding the header</h2> <p>As described in the <a href="https://tools.ietf.org/html/rfc7011#section-3.1">RFC</a>, we can expect 5 fields.</p> <p>Followed by the message header we have a set identifier, which describes the message contents; for our purposes, we will use this as part of the header.</p> <pre><code class="go">header := IpfixHeader{
    Version:        binary.BigEndian.Uint16(payload[0:2]),
    MessageLength:  binary.BigEndian.Uint16(payload[2:4]),
    ExportTime:     binary.BigEndian.Uint32(payload[4:8]),
    SequenceNumber: binary.BigEndian.Uint32(payload[8:12]),
    DomainId:       binary.BigEndian.Uint32(payload[12:16]),
    SetId:          binary.BigEndian.Uint16(payload[16:20]),
}
</code></pre> <p>We are interested in any SetId that is 3 (options template) or >= 256 (data set).</p> <h2>Decoding the template</h2> <p>Before any data can be decoded, we must have a matching template.</p> <p>Without the template, there is no way to know how the fields are mapped inside the data set.</p> <p>Each template payload (SetId 2 or 3) has a header containing the ID and field counts.</p> <pre><code class="go">template := OptionsTemplate{
  TemplateId:      binary.BigEndian.Uint16(payload[0:2]),
  FieldCount:      binary.BigEndian.Uint16(payload[2:4]),
  ScopeFieldCount: binary.BigEndian.Uint16(payload[4:6]),
}
</code></pre> <p>Once again, using the <a href="https://tools.ietf.org/html/rfc7011#section-3.4.1">RFC</a>, we can determine the payload is a sequence of field separators.</p> <p>The number of separators corresponds to the values in the header we just decoded.</p> <p>The ordering of these fields is critical for us to maintain.</p> <p>Note: Unlike a data template, the options template has a set of scope fields.</p> <h3>Decode the fields</h3> <p>Both scope fields and fields have the same structure, thus can be decoded using the same logic.</p> <pre><code class="go">func decodeSingleTemplateField(payload []byte) (TemplateField, int) {
  tf := TemplateField{
    ElementId: binary.BigEndian.Uint16(payload[0:2]),
    Length:    binary.BigEndian.Uint16(payload[2:4]),
  }

  if tf.ElementId &gt; 0x8000 {
    tf.ElementId = tf.ElementId &amp; 0x7fff
    tf.EnterpriseNumber = binary.BigEndian.Uint32(payload[0:4])
    return tf, 8
  }

  return tf, 4
}
</code></pre> <p>It's then simply a case of decoding each field in sequence and storing them for later</p> <pre><code class="go">// Get all scope entries
for i := template.ScopeFieldCount; i &gt; 0; i-- {
  tf, cut := decodeSingleTemplateField(byteSlice)
  template.ScopeField = append(template.ScopeField, tf)

  if len(byteSlice) &lt; cut {
    break
  }
  byteSlice = byteSlice[cut:]
}

// Get all field entries
for i := template.FieldCount - template.ScopeFieldCount; i &gt; 0; i-- {
  tf, cut := decodeSingleTemplateField(byteSlice)
  template.Field = append(template.Field, tf)

  if len(byteSlice) &lt; cut {
    break
  }
  byteSlice = byteSlice[cut:]
}
</code></pre> <h3>Cache the template</h3> <p>Now we have the template decoded, it is important to store it. The fields described in the template need to be used when decoding the data set, which we will look at next.</p> <p>A simple way to store this is using the LRU cache implementation from Hashicorp, <a href="github.com/hashicorp/golang-lru">github.com/hashicorp/golang-lru</a>.</p> <p>All future lookups will be via the ID, so using this as the key make sense.</p> <pre><code class="go">templateCache, err := lru.New(10240)
if err != nil {
  log.Fatalf("Failed to setup options template cache: %v", err)
}

templateCache.Add(template.Id, template)
</code></pre> <h2>Decoding the data set</h2> <p>Any set ID over 255 represents a data set, the set ID refers to the template we need to use when decoding the data set.</p> <p>First, we need to ensure we have a matching template for this payload.</p> <pre><code class="go">cacheEntry, ok := templateCache.Get(header.SetId)
if !ok {
  return nil, true
}
template := cacheEntry.(OptionsTemplate)
</code></pre> <p>Once we have the template, it's a case of decoding each option in sequence.</p> <p>Again, both scope fields and fields can be decoded using the same logic.</p> <h3>Field decoding</h3> <p>The option decoding logic has 3 main tasks:</p> <ul> <li>Read the correct length of bytes off the payload</li> <li>Lookup the associated name of the field from the identifier</li> <li>Cast the byte array into the correct data type for the identifier</li> </ul> <p>The <a href="https://www.iana.org/assignments/ipfix/ipfix.xhtml">IANA field assignments</a> accurately describe the field data we need to complete these tasks.</p> <pre><code class="go">func decodeSingleOption(byteSlice []byte, field TemplateField, options Options) {
    // Check we have enough data
    if len(byteSlice) &lt; int(field.Length) {
        return
    }

    // Handle each enterprise
    switch field.EnterpriseNumber {
    case 0:
        // Handle elements for enterprise 0
        switch field.ElementId {
        case 34:
            // samplingInterval
            options["samplingInterval"] = binary.BigEndian.Uint32(byteSlice[:int(field.Length)])
        case 36:
            // flowActiveTimeout
            options["flowActiveTimeout"] = binary.BigEndian.Uint16(byteSlice[:int(field.Length)])
        case 37:
            // flowIdleTimeout
            options["flowIdleTimeout"] = binary.BigEndian.Uint16(byteSlice[:int(field.Length)])
        case 41:
            // exportedMessageTotalCount
            options["exportedMessageTotalCount"] = binary.BigEndian.Uint64(byteSlice[:int(field.Length)])
        case 42:
            // exportedFlowRecordTotalCount
            options["exportedFlowRecordTotalCount"] = binary.BigEndian.Uint64(byteSlice[:int(field.Length)])
        case 130:
            // exporterIPv4Address
            options["exporterIPv4Address"] = net.IP(byteSlice[:int(field.Length)])
        case 131:
            // exporterIPv6Address
            options["exporterIPv6Address"] = net.IP(byteSlice[:int(field.Length)])
        case 144:
            // exportingProcessId
            options["exportingProcessId"] = binary.BigEndian.Uint32(byteSlice[:int(field.Length)])
        case 160:
            // systemInitTimeMilliseconds
            options["exportingProcessId"] = int64(binary.BigEndian.Uint64(byteSlice[:int(field.Length)]))
        case 214:
            // exportProtocolVersion
            options["exportProtocolVersion"] = uint8(byteSlice[0])
        case 215:
            // exportTransportProtocol
            options["exportTransportProtocol"] = uint8(byteSlice[0])
        }
    }
}
</code></pre> <p>The order of fields in the data set is identical to the order in the template, so once again it's just a case of looping over them.</p> <pre><code class="go">// Read all scope field separators
for i := 0; i &lt; len(template.ScopeField); i++ {
  decodeSingleOption(byteSlice, template.ScopeField[i], options)

  if len(byteSlice) &lt; int(template.ScopeField[i].Length) {
    break
  }
  byteSlice = byteSlice[int(template.ScopeField[i].Length):]
}

// Read all field separators
for i := 0; i &lt; len(template.Field); i++ {
  decodeSingleOption(byteSlice, template.Field[i], options)

  if len(byteSlice) &lt; int(template.Field[i].Length) {
    break
  }
  byteSlice = byteSlice[int(template.Field[i].Length):]
}
</code></pre> <h2>Result</h2> <p>We now have a subset of the IANA fields supported in our decoder.</p> <p>Given a correct template and data payload, the result is a map of received options.</p> <pre><code class="go">map[
  exportedMessageTotalCount: 250
  exportedFlowRecordTotalCount: 10
  samplingInterval: 10
  flowIdleTimeout: 15
  exportingProcessId: 72
  exporterIPv4Address: 192.168.0.1
  exporterIPv6Address: ::
  flowActiveTimeout: 60
  exportProtocolVersion: 10
  exportTransportProtocol: 17
]
</code></pre> <h2>Summary</h2> <p>IPFIX is a highly flexible protocol with a relatively simple data format, allowing parsing to be easily implemented.</p> <p>While the implementation's boundary checking could be improved, the exercise of creating an actual implementation from documented implementation I would recommend to all.</p> <p>You may also find that some vendors have interesting assumptions within their options handling, with many configuration knobs missing compared to data templates.</p> <p>Having this functionality separated from <a href="https://github.com/calmh/ipfix">upstream code</a> proved to be fruitful, allowing certain options to be stored and distributed outside of normal flow collection.</p> <p>The full implementation can be found on <a href="https://github.com/DamianZaremba/ipfix_options_demo">Github</a>, with basic test cases added for each implemented field.</p> </div> </article> <article class=post> <h1 class=title><a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/">Decoding Arista EtherType headers with gopacket</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />27 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/go'>Go</a></li></ul> </div> <div class=entry> <p>As we <a href="/2017/12/a-look-at-low-cost-tap-aggregation/">previously discussed</a>, using cheap switches to aggregate multiple tap sources gives you a lot of power.</p> <p>However, given the multiple feeds, how can you measure timing information accurately 1 hop away?</p> <p>Using hardware time stamping provides a highly accurate record of when packets were processed by devices, making it perfect for TAP aggregation.</p> <h2>Revisiting the 7150 platform</h2> <p>On the 7150 series hardware, time stamping is supported at line-rate using PTP.</p> <p>You have two options for timestamp placement;</p> <ul> <li>Replacement of the FCS (<code>mac timestamp replace-fcs</code>):</li> </ul> <div class=graphviz-wrapper> <svg role=img aria-label="7150 timestamp replace fcs" width=526pt height=148pt viewBox="0.00 0.00 526.00 148.00"> <title>7150 timestamp replace fcs</title> <desc>digraph &quot;7150 timestamp replace fcs&quot; { subgraph cluster { rankdir=LR; height=1.5; &quot;Timestamp&quot; [shape=square, height=1.5]; &quot;Payload&quot; [shape=square, height=1.5]; &quot;IP Header&quot; [shape=square, height=1.5]; &quot;Ethernet Header&quot; [shape=square, height=1.5]; } }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 144)"> <title>7150 timestamp replace fcs</title> <polygon fill=white stroke=none points="-4,4 -4,-144 522,-144 522,4 -4,4"/> <g id=clust1 class=cluster><title>cluster</title> <polygon fill=none stroke=black points="8,-8 8,-132 510,-132 510,-8 8,-8"/> </g> <g id=node1 class=node><title>Timestamp</title> <polygon fill=none stroke=black points="502,-124 394,-124 394,-16 502,-16 502,-124"/> <text text-anchor=middle x=448 y="-66.3" font-family="Times,serif" font-size="14.00">Timestamp</text> </g> <g id=node2 class=node><title>Payload</title> <polygon fill=none stroke=black points="376,-124 268,-124 268,-16 376,-16 376,-124"/> <text text-anchor=middle x=322 y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text> </g> <g id=node3 class=node><title>IP Header</title> <polygon fill=none stroke=black points="250,-124 142,-124 142,-16 250,-16 250,-124"/> <text text-anchor=middle x=196 y="-66.3" font-family="Times,serif" font-size="14.00">IP Header</text> </g> <g id=node4 class=node><title>Ethernet Header</title> <polygon fill=none stroke=black points="124,-124 16,-124 16,-16 124,-16 124,-124"/> <text text-anchor=middle x=70 y="-66.3" font-family="Times,serif" font-size="14.00">Ethernet Header</text> </g> </g> </svg> </div> <ul> <li>Appending of the timestamp (<code>mac timestamp before-fcs</code>):</li> </ul> <div class=graphviz-wrapper> <svg role=img aria-label="7150 timestamp append" width=652pt height=148pt viewBox="0.00 0.00 652.00 148.00"> <title>7150 timestamp append</title> <desc>digraph &quot;7150 timestamp append&quot; { subgraph cluster { rankdir=LR; height=1.5; &quot;FCS&quot; [shape=square, height=1.5]; &quot;Timestamp&quot; [shape=square, height=1.5]; &quot;Payload&quot; [shape=square, height=1.5]; &quot;IP Header&quot; [shape=square, height=1.5]; &quot;Ethernet Header&quot; [shape=square, height=1.5]; } }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 144)"> <title>7150 timestamp append</title> <polygon fill=white stroke=none points="-4,4 -4,-144 648,-144 648,4 -4,4"/> <g id=clust1 class=cluster><title>cluster</title> <polygon fill=none stroke=black points="8,-8 8,-132 636,-132 636,-8 8,-8"/> </g> <g id=node1 class=node><title>FCS</title> <polygon fill=none stroke=black points="628,-124 520,-124 520,-16 628,-16 628,-124"/> <text text-anchor=middle x=574 y="-66.3" font-family="Times,serif" font-size="14.00">FCS</text> </g> <g id=node2 class=node><title>Timestamp</title> <polygon fill=none stroke=black points="502,-124 394,-124 394,-16 502,-16 502,-124"/> <text text-anchor=middle x=448 y="-66.3" font-family="Times,serif" font-size="14.00">Timestamp</text> </g> <g id=node3 class=node><title>Payload</title> <polygon fill=none stroke=black points="376,-124 268,-124 268,-16 376,-16 376,-124"/> <text text-anchor=middle x=322 y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text> </g> <g id=node4 class=node><title>IP Header</title> <polygon fill=none stroke=black points="250,-124 142,-124 142,-16 250,-16 250,-124"/> <text text-anchor=middle x=196 y="-66.3" font-family="Times,serif" font-size="14.00">IP Header</text> </g> <g id=node5 class=node><title>Ethernet Header</title> <polygon fill=none stroke=black points="124,-124 16,-124 16,-16 124,-16 124,-124"/> <text text-anchor=middle x=70 y="-66.3" font-family="Times,serif" font-size="14.00">Ethernet Header</text> </g> </g> </svg> </div> <p>The implementation of this is a little 'quirky'.</p> <p>Looking at the <code>Timestamp</code> value alone will not help you as it's an internal ASIC counter on the switch, essentially providing the lower half of the timestamp.</p> <p>To calculate the actual (Unix based) timestamp, another keyframe packet has to be processed and tracked (every ~6 seconds); providing the first half of the timestamp.</p> <p>While possible to implement, the imposed state and skew calculations is a little unappealing.</p> <h2>A look into the 7500{E,R}/7280{E,R} series</h2> <p>On the newer platforms, Arista has moved away from using the keyframe setup and introduced a custom EtherType. Again, using hardware time stamping at line-rate &amp; supporting PTP.</p> <p>There is 3 possible time stamping modes on the 7500{E,R} &amp; 7280{E,R} series switches:</p> <ul> <li>64-bit header timestamp; i.e., encapsulated in the L2 header</li> <li>48-bit header timestamp; i.e., encapsulated in the L2 header</li> <li>48-bit timestamp that replaces the Source MAC</li> </ul> <p>We will focus on the first 2 options that use a customer EtherType inside the layer 2 header.</p> <p><em>Note: All timestamps are captured upon packet ingress and stamped on packet egress.</em></p> <h3>A look into the packet format</h3> <p>Let's compare a normal ethernet header:</p> <div class=graphviz-wrapper> <svg role=img aria-label="ethernet header" width=652pt height=148pt viewBox="0.00 0.00 652.00 148.00"> <title>ethernet header</title> <desc>digraph &quot;ethernet header&quot; { subgraph cluster { rankdir=LR; height=1.5; &quot;FCS&quot; [shape=square, height=1.5]; &quot;Payload&quot; [shape=square, height=1.5]; &quot;Length/Type&quot; [shape=square, height=1.5]; &quot;Src Address&quot; [shape=square, height=1.5]; &quot;Dst Address&quot; [shape=square, height=1.5]; } }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 144)"> <title>ethernet header</title> <polygon fill=white stroke=none points="-4,4 -4,-144 648,-144 648,4 -4,4"/> <g id=clust1 class=cluster><title>cluster</title> <polygon fill=none stroke=black points="8,-8 8,-132 636,-132 636,-8 8,-8"/> </g> <g id=node1 class=node><title>FCS</title> <polygon fill=none stroke=black points="628,-124 520,-124 520,-16 628,-16 628,-124"/> <text text-anchor=middle x=574 y="-66.3" font-family="Times,serif" font-size="14.00">FCS</text> </g> <g id=node2 class=node><title>Payload</title> <polygon fill=none stroke=black points="502,-124 394,-124 394,-16 502,-16 502,-124"/> <text text-anchor=middle x=448 y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text> </g> <g id=node3 class=node><title>Length/Type</title> <polygon fill=none stroke=black points="376,-124 268,-124 268,-16 376,-16 376,-124"/> <text text-anchor=middle x=322 y="-66.3" font-family="Times,serif" font-size="14.00">Length/Type</text> </g> <g id=node4 class=node><title>Src Address</title> <polygon fill=none stroke=black points="250,-124 142,-124 142,-16 250,-16 250,-124"/> <text text-anchor=middle x=196 y="-66.3" font-family="Times,serif" font-size="14.00">Src Address</text> </g> <g id=node5 class=node><title>Dst Address</title> <polygon fill=none stroke=black points="124,-124 16,-124 16,-16 124,-16 124,-124"/> <text text-anchor=middle x=70 y="-66.3" font-family="Times,serif" font-size="14.00">Dst Address</text> </g> </g> </svg> </div> <p>To one with the customer EtherType inserted:</p> <div class=graphviz-wrapper> <svg role=img aria-label="ethernet header extended" width=1090pt height=148pt viewBox="0.00 0.00 1090.00 148.00"> <title>ethernet header extended</title> <desc>digraph &quot;ethernet header extended&quot; { subgraph cluster { rankdir=LR; height=1.5; &quot;FCS&quot; [shape=square, height=1.5]; &quot;Payload&quot; [shape=square, height=1.5]; &quot;Length/Type&quot; [shape=square, height=1.5]; &quot;Timestamp&quot; [shape=square, height=1.2]; &quot;Version&quot; [shape=square, height=1.2]; &quot;Sub-Type&quot; [shape=square, height=1.2]; &quot;EtherType&quot; [shape=square, height=1.5]; &quot;Src Address&quot; [shape=square, height=1.5]; &quot;Dst Address&quot; [shape=square, height=1.5]; } }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 144)"> <title>ethernet header extended</title> <polygon fill=white stroke=none points="-4,4 -4,-144 1086,-144 1086,4 -4,4"/> <g id=clust1 class=cluster><title>cluster</title> <polygon fill=none stroke=black points="8,-8 8,-132 1074,-132 1074,-8 8,-8"/> </g> <g id=node1 class=node><title>FCS</title> <polygon fill=none stroke=black points="1066,-124 958,-124 958,-16 1066,-16 1066,-124"/> <text text-anchor=middle x=1012 y="-66.3" font-family="Times,serif" font-size="14.00">FCS</text> </g> <g id=node2 class=node><title>Payload</title> <polygon fill=none stroke=black points="940,-124 832,-124 832,-16 940,-16 940,-124"/> <text text-anchor=middle x=886 y="-66.3" font-family="Times,serif" font-size="14.00">Payload</text> </g> <g id=node3 class=node><title>Length/Type</title> <polygon fill=none stroke=black points="814,-124 706,-124 706,-16 814,-16 814,-124"/> <text text-anchor=middle x=760 y="-66.3" font-family="Times,serif" font-size="14.00">Length/Type</text> </g> <g id=node4 class=node><title>Timestamp</title> <polygon fill=none stroke=black points="688,-113 602,-113 602,-27 688,-27 688,-113"/> <text text-anchor=middle x=645 y="-66.3" font-family="Times,serif" font-size="14.00">Timestamp</text> </g> <g id=node5 class=node><title>Version</title> <polygon fill=none stroke=black points="584,-113 498,-113 498,-27 584,-27 584,-113"/> <text text-anchor=middle x=541 y="-66.3" font-family="Times,serif" font-size="14.00">Version</text> </g> <g id=node6 class=node><title>Sub&#45;Type</title> <polygon fill=none stroke=black points="480,-113 394,-113 394,-27 480,-27 480,-113"/> <text text-anchor=middle x=437 y="-66.3" font-family="Times,serif" font-size="14.00">Sub&#45;Type</text> </g> <g id=node7 class=node><title>EtherType</title> <polygon fill=none stroke=black points="376,-124 268,-124 268,-16 376,-16 376,-124"/> <text text-anchor=middle x=322 y="-66.3" font-family="Times,serif" font-size="14.00">EtherType</text> </g> <g id=node8 class=node><title>Src Address</title> <polygon fill=none stroke=black points="250,-124 142,-124 142,-16 250,-16 250,-124"/> <text text-anchor=middle x=196 y="-66.3" font-family="Times,serif" font-size="14.00">Src Address</text> </g> <g id=node9 class=node><title>Dst Address</title> <polygon fill=none stroke=black points="124,-124 16,-124 16,-16 124,-16 124,-124"/> <text text-anchor=middle x=70 y="-66.3" font-family="Times,serif" font-size="14.00">Dst Address</text> </g> </g> </svg> </div> <p><em>Note: .1q payloads are also supported, with the EtherType coming after the Source Address</em></p> <p>As you can see an extra 4 fields have been inserted into the header;</p> <ul> <li>EtherType - 0xD28B - An identifier for AristaEtherType</li> <li>Protocol sub-type - 0x1 - A sub-identifier for the AristaEtherType</li> <li>Version - 0x10 or 0x20 - An identifier for either 64bit or 48bit</li> <li>Timestamp - An IEEE 1588 time of day format</li> </ul> <p>The timestamp is either 32 bits (seconds) followed by 32 bits (nanoseconds) or 16 bits (seconds) followed by 32 bits (nanoseconds) depending on the 64 or 48bit mode.</p> <h4>Configuration</h4> <p>Enabling hardware timestamping on the platform is rather simple;</p> <ul> <li><code>mac timestamp header</code> enables timestamping on tool ports</li> <li><code>mac timestamp header format &lt;64bit | 48bit&gt;</code> sets the format of the timestamp</li> <li><code>mac timestamp replace source-mac</code> enables replacing the source mac address with the timestamp</li> </ul> <p>There are some limitations to the time stamping support, notably;</p> <ul> <li>Timestamping is done after packet processing, resulting in ~10ns of delay</li> <li>64bit timestamps may rollover inconsistency every 4 seconds causing jumps between packets</li> </ul> <h3>Decoding the packets</h3> <p>Now we've changed the Ethernet header, it requires a specific decoder to be able to process.</p> <p>Without a specific decoder, it is no longer a valid Ethernet header as Length field contains a meaningless value.</p> <p>Arista <a href="https://eos.arista.com/analyzing-packet-header-timestamps-in-wireshark/">provides</a> an LUA extension for Wireshark for this purpose.</p> <h2>Decoding custom EtherTypes in gopacket</h2> <p><a href="https://github.com/google/gopacket">gopacket</a> has a very useful pcap interface, making it very easy to process data collected from TAP infrastructure.</p> <p>Investigating the structure, it made sense to implement a custom <a href="https://godoc.org/github.com/google/gopacket/layers">layer</a> to handle our EtherType.</p> <p>After some experimentation, while this provided decoding of the timestamp data, it prevented further processing of the packets, resulting in the IP layer being inaccessible; this was complicated due to our now invalid Ethernet header.</p> <p>A simple solution of extending the built-in <a href="https://godoc.org/github.com/google/gopacket/layers#EthernetType">EthernetType</a> was called for.</p> <pre><code class="go">// Copyright 2012 Google, Inc. All rights reserved.
// Copyright 2009-2011 Andreas Krennmair. All rights reserved.
//
// Use of this source code is governed by a BSD-style license
// that can be found in the LICENSE file in the root of the source
// tree.
package decoder

import (
    "encoding/binary"
    "errors"
    "github.com/google/gopacket"
    "github.com/google/gopacket/layers"
    "net"
)

// This layer has a two-byte protocol subtype of 0x1,
// a two-byte protocol version of 0x10 and
// an eight-byte UTC timestamp in IEEE 1588 time of format
// So that would be 12 bytes in totally we need to strip off right after the src mac
type AristaEtherType struct {
    ProtocolSubType      uint16
    ProtocolVersion      uint16
    TimestampSeconds     uint32
    TimestampNanoSeconds uint32
}

// AristaExtendedEthernet is the layer of a normal or Arista extended Ethernet frame headers.
// This is the same as layers.Ethernet, but may have AristaEtherType filled with data
type AristaExtendedEthernet struct {
    layers.Ethernet
    AristaEtherType AristaEtherType
}

func (eth *AristaExtendedEthernet) DecodeFromBytes(data []byte, df gopacket.DecodeFeedback) error {
    if len(data) &lt; 14 {
        return errors.New("AristaExtendedEthernet packet too small")
    }
    eth.DstMAC = net.HardwareAddr(data[0:6])
    eth.SrcMAC = net.HardwareAddr(data[6:12])

    // https://eos.arista.com/eos-4-18-1f/tap-aggregation-ingress-header-time-stamping/
    // Arista places 12 bytes directly after the src mac, see AristaEtherType comments for structure
    // We handle both timestamped and non-timestamped frames here
    etherType := binary.BigEndian.Uint16(data[12:14])
    if len(data) &gt;= 26 &amp;&amp; etherType == 53899 {
        eth.AristaEtherType = AristaEtherType{
            ProtocolSubType:      binary.BigEndian.Uint16(data[14:16]),
            ProtocolVersion:      binary.BigEndian.Uint16(data[16:18]),
            TimestampSeconds:     binary.BigEndian.Uint32(data[18:22]),
            TimestampNanoSeconds: binary.BigEndian.Uint32(data[22:26]),
        }
        eth.EthernetType = layers.EthernetType(binary.BigEndian.Uint16(data[26:28]))
        eth.BaseLayer = layers.BaseLayer{data[:28], data[28:]}
    } else {
        eth.EthernetType = layers.EthernetType(binary.BigEndian.Uint16(data[12:14]))
        eth.BaseLayer = layers.BaseLayer{data[:14], data[14:]}
    }

    // Logic from the upstream Ethernet code
    if eth.EthernetType &lt; 0x0600 {
        eth.Length = uint16(eth.EthernetType)
        eth.EthernetType = layers.EthernetTypeLLC
        if cmp := len(eth.Payload) - int(eth.Length); cmp &lt; 0 {
            df.SetTruncated()
        } else if cmp &gt; 0 {
            eth.Payload = eth.Payload[:len(eth.Payload)-cmp]
        }
    }
    return nil
}

// Required methods to be a valid layer
func (e *AristaExtendedEthernet) LinkFlow() gopacket.Flow {
    return gopacket.NewFlow(layers.EndpointMAC, e.SrcMAC, e.DstMAC)
}

func (e *AristaExtendedEthernet) LayerType() gopacket.LayerType {
  return gopacket.LayerType(17)
}

func (eth *AristaExtendedEthernet) NextLayerType() gopacket.LayerType {
    return eth.EthernetType.LayerType()
}

// Public function
func DecodeAristaExtendedEthernet(data []byte, p gopacket.PacketBuilder) error {
    eth := &amp;AristaExtendedEthernet{}
    err := eth.DecodeFromBytes(data, p)
    if err != nil {
        return err
    }
    p.AddLayer(eth)
    p.SetLinkLayer(eth)
    return p.NextDecoder(eth.EthernetType)
}
</code></pre> <p>Now we have the custom decoder, we just need to register it with gopacket. This makes gopacket use our decoder implementation rather than the built-in Ethernet one.</p> <pre><code class="go">import (
    "github.com/google/gopacket/layers"
)

func init() {
  layers.LinkTypeMetadata[layers.LinkTypeEthernet] = layers.EnumMetadata{
    DecodeWith: gopacket.DecodeFunc(DecodeAristaExtendedEthernet),
    Name:       "AristaExtendedEthernet",
  }
}
</code></pre> <p>The custom fields are now accessible on the Ethernet layer, alongside the other fields.</p> <pre><code class="go">layer := packet.Layer(layers.LayerTypeEthernet)
if layer != nil {
  ethernetLayer := layer.(*decoder.AristaExtendedEthernet)
  if ethernetLayer.AristaEtherType.ProtocolSubType != 0 {
    timestamp, err := strconv.ParseFloat(fmt.Sprintf(
      "%d.%d",
      ethernetLayer.AristaEtherType.TimestampSeconds,
      ethernetLayer.AristaEtherType.TimestampNanoSeconds),
      64)
    }
  }
}
</code></pre> <p>A similar decoder has been successfully tested with 500k/s packets per second.</p> <h2>Summary</h2> <p>Using standard protocols and cheap hardware we can build powerful performance analysis applications.</p> <p>This work was inspired by <a href="https://github.com/REANNZ/ruru">Ruru</a>, providing the foundations for performance monitoring and insights of heavily asymmetric &amp; distributed traffic flows.</p> </div> </article> <article class=post> <h1 class=title><a href="/2017/12/a-look-at-traffic-encryption-options/">A look at traffic encryption options</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />26 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/a-look-at-traffic-encryption-options/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/network'>Network</a></li><li><a href='/tag/security'>Security</a></li></ul> </div> <div class=entry> <p>Given a post <a href="/2017/12/a-look-at-low-cost-tap-aggregation/">highlighting the cost effectiveness</a> of deploying network taps, it would make sense to look at the other side; encryption.</p> <h1>Intro</h1> <p>It is commonly accepted to use TLS when accessing services over the internet, whether they are based on HTTP, SMTP, IMAP, POP, FTP or any number of other protocols.</p> <p>It is also commonly accepted to terminate those TLS connections on the edge, handling all internal communications in plain text. This is for a number of reasons around scalability, performance and trust.</p> <p>As technology stacks have matured, a number of security standards have been created, including those for card handling (PCI DDS); many of these still contain phrasing such as '<a href="https://www.pcisecuritystandards.org/pdfs/pci_ssc_quick_guide.pdf">encrypt transmission of cardholder data across open, public networks</a>', with the definitions being open to interpretation.</p> <p>Pause for a moment and consider if these scenarios are 'across open, public networks':</p> <ul> <li>A point to point circuit provided over an external 'dark fibre' (DWDM or similar) network</li> <li>A point to point wireless link between 2 buildings provided by a 3rd party</li> <li>Cross connections between 2 suites within a datacenter, via the meet me room</li> </ul> <p>I imagine most people would argue these are private:</p> <ul> <li>All services are dedicated to you</li> <li>Traffic is isolated from other customers</li> <li>You control both ends of the connection</li> </ul> <p>However, there are also risks, as they all pass through physical assets you don't control:</p> <ul> <li>Traffic interception; it has been widely published that data from the likes of Google has been intercepted and used for profiling activities</li> <li>Network access; As with a physical intrusion to your rack/office, it may be possible to gain network access via a cross-connect, or inter-site link, depending on topology</li> <li>Redundancy; A targeted attack on physical infrastructure could place your business operations at risk</li> </ul> <p>Thankfully, most providers and many ISO standards have well defined physical access controls, which limit the possibilities of the above however that isn't very effective against a nation-state, or a cyber-based attack on a provider.</p> <p>Many businesses have a wealth of information useful to a nation-state, from habits and preferences to medical or travel data. It might be paranoia until they're out to get you.</p> <p>Ultimately this comes down to risk management and if you want to be 'compliant' or 'secure' in regards to your customer's data.</p> <p>Assuming we want to encrypt data end-to-end, let's look at the technologies available.</p> <h1>TLS</h1> <p>As briefly noted above, the standard for encryption in the public network space is <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a> (TLS).</p> <p>There are multiple implementations of TLS, with 1.2 currently being the standard (1.3 is in draft), the version and associated cryptographic ciphers are usually associated with the support requirements; many older browsers and SSL libraries don't support the most secure choices.</p> <p>A good starting point is the excellent <a href="https://cipherli.st/">cipherli.st</a> site, highlighting secure configs for most platforms.</p> <p>The results should then be checked, either using <code>openssl s_client</code>, <a href="https://www.ssllabs.com/">ssllabs.com</a> or similar.</p> <p>Generally, user-facing TLS is simple to deploy, with the potential for small compatibility issues (including breaking certain browsers).</p> <p>The direction for <a href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html">Google Chrome</a> and others is to start displaying HTTP sites in the same manner as invalid SSL is currently shown (red bars or similar), so it's highly advisable even if you don't transmit any 'sensitive info' (sensitive here includes tracking data, such as cookies).</p> <p>What about the cost? Platforms such as Lets Encrypt provide free SSL certs, trusted by all major browsers. For dedicated extended validation certificates, a few hundred dollars is a small cost for most online businesses.</p> <h2>TLS internally</h2> <p>Historically concerns about the performance of TLS have stunted the deployment internally, modern versions of the libraries combined with the current generations of CPUs mean TLS is not slow! (mostly).</p> <p>The excellent <a href="https://istlsfastyet.com/">istlsfastyet.com</a> goes into detail about the current state of TLS performance. The key takeaway is, when configured correctly, TLS at the scale of Facebook and Google performs fast enough with minimal CPU overhead.</p> <p>Using the most secure cipher suites (ECDHE) are a little more costly, but with mitigations in place (HTTP keepalives, session resumption etc), the performance overhead is negligible.</p> <p>Depending on your environment, you may purchase or use CA-signed certificates as is the case with external traffic however at a certain scale an internal certificate authority makes sense.</p> <p>There is a certain level of complexity in deploying and maintaining a secure internal certificate authority and many tools exist to help with this.</p> <p>Another advantage of an internal CA is being able to use certificate-based authentication for clients, enabling devices to prove their identity.</p> <h1>Alternatives</h1> <p>Depending on your environment, encrypting all inter-device traffic with TLS may be possible.</p> <p>Given a small load balanced LAMP stack this should be relatively easy:</p> <ul> <li>TLS from the user to the load balancer</li> <li>TLS from the load balancer to the web server</li> <li>TLS from PHP to MySQL</li> </ul> <p>However, the number of services can easily spiral, given the example above we could easily have:</p> <ul> <li>SMTP relays</li> <li>Memcache/Redis caching</li> <li>NFS based storage</li> <li>Monitoring agents</li> </ul> <p>You may also have services which don't support TLS:</p> <ul> <li>RADIUS</li> <li>Windows Distributed File Shares</li> <li>Access control / CCTV systems designed for closed networks</li> </ul> <p>There are 2 areas to consider here:</p> <ul> <li>Traffic passing over your network (Physical access restrictions in place)</li> <li>Traffic passing over external infrastructure</li> </ul> <p>For the first case:</p> <ul> <li>I strongly suggest to deploy TLS where possible, at worst, it is another layer of defence should a malicious device get into the network.</li> <li>For protocols lacking encryption support, their risk is likely low <ul> <li>If their risk is not low, I'd suggest re-evaluating the technology choice</li> <li>Inline encryption is possible but complicated to scale at this level</li> </ul> </li> </ul> <p>For the second, we have a number of options described below.</p> <h3>Layer 1 encryption</h3> <p>There are a number of 'black box' solutions, which sit in-line to the network.</p> <p>The general principle is un-encrypted data comes in one end, encrypted data comes out the other; the reverse then happens to give you un-encrypted data on the other end.</p> <div class=graphviz-wrapper> <svg role=img aria-label="layer 1 encryption" width=498pt height=99pt viewBox="0.00 0.00 498.00 99.00"> <title>layer 1 encryption</title> <desc>digraph &quot;layer 1 encryption&quot; { rankdir=LR; subgraph cluster_SiteA { label = &quot;Site A&quot;; color = black; &quot;Router A&quot;; } subgraph cluster_EncryptedNet { label = &quot;Encrypted Network&quot;; color = red; &quot;Device A&quot;; &quot;Device B&quot;; } subgraph cluster_SiteB { label = &quot;Site B&quot;; color = black; &quot;Router B&quot;; } &quot;Router A&quot; -&gt; &quot;Device A&quot; &quot;Device A&quot; -&gt; &quot;Device B&quot; &quot;Device B&quot; -&gt; &quot;Router B&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 95)"> <title>layer 1 encryption</title> <polygon fill=white stroke=none points="-4,4 -4,-95 494,-95 494,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_SiteA</title> <polygon fill=none stroke=black points="8,-8 8,-83 112,-83 112,-8 8,-8"/> <text text-anchor=middle x=60 y="-67.8" font-family="Times,serif" font-size="14.00">Site A</text> </g> <g id=clust2 class=cluster><title>cluster_EncryptedNet</title> <polygon fill=none stroke=red points="132,-8 132,-83 360,-83 360,-8 132,-8"/> <text text-anchor=middle x=246 y="-67.8" font-family="Times,serif" font-size="14.00">Encrypted Network</text> </g> <g id=clust3 class=cluster><title>cluster_SiteB</title> <polygon fill=none stroke=black points="380,-8 380,-83 482,-83 482,-8 380,-8"/> <text text-anchor=middle x=431 y="-67.8" font-family="Times,serif" font-size="14.00">Site B</text> </g> <g id=node1 class=node><title>Router A</title> <ellipse fill=none stroke=black cx=60 cy=-34 rx="43.5923" ry=18 /> <text text-anchor=middle x=60 y="-30.3" font-family="Times,serif" font-size="14.00">Router A</text> </g> <g id=node2 class=node><title>Device A</title> <ellipse fill=none stroke=black cx=184 cy=-34 rx="44.393" ry=18 /> <text text-anchor=middle x=184 y="-30.3" font-family="Times,serif" font-size="14.00">Device A</text> </g> <g id=edge1 class=edge><title>Router A&#45;&gt;Device A</title> <path fill=none stroke=black d="M103.67,-34C112.066,-34 120.972,-34 129.668,-34"/> <polygon fill=black stroke=black points="129.735,-37.5001 139.735,-34 129.735,-30.5001 129.735,-37.5001"/> </g> <g id=node3 class=node><title>Device B</title> <ellipse fill=none stroke=black cx=308 cy=-34 rx="44.393" ry=18 /> <text text-anchor=middle x=308 y="-30.3" font-family="Times,serif" font-size="14.00">Device B</text> </g> <g id=edge2 class=edge><title>Device A&#45;&gt;Device B</title> <path fill=none stroke=black d="M228.356,-34C236.536,-34 245.18,-34 253.625,-34"/> <polygon fill=black stroke=black points="253.784,-37.5001 263.783,-34 253.783,-30.5001 253.784,-37.5001"/> </g> <g id=node4 class=node><title>Router B</title> <ellipse fill=none stroke=black cx=431 cy=-34 rx="42.7926" ry=18 /> <text text-anchor=middle x=431 y="-30.3" font-family="Times,serif" font-size="14.00">Router B</text> </g> <g id=edge3 class=edge><title>Device B&#45;&gt;Router B</title> <path fill=none stroke=black d="M352.342,-34C360.538,-34 369.191,-34 377.63,-34"/> <polygon fill=black stroke=black points="377.772,-37.5001 387.772,-34 377.772,-30.5001 377.772,-37.5001"/> </g> </g> </svg> </div> <p>These are generally expensive appliances, licensed by port or bandwidth capability. They are also generally completely closed boxes, operating strictly at layer 1.</p> <p>Deployed across DWDM or similar networks, these devices should 'just work' and provide full encryption (layer 1 to 7). They are limited to 'point to point' links.</p> <p>A side effect of the point to point encryption is the prevention of unauthorised traffic.</p> <h3>IEEE 802.1AE (MacSec)</h3> <p>A more open and industry standard approach would be to deploy MacSec.</p> <p>MacSec provides encryption of the layer 2 header and up, but leaves the src/dest mac addresses exposed.</p> <p>It operates similar to an Ethernet frame within a layer 2 network, with the packets containing 4 fields</p> <div class=graphviz-wrapper> <svg role=img aria-label="macsec header" width=658pt height=154pt viewBox="0.00 0.00 658.00 154.00"> <title>macsec header</title> <desc>digraph &quot;macsec header&quot; { subgraph cluster { rankdir=LR; height=1.5; &quot;Destination MAC&quot; [shape=square, height=1.5]; &quot;Source MAC&quot; [shape=square, height=1.5]; &quot;Security TAG&quot; [shape=square, height=1.5]; &quot;Encrypted Data&quot; [shape=square, height=1.5]; &quot;ICV&quot; [shape=square, height=1.5]; } }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 150)"> <title>macsec header</title> <polygon fill=white stroke=none points="-4,4 -4,-150 654,-150 654,4 -4,4"/> <g id=clust1 class=cluster><title>cluster</title> <polygon fill=none stroke=black points="8,-8 8,-138 642,-138 642,-8 8,-8"/> </g> <g id=node1 class=node><title>Destination MAC</title> <polygon fill=none stroke=black points="634,-130 520,-130 520,-16 634,-16 634,-130"/> <text text-anchor=middle x=577 y="-69.3" font-family="Times,serif" font-size="14.00">Destination MAC</text> </g> <g id=node2 class=node><title>Source MAC</title> <polygon fill=none stroke=black points="502,-127 394,-127 394,-19 502,-19 502,-127"/> <text text-anchor=middle x=448 y="-69.3" font-family="Times,serif" font-size="14.00">Source MAC</text> </g> <g id=node3 class=node><title>Security TAG</title> <polygon fill=none stroke=black points="376,-127 268,-127 268,-19 376,-19 376,-127"/> <text text-anchor=middle x=322 y="-69.3" font-family="Times,serif" font-size="14.00">Security TAG</text> </g> <g id=node4 class=node><title>Encrypted Data</title> <polygon fill=none stroke=black points="250,-127 142,-127 142,-19 250,-19 250,-127"/> <text text-anchor=middle x=196 y="-69.3" font-family="Times,serif" font-size="14.00">Encrypted Data</text> </g> <g id=node5 class=node><title>ICV</title> <polygon fill=none stroke=black points="124,-127 16,-127 16,-19 124,-19 124,-127"/> <text text-anchor=middle x=70 y="-69.3" font-family="Times,serif" font-size="14.00">ICV</text> </g> </g> </svg> </div> <p>Any layer 2 data outside of the mac addresses (VLAN tag, LLDP etc) is contained within the encrypted data.</p> <p>The security tag and ICV are used internally for MacSec, with the mac addresses being used for forwarding.</p> <p>There is a hardware dependency associated with MacSec, as the encryption is done in hardware to achieve line rate speeds. This varies between vendors but can be in the form of dedicated line cards or whole products.</p> <p>It is possible to offload the encryption to MacSec capable switches, allowing routers and line cards to remain, with the switch sitting inline.</p> <div class=graphviz-wrapper> <svg role=img aria-label="macsec encryption" width=498pt height=99pt viewBox="0.00 0.00 498.00 99.00"> <title>macsec encryption</title> <desc>digraph &quot;macsec encryption&quot; { rankdir=LR; subgraph cluster_SiteA { label = &quot;Site A&quot;; color = black; &quot;Router A&quot;; } subgraph cluster_EncryptedNet { label = &quot;Encrypted Network&quot;; color = red; &quot;Switch A&quot;; &quot;Switch B&quot;; } subgraph cluster_SiteB { label = &quot;Site B&quot;; color = black; &quot;Router B&quot;; } &quot;Router A&quot; -&gt; &quot;Switch A&quot; &quot;Switch A&quot; -&gt; &quot;Switch B&quot; &quot;Switch B&quot; -&gt; &quot;Router B&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 95)"> <title>macsec encryption</title> <polygon fill=white stroke=none points="-4,4 -4,-95 494,-95 494,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_SiteA</title> <polygon fill=none stroke=black points="8,-8 8,-83 112,-83 112,-8 8,-8"/> <text text-anchor=middle x=60 y="-67.8" font-family="Times,serif" font-size="14.00">Site A</text> </g> <g id=clust2 class=cluster><title>cluster_EncryptedNet</title> <polygon fill=none stroke=red points="132,-8 132,-83 360,-83 360,-8 132,-8"/> <text text-anchor=middle x=246 y="-67.8" font-family="Times,serif" font-size="14.00">Encrypted Network</text> </g> <g id=clust3 class=cluster><title>cluster_SiteB</title> <polygon fill=none stroke=black points="380,-8 380,-83 482,-83 482,-8 380,-8"/> <text text-anchor=middle x=431 y="-67.8" font-family="Times,serif" font-size="14.00">Site B</text> </g> <g id=node1 class=node><title>Router A</title> <ellipse fill=none stroke=black cx=60 cy=-34 rx="43.5923" ry=18 /> <text text-anchor=middle x=60 y="-30.3" font-family="Times,serif" font-size="14.00">Router A</text> </g> <g id=node2 class=node><title>Switch A</title> <ellipse fill=none stroke=black cx=184 cy=-34 rx="44.393" ry=18 /> <text text-anchor=middle x=184 y="-30.3" font-family="Times,serif" font-size="14.00">Switch A</text> </g> <g id=edge1 class=edge><title>Router A&#45;&gt;Switch A</title> <path fill=none stroke=black d="M103.67,-34C112.066,-34 120.972,-34 129.668,-34"/> <polygon fill=black stroke=black points="129.735,-37.5001 139.735,-34 129.735,-30.5001 129.735,-37.5001"/> </g> <g id=node3 class=node><title>Switch B</title> <ellipse fill=none stroke=black cx=308 cy=-34 rx="43.5923" ry=18 /> <text text-anchor=middle x=308 y="-30.3" font-family="Times,serif" font-size="14.00">Switch B</text> </g> <g id=edge2 class=edge><title>Switch A&#45;&gt;Switch B</title> <path fill=none stroke=black d="M228.356,-34C236.634,-34 245.385,-34 253.926,-34"/> <polygon fill=black stroke=black points="254.194,-37.5001 264.194,-34 254.194,-30.5001 254.194,-37.5001"/> </g> <g id=node4 class=node><title>Router B</title> <ellipse fill=none stroke=black cx=431 cy=-34 rx="42.7926" ry=18 /> <text text-anchor=middle x=431 y="-30.3" font-family="Times,serif" font-size="14.00">Router B</text> </g> <g id=edge3 class=edge><title>Switch B&#45;&gt;Router B</title> <path fill=none stroke=black d="M351.66,-34C360.072,-34 368.988,-34 377.676,-34"/> <polygon fill=black stroke=black points="377.725,-37.5001 387.725,-34 377.725,-30.5001 377.725,-37.5001"/> </g> </g> </svg> </div> <p>It may not be desirable to put a layer 2 device in your path, though it is likely that the path will already be using BFD or similar to account for any provider interruptions, which don't result in an interface flap.</p> <p>There are also some implementation considerations:</p> <ul> <li>Additional header size needs to be accounted for in downstream MTUs</li> <li>Certain providers filter layer 2 traffic, they may filter the MacSec control messages!</li> </ul> <p>As with Layer 1 encryption, this prevents unauthorised traffic entering the network, as well as protecting against interception.</p> <h3>DMVPN / Mesh VPN</h3> <p>It may be desirable in some cases to form a software-based VPN mesh over your existing network, providing encryption between 2 or more points.</p> <p>This could be in the form of a single IPsec tunnel, or a complex hub-spoke DMVPN network. These could be deployed on dedicated devices or end-user devices.</p> <p>For high traffic applications, these approaches are likely not applicable, due to line rate speeds being desirable, but in branch or remote worker applications they can be powerful options in your toolbox.</p> <div class=graphviz-wrapper> <svg role=img aria-label="vpn mesh encryption" width=714pt height=211pt viewBox="0.00 0.00 714.00 211.17"> <title>vpn mesh encryption</title> <desc>digraph &quot;vpn mesh encryption&quot; { rankdir=LR; &quot;Device A&quot; -&gt; &quot;Device B&quot; &quot;Device A&quot; -&gt; &quot;Device C&quot; &quot;Device A&quot; -&gt; &quot;Device D&quot; &quot;Device A&quot; -&gt; &quot;Device E&quot; &quot;Device A&quot; -&gt; &quot;Device F&quot; &quot;Device B&quot; -&gt; &quot;Device C&quot; &quot;Device B&quot; -&gt; &quot;Device D&quot; &quot;Device B&quot; -&gt; &quot;Device E&quot; &quot;Device B&quot; -&gt; &quot;Device F&quot; &quot;Device C&quot; -&gt; &quot;Device D&quot; &quot;Device C&quot; -&gt; &quot;Device E&quot; &quot;Device C&quot; -&gt; &quot;Device F&quot; &quot;Device D&quot; -&gt; &quot;Device E&quot; &quot;Device D&quot; -&gt; &quot;Device F&quot; &quot;Device E&quot; -&gt; &quot;Device F&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 207.174)"> <title>vpn mesh encryption</title> <polygon fill=white stroke=none points="-4,4 -4,-207.174 710,-207.174 710,4 -4,4"/> <g id=node1 class=node><title>Device A</title> <ellipse fill=none stroke=black cx=44 cy="-88.1737" rx="44.393" ry=18 /> <text text-anchor=middle x=44 y="-84.4737" font-family="Times,serif" font-size="14.00">Device A</text> </g> <g id=node2 class=node><title>Device B</title> <ellipse fill=none stroke=black cx=168 cy="-88.1737" rx="44.393" ry=18 /> <text text-anchor=middle x=168 y="-84.4737" font-family="Times,serif" font-size="14.00">Device B</text> </g> <g id=edge1 class=edge><title>Device A&#45;&gt;Device B</title> <path fill=none stroke=black d="M88.3561,-88.1737C96.5363,-88.1737 105.18,-88.1737 113.625,-88.1737"/> <polygon fill=black stroke=black points="113.784,-91.6738 123.783,-88.1737 113.783,-84.6738 113.784,-91.6738"/> </g> <g id=node3 class=node><title>Device C</title> <ellipse fill=none stroke=black cx=292 cy="-157.174" rx="44.393" ry=18 /> <text text-anchor=middle x=292 y="-153.474" font-family="Times,serif" font-size="14.00">Device C</text> </g> <g id=edge2 class=edge><title>Device A&#45;&gt;Device C</title> <path fill=none stroke=black d="M77.4756,-99.9513C91.6723,-104.923 108.573,-110.606 124,-115.174 163.747,-126.942 209.429,-138.283 242.957,-146.208"/> <polygon fill=black stroke=black points="242.416,-149.676 252.951,-148.554 244.016,-142.861 242.416,-149.676"/> </g> <g id=node4 class=node><title>Device D</title> <ellipse fill=none stroke=black cx=416 cy="-39.1737" rx="44.393" ry=18 /> <text text-anchor=middle x=416 y="-35.4737" font-family="Times,serif" font-size="14.00">Device D</text> </g> <g id=edge3 class=edge><title>Device A&#45;&gt;Device D</title> <path fill=none stroke=black d="M76.0346,-75.6306C90.4019,-70.3294 107.836,-64.6004 124,-61.1737 205.59,-43.8771 302.575,-39.7282 361.42,-38.9703"/> <polygon fill=black stroke=black points="361.631,-42.4684 371.596,-38.8683 361.561,-35.4688 361.631,-42.4684"/> </g> <g id=node5 class=node><title>Device E</title> <ellipse fill=none stroke=black cx=540 cy="-39.1737" rx="43.5923" ry=18 /> <text text-anchor=middle x=540 y="-35.4737" font-family="Times,serif" font-size="14.00">Device E</text> </g> <g id=edge4 class=edge><title>Device A&#45;&gt;Device E</title> <path fill=none stroke=black d="M67.6086,-72.8964C82.9405,-63.1501 103.986,-50.935 124,-43.1737 228.029,-2.83287 260.532,-9.10811 372,-4.17367 411.073,-2.444 421.736,3.92298 460,-4.17367 475.116,-7.3723 490.857,-13.6629 504.273,-20.0395"/> <polygon fill=black stroke=black points="503.075,-23.3516 513.589,-24.6549 506.182,-17.0792 503.075,-23.3516"/> </g> <g id=node6 class=node><title>Device F</title> <ellipse fill=none stroke=black cx=663 cy="-123.174" rx="42.7926" ry=18 /> <text text-anchor=middle x=663 y="-119.474" font-family="Times,serif" font-size="14.00">Device F</text> </g> <g id=edge5 class=edge><title>Device A&#45;&gt;Device F</title> <path fill=none stroke=black d="M64.2811,-104.406C103.97,-136.106 198.832,-203.174 291,-203.174 291,-203.174 291,-203.174 417,-203.174 495.28,-203.174 580.988,-165.812 627.414,-142.154"/> <polygon fill=black stroke=black points="629.169,-145.187 636.435,-137.476 625.946,-138.973 629.169,-145.187"/> </g> <g id=edge6 class=edge><title>Device B&#45;&gt;Device C</title> <path fill=none stroke=black d="M194.575,-102.638C212.55,-112.805 236.806,-126.523 256.492,-137.657"/> <polygon fill=black stroke=black points="255.031,-140.852 265.458,-142.728 258.477,-134.759 255.031,-140.852"/> </g> <g id=edge7 class=edge><title>Device B&#45;&gt;Device D</title> <path fill=none stroke=black d="M207.979,-80.4095C250.767,-71.8867 319.54,-58.1881 365.959,-48.9421"/> <polygon fill=black stroke=black points="366.673,-52.3687 375.796,-46.9825 365.305,-45.5035 366.673,-52.3687"/> </g> <g id=edge8 class=edge><title>Device B&#45;&gt;Device E</title> <path fill=none stroke=black d="M195.603,-74.0704C233.489,-54.9633 305.754,-22.0965 372,-12.1737 410.68,-6.37993 421.418,-5.76258 460,-12.1737 473.2,-14.3671 487.154,-18.4899 499.601,-22.8652"/> <polygon fill=black stroke=black points="498.623,-26.2347 509.216,-26.3963 501.036,-19.6637 498.623,-26.2347"/> </g> <g id=edge9 class=edge><title>Device B&#45;&gt;Device F</title> <path fill=none stroke=black d="M211.888,-91.2185C302.413,-97.6452 512.684,-112.573 610.386,-119.509"/> <polygon fill=black stroke=black points="610.383,-123.018 620.606,-120.235 610.879,-116.036 610.383,-123.018"/> </g> <g id=edge10 class=edge><title>Device C&#45;&gt;Device D</title> <path fill=none stroke=black d="M306.986,-140.133C322.141,-122.118 347.458,-93.3043 372,-71.1737 375.874,-67.68 380.114,-64.1818 384.373,-60.8486"/> <polygon fill=black stroke=black points="386.645,-63.5188 392.497,-54.6869 382.414,-57.9416 386.645,-63.5188"/> </g> <g id=edge11 class=edge><title>Device C&#45;&gt;Device E</title> <path fill=none stroke=black d="M321.219,-143.638C365.68,-122.311 452.064,-80.8746 501.629,-57.0998"/> <polygon fill=black stroke=black points="503.229,-60.2139 510.732,-52.7332 500.202,-53.9024 503.229,-60.2139"/> </g> <g id=edge12 class=edge><title>Device C&#45;&gt;Device F</title> <path fill=none stroke=black d="M336.527,-155.663C393.545,-153.345 496.553,-147.994 584,-137.174 593.728,-135.97 604.084,-134.352 613.963,-132.643"/> <polygon fill=black stroke=black points="614.812,-136.047 624.04,-130.843 613.581,-129.156 614.812,-136.047"/> </g> <g id=edge13 class=edge><title>Device D&#45;&gt;Device E</title> <path fill=none stroke=black d="M460.356,-39.1737C468.634,-39.1737 477.385,-39.1737 485.926,-39.1737"/> <polygon fill=black stroke=black points="486.194,-42.6738 496.194,-39.1737 486.194,-35.6738 486.194,-42.6738"/> </g> <g id=edge14 class=edge><title>Device D&#45;&gt;Device F</title> <path fill=none stroke=black d="M450.297,-50.5897C494.239,-65.6557 571.629,-92.1892 619.675,-108.662"/> <polygon fill=black stroke=black points="618.573,-111.984 629.167,-111.917 620.843,-105.363 618.573,-111.984"/> </g> <g id=edge15 class=edge><title>Device E&#45;&gt;Device F</title> <path fill=none stroke=black d="M563.193,-54.5806C582.382,-67.9015 610.304,-87.2855 631.575,-102.052"/> <polygon fill=black stroke=black points="629.737,-105.037 639.947,-107.864 633.729,-99.2866 629.737,-105.037"/> </g> </g> </svg> </div> <h1>Summary</h1> <p>There is not a 1 solution fits all. It is very dependent upon your environment and more specifically the applications within it.</p> <p>My advice is to look at the risk in each area, design an appropriate solution and test it.</p> <p>A targeted approach keeps things simple to start, but personally, I look to provide end-to-end encryption everywhere... trusting no one.</p> <p>If you have no clear areas of risk, start with everywhere you touch the outside world, either via a public interface or provider managed services.</p> </div> </article> <article class=post> <h1 class=title><a href="/2017/12/a-look-at-low-cost-tap-aggregation/">A look at low-cost tap aggregation</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />25 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/a-look-at-low-cost-tap-aggregation/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/python'>Python</a></li></ul> </div> <div class=entry> <p>A while ago, I had a project that required capturing traffic from a number of sources, thus an adventure into possible solutions was born.</p> <h2>Why do we want to capture traffic?</h2> <p>There are numerous reasons to capture traffic including:</p> <ul> <li>Network troubleshooting</li> <li>Traffic monitoring (including intrusion detection)</li> <li>Legal requests/requirements</li> </ul> <p>Ultimately it's about getting visibility, either for security or operations.</p> <p>Our goal is given any path, to be able to replicate the traffic, with minimal impact.</p> <h2>How can we capture traffic?</h2> <p>There are generally 3 different methods for capturing traffic, each with their own complexities.</p> <h3>From a target device</h3> <p>At a basic level, a device can capture traffic in 2 ways:</p> <ul> <li>'CPU bound'; traffic that has been brought up the network stack and is 'destined' for this device</li> <li>Raw sockets; 'raw' network traffic that the device receives on a network interface.</li> </ul> <p>CPU bound traffic can be efficient to capture if filtered appropriately. When dealing with high traffic volumes processing traffic can take critical resources away from your business applications.</p> <p>Raw sockets are generally very limited, hub-based topologies are not widely used, limiting any traffic to broadcast for the servers subnet, or targeted (CPU bound) traffic (multicast/unicast).</p> <p>Generally, to be usable by an analyser the traffic would need to be encapsulated and transmitted, using further resources on the device.</p> <h3>Span a switch</h3> <p>This is similar to inline, but I've separated it here due to implementation differences.</p> <p>SPAN's generally come in 3 forms:</p> <ul> <li>SPAN - take traffic from port A, mirror to port B, on the same device</li> <li>RSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 2)</li> <li>ERSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 3)</li> </ul> <p>There are a number of downsides:</p> <ul> <li>Vendors have varying levels of support; <ul> <li>RSPAN on a Juniper EX series switch doesn't work over an AE</li> <li>Tricks can be used, for example, spanning into a GRE tunnel to accomplish ERSPAN, this becomes hardware dependent though</li> </ul> </li> <li>CPU generated (ICMP/ARP/LLDP/BPDU etc) packets generally do not get mirrored</li> <li>Invalid packets will not be seen (those dropped due to checksum errors for example)</li> <li>CPU usage can increase drastically due to extra processing requirements</li> <li>As we're spanning in an L2 domain arp table churn can happen if you're not careful</li> </ul> <p>However, if you need insight into a switched domain and don't want to inline-tap every cable, it might work for you.</p> <h3>Inline</h3> <p>Inline-taps come in many different flavours, supporting different media types. At a basic level, there are 2 main differences.</p> <h4>Passive tap</h4> <ul> <li>Require no power, pass the original signal onto the output</li> <li>Reduce the output power by a known ratio (important when dealing with fibre)</li> <li>No monitoring data or other insights possible</li> <li>Very failure resistant</li> </ul> <h5>Logical operation</h5> <div class=graphviz-wrapper> <svg role=img aria-label="passive tap" width=474pt height=206pt viewBox="0.00 0.00 474.00 205.89"> <title>passive tap</title> <desc>digraph &quot;passive tap&quot; { subgraph cluster_Input { label = &quot;Input Port&quot;; color = black; &quot;Input TX&quot;; &quot;Input RX&quot;; } subgraph cluster_Output { label = &quot;Output Port&quot;; color = black; &quot;Output TX&quot;; &quot;Output RX&quot;; } subgraph cluster_Monitor { label = &quot;Monitor Port&quot;; color = black; &quot;Monitor TX2&quot;; &quot;Monitor TX1&quot;; } &quot;Input TX&quot; -&gt; &quot;Output RX&quot; &quot;Input TX&quot; -&gt; &quot;Monitor TX1&quot; &quot;Output TX&quot; -&gt; &quot;Input RX&quot; &quot;Output TX&quot; -&gt; &quot;Monitor TX2&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 201.889)"> <title>passive tap</title> <polygon fill=white stroke=none points="-4,4 -4,-201.889 470,-201.889 470,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_Input</title> <polygon fill=none stroke=black points="8,-91 8,-166 218,-166 218,-91 8,-91"/> <text text-anchor=middle x=113 y="-150.8" font-family="Times,serif" font-size="14.00">Input Port</text> </g> <g id=clust2 class=cluster><title>cluster_Output</title> <polygon fill=none stroke=black points="226,-91 226,-166 458,-166 458,-91 226,-91"/> <text text-anchor=middle x=342 y="-150.8" font-family="Times,serif" font-size="14.00">Output Port</text> </g> <g id=clust3 class=cluster><title>cluster_Monitor</title> <polygon fill=none stroke=black points="145,-8 145,-83 412,-83 412,-8 145,-8"/> <text text-anchor=middle x="278.5" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text> </g> <g id=node1 class=node><title>Input TX</title> <ellipse fill=none stroke=black cx=166 cy=-117 rx="43.319" ry=18 /> <text text-anchor=middle x=166 y="-113.3" font-family="Times,serif" font-size="14.00">Input TX</text> </g> <g id=node4 class=node><title>Output RX</title> <ellipse fill=none stroke=black cx=284 cy=-117 rx="50.0684" ry=18 /> <text text-anchor=middle x=284 y="-113.3" font-family="Times,serif" font-size="14.00">Output RX</text> </g> <g id=edge1 class=edge><title>Input TX&#45;&gt;Output RX</title> <path fill=none stroke=black d="M209.328,-117C214.05,-117 218.771,-117 223.493,-117"/> <polygon fill=black stroke=black points="223.83,-120.5 233.83,-117 223.83,-113.5 223.83,-120.5"/> </g> <g id=node6 class=node><title>Monitor TX1</title> <ellipse fill=none stroke=black cx=211 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=211 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text> </g> <g id=edge2 class=edge><title>Input TX&#45;&gt;Monitor TX1</title> <path fill=none stroke=black d="M175.324,-99.2167C181.437,-88.2128 189.554,-73.6021 196.501,-61.0976"/> <polygon fill=black stroke=black points="199.736,-62.4818 201.533,-52.0404 193.617,-59.0822 199.736,-62.4818"/> </g> <g id=node2 class=node><title>Input RX</title> <ellipse fill=none stroke=black cx=60 cy=-117 rx="44.2946" ry=18 /> <text text-anchor=middle x=60 y="-113.3" font-family="Times,serif" font-size="14.00">Input RX</text> </g> <g id=node3 class=node><title>Output TX</title> <ellipse fill=none stroke=black cx=401 cy=-117 rx="49.0941" ry=18 /> <text text-anchor=middle x=401 y="-113.3" font-family="Times,serif" font-size="14.00">Output TX</text> </g> <g id=edge3 class=edge><title>Output TX&#45;&gt;Input RX</title> <path fill=none stroke=black d="M389.619,-134.566C377.906,-150.863 358.013,-174.054 334,-184 290.475,-202.029 165.168,-202.868 122,-184 102.82,-175.617 86.9279,-158.049 76.0362,-143.006"/> <polygon fill=black stroke=black points="78.7606,-140.791 70.2141,-134.529 72.9905,-144.754 78.7606,-140.791"/> </g> <g id=node5 class=node><title>Monitor TX2</title> <ellipse fill=none stroke=black cx=346 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=346 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text> </g> <g id=edge4 class=edge><title>Output TX&#45;&gt;Monitor TX2</title> <path fill=none stroke=black d="M389.604,-99.2167C381.934,-87.9217 371.685,-72.8267 363.05,-60.1099"/> <polygon fill=black stroke=black points="365.895,-58.0687 357.381,-51.7618 360.103,-62.001 365.895,-58.0687"/> </g> </g> </svg> </div> <p>There are different technologies for mirroring the payload when using copper, these are generally resistor based, for fibre they're either thin film or fused biconical taper based.</p> <p><em>Note: Thin film is generally preferred for 40G+ links, due to their lower loss rate caused by more even light distribution.</em></p> <p>The concept for all of them is the same:</p> <ul> <li>Given an input of 100%</li> <li>Bleed off x% of the signal to the mirror port</li> <li>Pass the remaining 100-x% through to the output port</li> </ul> <p>A key consideration when using fibre is the 'split ratio' aka how much light to bleed off, both the monitor and the output interfaces need enough light for the optics on the other end.</p> <h4>Active tap</h4> <ul> <li>They require power and re-generate the output signals.</li> <li>Monitoring data can be provided (light levels etc)</li> <li>When using fibre there are no split ratio considerations</li> </ul> <h5>Logical operation</h5> <div class=graphviz-wrapper> <svg role=img aria-label="active tap" width=474pt height=254pt viewBox="0.00 0.00 474.00 254.00"> <title>active tap</title> <desc>digraph &quot;active tap&quot; { subgraph cluster_Input { label = &quot;Input Port&quot;; color = black; &quot;Input TX&quot;; &quot;Input RX&quot;; } subgraph cluster_Output { label = &quot;Output Port&quot;; color = black; &quot;Output TX&quot;; &quot;Output RX&quot;; } subgraph cluster_Monitor { label = &quot;Monitor Port&quot;; color = black; &quot;Monitor TX2&quot;; &quot;Monitor TX1&quot;; } subgraph cluster_Processor { color = black; shape = square; &quot;Processor&quot;; } &quot;Processor&quot; -&gt; &quot;Input TX&quot; &quot;Input RX&quot; -&gt; &quot;Processor&quot; &quot;Processor&quot; -&gt; &quot;Output TX&quot; &quot;Output RX&quot; -&gt; &quot;Processor&quot; &quot;Processor&quot; -&gt; &quot;Monitor TX1&quot; &quot;Processor&quot; -&gt; &quot;Monitor TX2&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 250)"> <title>active tap</title> <polygon fill=white stroke=none points="-4,4 -4,-250 470,-250 470,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_Input</title> <polygon fill=none stroke=black points="8,-163 8,-238 218,-238 218,-163 8,-163"/> <text text-anchor=middle x=113 y="-222.8" font-family="Times,serif" font-size="14.00">Input Port</text> </g> <g id=clust2 class=cluster><title>cluster_Output</title> <polygon fill=none stroke=black points="226,-163 226,-238 458,-238 458,-163 226,-163"/> <text text-anchor=middle x=342 y="-222.8" font-family="Times,serif" font-size="14.00">Output Port</text> </g> <g id=clust3 class=cluster><title>cluster_Monitor</title> <polygon fill=none stroke=black points="113,-8 113,-83 380,-83 380,-8 113,-8"/> <text text-anchor=middle x="246.5" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text> </g> <g id=clust4 class=cluster><title>cluster_Processor</title> <polygon fill=none stroke=black points="172,-91 172,-143 278,-143 278,-91 172,-91"/> </g> <g id=node1 class=node><title>Input TX</title> <ellipse fill=none stroke=black cx=166 cy=-189 rx="43.319" ry=18 /> <text text-anchor=middle x=166 y="-185.3" font-family="Times,serif" font-size="14.00">Input TX</text> </g> <g id=node2 class=node><title>Input RX</title> <ellipse fill=none stroke=black cx=60 cy=-189 rx="44.2946" ry=18 /> <text text-anchor=middle x=60 y="-185.3" font-family="Times,serif" font-size="14.00">Input RX</text> </g> <g id=node7 class=node><title>Processor</title> <ellipse fill=none stroke=black cx=225 cy=-117 rx="44.271" ry=18 /> <text text-anchor=middle x=225 y="-113.3" font-family="Times,serif" font-size="14.00">Processor</text> </g> <g id=edge2 class=edge><title>Input RX&#45;&gt;Processor</title> <path fill=none stroke=black d="M87.3679,-174.716C95.5656,-170.838 104.608,-166.662 113,-163 136.485,-152.754 163.086,-142.029 184.469,-133.621"/> <polygon fill=black stroke=black points="185.861,-136.835 193.897,-129.931 183.309,-130.317 185.861,-136.835"/> </g> <g id=node3 class=node><title>Output TX</title> <ellipse fill=none stroke=black cx=401 cy=-189 rx="49.0941" ry=18 /> <text text-anchor=middle x=401 y="-185.3" font-family="Times,serif" font-size="14.00">Output TX</text> </g> <g id=node4 class=node><title>Output RX</title> <ellipse fill=none stroke=black cx=284 cy=-189 rx="50.0684" ry=18 /> <text text-anchor=middle x=284 y="-185.3" font-family="Times,serif" font-size="14.00">Output RX</text> </g> <g id=edge4 class=edge><title>Output RX&#45;&gt;Processor</title> <path fill=none stroke=black d="M270.018,-171.411C262.67,-162.693 253.527,-151.845 245.404,-142.208"/> <polygon fill=black stroke=black points="248.003,-139.861 238.882,-134.47 242.65,-144.372 248.003,-139.861"/> </g> <g id=node5 class=node><title>Monitor TX2</title> <ellipse fill=none stroke=black cx=314 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=314 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text> </g> <g id=node6 class=node><title>Monitor TX1</title> <ellipse fill=none stroke=black cx=179 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=179 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text> </g> <g id=edge1 class=edge><title>Processor&#45;&gt;Input TX</title> <path fill=none stroke=black d="M211.39,-134.147C203.956,-142.967 194.604,-154.064 186.323,-163.889"/> <polygon fill=black stroke=black points="183.453,-161.863 179.684,-171.765 188.805,-166.374 183.453,-161.863"/> </g> <g id=edge3 class=edge><title>Processor&#45;&gt;Output TX</title> <path fill=none stroke=black d="M256.696,-129.669C280.535,-138.547 313.95,-151.206 343,-163 348.934,-165.409 355.179,-168.02 361.285,-170.616"/> <polygon fill=black stroke=black points="360.13,-173.928 370.7,-174.65 362.887,-167.494 360.13,-173.928"/> </g> <g id=edge6 class=edge><title>Processor&#45;&gt;Monitor TX2</title> <path fill=none stroke=black d="M242.16,-100.382C255.323,-88.4031 273.695,-71.6819 288.565,-58.1483"/> <polygon fill=black stroke=black points="290.936,-60.7231 295.976,-51.4038 286.225,-55.5462 290.936,-60.7231"/> </g> <g id=edge5 class=edge><title>Processor&#45;&gt;Monitor TX1</title> <path fill=none stroke=black d="M215.469,-99.2167C209.116,-88.0303 200.646,-73.1166 193.469,-60.4773"/> <polygon fill=black stroke=black points="196.501,-58.729 188.519,-51.7618 190.414,-62.1858 196.501,-58.729"/> </g> </g> </svg> </div> <p>The internal complexity varies, but the principle is:</p> <ul> <li>Given an input of X</li> <li>Generate the payload of X into Y and Z</li> <li>Transmit Y to the monitor interface</li> <li>Transmit Z to the output interface</li> </ul> <p>It is possible to buy active taps, with the capability to 'fail open' meaning in the event of a power failure traffic will continue to flow.</p> <p>I still prefer to use passive taps, which should be as resilient as a fibre patch panel.</p> <h2>Why do we want to aggregate it?</h2> <p>In the most simplistic deployment, we can simply send from the source to the destination:</p> <div class=graphviz-wrapper> <svg role=img aria-label="one to one tap" width=184pt height=44pt viewBox="0.00 0.00 184.00 44.00"> <title>one to one tap</title> <desc>digraph &quot;one to one tap&quot; { rankdir=LR; &quot;TAP&quot; -&gt; &quot;Analyser&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 40)"> <title>one to one tap</title> <polygon fill=white stroke=none points="-4,4 -4,-40 180,-40 180,4 -4,4"/> <g id=node1 class=node><title>TAP</title> <ellipse fill=none stroke=black cx=28 cy=-18 rx="27.0966" ry=18 /> <text text-anchor=middle x=28 y="-14.3" font-family="Times,serif" font-size="14.00">TAP</text> </g> <g id=node2 class=node><title>Analyser</title> <ellipse fill=none stroke=black cx=134 cy=-18 rx="42.4939" ry=18 /> <text text-anchor=middle x=134 y="-14.3" font-family="Times,serif" font-size="14.00">Analyser</text> </g> <g id=edge1 class=edge><title>TAP&#45;&gt;Analyser</title> <path fill=none stroke=black d="M55.5127,-18C63.4707,-18 72.4867,-18 81.4834,-18"/> <polygon fill=black stroke=black points="81.5755,-21.5001 91.5754,-18 81.5754,-14.5001 81.5755,-21.5001"/> </g> </g> </svg> </div> <p>However, there are a number of reasons to have an aggregation step in the middle:</p> <ul> <li>Number of ingress points <ul> <li>Aggregation of smaller capture points into larger interfaces</li> <li>Reduction in rack space required for analysers, servers etc</li> <li>Strategic aggregation to reduce physical requirements (fibre, rack space)</li> </ul> </li> <li>Multiple destinations <ul> <li>Apply filtering logic to save on analyser licensing</li> <li>Send traffic to security appliances and network monitoring devices</li> </ul> </li> <li>Apply software logic to capture rules</li> <li>Support multiple media types <ul> <li>Provide longer reach for copper-based taps</li> <li>SMF, MMF, XFP, QSFP, Copper support</li> </ul> </li> <li>Single view of traffic <ul> <li>Certain DPI/IDS appliances require full flows, difficult in ECMP networks</li> <li>I don't recommend this due to the associated scaling issues</li> </ul> </li> </ul> <p>Downsides to having an aggregation step:</p> <ul> <li>Potential congestion issues (we're taking raw traffic, limited by the sender)</li> <li>Single point of failure <ul> <li>This could be mitigated using layer 1 fibre switches or similar</li> <li>It's for monitoring traffic, so uptime is likely not as critical</li> </ul> </li> <li>Cost</li> </ul> <p>Historically TAP aggregation has been a very expensive game, around 2-4k a port!</p> <p>Thankfully Arista changed that with their 7150 series switch, which supports a tap mode as well as a 'DANZ' software suite for loss/latency monitoring, packet filtering and mirroring.</p> <p>The DANZ suite is now available on the 7150, 7280E and 7500E series switches from Arista, opening up options from 1/2U fixed form to 7/11U chassi based deployments.</p> <p>The 7150 series gives some nice features:</p> <ul> <li>Port density; up to 64 10G ports</li> <li>LANZ+ features for micro-burst analysis</li> <li>PTP support for packet time stamping</li> <li>~350ns latency for all packets</li> <li>Multi-port mirroring</li> <li>Hitless (ISSU) upgrades</li> <li>A 'normal' Linux environment and Python based toolset</li> <li>You configure it like any other switch!</li> </ul> <h2>Let's implement a solution!</h2> <p>We'll keep it simple with 1 aggregation point, 6 inputs and 2 outputs. In reality, this could be multiple levels of aggregation.</p> <p>Inputs:</p> <ul> <li>2 x Passive taps</li> <li>2 x SPANs</li> <li>2 x Active taps</li> </ul> <p>Logical Groups:</p> <ul> <li>Group 1 - Internet</li> <li>Group 2 - Corporate</li> <li>Group 3 - Regional</li> </ul> <p>Outputs:</p> <ul> <li>Bro Network Security Monitor (Internet + Regional only)</li> <li>Server (Corporate only)</li> </ul> <h3>Logical Diagram</h3> <div class=graphviz-wrapper> <svg role=img aria-label="active tap" width=1020pt height=243pt viewBox="0.00 0.00 1020.00 243.00"> <title>active tap</title> <desc>digraph &quot;active tap&quot; { subgraph cluster_PassiveTap { label = &quot;Passive Optical Tap&quot;; color = black; &quot;Transit Provider 1&quot;; &quot;Transit Provider 2&quot;; } subgraph cluster_Corporate1 { label = &quot;Corporate DMZ&quot;; color = black; &quot;Corporate Spine 1&quot;; } subgraph cluster_Corporate2 { label = &quot;Corporate DMZ&quot;; color = black; &quot;Corporate Spine 2&quot;; } subgraph cluster_Regional { label = &quot;Active TAP&quot;; color = black; &quot;Wan Provider 1&quot;; &quot;Wan Provider 2&quot;; } subgraph cluster_7150 { color = black; shape = square; &quot;Tap Switch&quot;; } subgraph cluster_Bro { color = black; shape = square; &quot;Bro Network Security Monitor&quot;; } subgraph cluster_Server { color = black; shape = square; &quot;Secret Server&quot;; } &quot;Transit Provider 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Transit Provider 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Corporate Spine 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Corporate Spine 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Wan Provider 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Wan Provider 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Tap Switch&quot; -&gt; &quot;Bro Network Security Monitor&quot; &quot;Tap Switch&quot; -&gt; &quot;Secret Server&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 239)"> <title>active tap</title> <polygon fill=white stroke=none points="-4,4 -4,-239 1016,-239 1016,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_PassiveTap</title> <polygon fill=none stroke=black points="8,-152 8,-227 343,-227 343,-152 8,-152"/> <text text-anchor=middle x="175.5" y="-211.8" font-family="Times,serif" font-size="14.00">Passive Optical Tap</text> </g> <g id=clust2 class=cluster><title>cluster_Corporate1</title> <polygon fill=none stroke=black points="351,-152 351,-227 517,-227 517,-152 351,-152"/> <text text-anchor=middle x=434 y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text> </g> <g id=clust3 class=cluster><title>cluster_Corporate2</title> <polygon fill=none stroke=black points="525,-152 525,-227 691,-227 691,-152 525,-152"/> <text text-anchor=middle x=608 y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text> </g> <g id=clust4 class=cluster><title>cluster_Regional</title> <polygon fill=none stroke=black points="699,-152 699,-227 1004,-227 1004,-152 699,-152"/> <text text-anchor=middle x="851.5" y="-211.8" font-family="Times,serif" font-size="14.00">Active TAP</text> </g> <g id=clust5 class=cluster><title>cluster_7150</title> <polygon fill=none stroke=black points="462,-80 462,-132 580,-132 580,-80 462,-80"/> </g> <g id=clust6 class=cluster><title>cluster_Bro</title> <polygon fill=none stroke=black points="292,-8 292,-60 548,-60 548,-8 292,-8"/> </g> <g id=clust7 class=cluster><title>cluster_Server</title> <polygon fill=none stroke=black points="556,-8 556,-60 688,-60 688,-8 556,-8"/> </g> <g id=node1 class=node><title>Transit Provider 1</title> <ellipse fill=none stroke=black cx=260 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=260 y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 1</text> </g> <g id=node7 class=node><title>Tap Switch</title> <ellipse fill=none stroke=black cx=521 cy=-106 rx="51.0191" ry=18 /> <text text-anchor=middle x=521 y="-102.3" font-family="Times,serif" font-size="14.00">Tap Switch</text> </g> <g id=edge1 class=edge><title>Transit Provider 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M305.54,-163.666C318.88,-159.826 333.507,-155.683 347,-152 388.506,-140.671 435.78,-128.491 470.567,-119.664"/> <polygon fill=black stroke=black points="471.652,-122.999 480.486,-117.151 469.933,-116.214 471.652,-122.999"/> </g> <g id=node2 class=node><title>Transit Provider 2</title> <ellipse fill=none stroke=black cx=91 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=91 y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 2</text> </g> <g id=edge2 class=edge><title>Transit Provider 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M133.473,-163.092C146.958,-159.059 162.003,-154.952 176,-152 275.082,-131.101 392.345,-118.276 461.486,-111.913"/> <polygon fill=black stroke=black points="462.101,-115.371 471.745,-110.984 461.47,-108.4 462.101,-115.371"/> </g> <g id=node3 class=node><title>Corporate Spine 1</title> <ellipse fill=none stroke=black cx=434 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=434 y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 1</text> </g> <g id=edge3 class=edge><title>Corporate Spine 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M454.618,-160.411C466.242,-151.058 480.913,-139.254 493.505,-129.123"/> <polygon fill=black stroke=black points="495.829,-131.745 501.426,-122.749 491.441,-126.291 495.829,-131.745"/> </g> <g id=node4 class=node><title>Corporate Spine 2</title> <ellipse fill=none stroke=black cx=608 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=608 y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 2</text> </g> <g id=edge4 class=edge><title>Corporate Spine 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M587.382,-160.411C575.758,-151.058 561.087,-139.254 548.495,-129.123"/> <polygon fill=black stroke=black points="550.559,-126.291 540.574,-122.749 546.171,-131.745 550.559,-126.291"/> </g> <g id=node5 class=node><title>Wan Provider 1</title> <ellipse fill=none stroke=black cx=928 cy=-178 rx="67.3907" ry=18 /> <text text-anchor=middle x=928 y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 1</text> </g> <g id=edge5 class=edge><title>Wan Provider 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M889.6,-163.044C877.389,-159.009 863.742,-154.913 851,-152 757.767,-130.687 647.253,-118.13 580.708,-111.911"/> <polygon fill=black stroke=black points="580.693,-108.395 570.415,-110.967 580.053,-115.366 580.693,-108.395"/> </g> <g id=node6 class=node><title>Wan Provider 2</title> <ellipse fill=none stroke=black cx=775 cy=-178 rx="67.3907" ry=18 /> <text text-anchor=middle x=775 y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 2</text> </g> <g id=edge6 class=edge><title>Wan Provider 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M733.596,-163.63C721.22,-159.751 707.593,-155.594 695,-152 653.764,-140.232 606.655,-128.13 571.863,-119.444"/> <polygon fill=black stroke=black points="572.487,-115.993 561.938,-116.976 570.797,-122.786 572.487,-115.993"/> </g> <g id=node8 class=node><title>Bro Network Security Monitor</title> <ellipse fill=none stroke=black cx=420 cy=-34 rx="120.359" ry=18 /> <text text-anchor=middle x=420 y="-30.3" font-family="Times,serif" font-size="14.00">Bro Network Security Monitor</text> </g> <g id=edge7 class=edge><title>Tap Switch&#45;&gt;Bro Network Security Monitor</title> <path fill=none stroke=black d="M498.585,-89.4647C485.079,-80.1044 467.644,-68.0206 452.629,-57.6141"/> <polygon fill=black stroke=black points="454.329,-54.5336 444.116,-51.7139 450.341,-60.2869 454.329,-54.5336"/> </g> <g id=node9 class=node><title>Secret Server</title> <ellipse fill=none stroke=black cx=622 cy=-34 rx="57.2688" ry=18 /> <text text-anchor=middle x=622 y="-30.3" font-family="Times,serif" font-size="14.00">Secret Server</text> </g> <g id=edge8 class=edge><title>Tap Switch&#45;&gt;Secret Server</title> <path fill=none stroke=black d="M543.415,-89.4647C557.309,-79.835 575.363,-67.3229 590.661,-56.7199"/> <polygon fill=black stroke=black points="593.073,-59.3069 599.298,-50.7339 589.085,-53.5536 593.073,-59.3069"/> </g> </g> </svg> </div> <h3>Switch configuration</h3> <p>The switch config is where we wire everything together, there are 3 key concepts:</p> <ul> <li>Tap - input</li> <li>Tool - output</li> <li>Tap Group - logical grouping of TAP ports</li> </ul> <p>The configuration is quite simple and <a href="https://www.arista.com/en/um-eos/eos-section-16-3-tap-aggregation-configuration">well documented</a>.</p> <p>First, let's put the switch into tap mode</p> <pre><code>switch&gt;en
switch#configure terminal
switch(config)#tap aggregation
switch(config-tap-agg)#mode exclusive
</code></pre> <p>This will place all switch ports into error disabled and enable tap/tool ports.</p> <p>Next, define our tap ports</p> <pre><code>switch(config)#interface ethernet 1
switch(config-if-Et1)#description Transit Provider 1
switch(config-if-Et1)#switchport mode tap
switch(config-if-Et1)#switchport tool group INTERNET

switch(config)#interface ethernet 2
switch(config-if-Et2)#description Transit Provider 2
switch(config-if-Et2)#switchport mode tap
switch(config-if-Et2)#switchport tool group INTERNET

switch(config)#interface ethernet 3
switch(config-if-Et3)#description Corporate Spine 1
switch(config-if-Et3)#switchport mode tap
switch(config-if-Et3)#switchport tool group CORPORATE

switch(config)#interface ethernet 4
switch(config-if-Et4)#description Corporate Spine 2
switch(config-if-Et4)#switchport mode tap
switch(config-if-Et4)#switchport tool group CORPORATE

switch(config)#interface ethernet 5
switch(config-if-Et5)#description Wan Provider 1
switch(config-if-Et5)#switchport mode tap
switch(config-if-Et5)#switchport tool group WAN

switch(config)#interface ethernet 6
switch(config-if-Et6)#description Wan Provider 2
switch(config-if-Et6)#switchport mode tap
switch(config-if-Et6)#switchport tool group WAN
</code></pre> <p>We now have 3 groups with 3 interfaces in each.</p> <p>Finally, map those groups onto our outputs.</p> <pre><code>switch(config)#interface ethernet 10
switch(config-if-Et10)#description Bro Network Security Monitor
switch(config-if-Et10)#switchport mode tool
switch(config-if-Et10)#switchport tool group set INTERNET WAN

switch(config)#interface ethernet 11
switch(config-if-Et11)#description Secret Server
switch(config-if-Et11)#switchport mode tool
switch(config-if-Et11)#switchport tool group set CORPORATE
</code></pre> <p>Et10 + Et11 will now receive any traffic sent to their relevant groups.</p> <h3>Advanced features</h3> <p>In the demo, we have a static input -> output allocation in real life this can be software controlled or filter based.</p> <p>We could also truncate packets to look at only their headers, potentially useful for encrypted traffic.</p> <p>A simple traffic steering example is as below:</p> <ul> <li>For traffic coming into Eth1</li> <li>Match traffic targeting 8.8.8.8</li> <li>Send to tap group GOOGLE_DNS</li> <li>Send tap group GOOGLE_DNS to Eth20</li> </ul> <pre><code>switch(config)#ip access-list ACL_GOOGLE_DNS
switch(config-acl-ACL_GOOGLE_DNS)#permit ip any 8.8.8.8/32

switch(config)#class-map type tapagg match-any TAP_CLASS_MAP
switch(config-cmap-TAP_CLASS_MAP)#match ip access-group ACL_GOOGLE_DNS

switch(config)#policy-map type tapagg TAP_POLICY
switch(config-pmap-TAP_POLICY)#class TAP_CLASS_MAP
switch(config-pmap-TAP_POLICY-TAP_CLASS_MAP)#set aggregation-group GOOGLE_DNS

switch(config)#interface ethernet 20
switch(config-if-Et20)#description Magic Box
switch(config-if-Et20)#switchport mode tool
switch(config-if-Et20)#switchport tool group set GOOGLE_DNS

switch(config)#interface ethernet1
switch(config-if-Et1)#service-policy type tapagg input TAP_CLASS_MAP
</code></pre> <p>For software-based control, Arista provides a powerful HTTP API as well as XMPP client support and 'on-device' APIs. The Python eAPI client can be found on <a href="https://github.com/arista-eosplus/pyeapi">GitHub</a>, with some <a href="https://github.com/arista-eosplus/pyeapi/tree/develop/examples">examples</a>.</p> <h1>Summary</h1> <p>It is cost effective to deploy tap infrastructure where required. The offering from Arista is very powerful, allowing flexibility to meet any number of requirements.</p> <p>With a number of integration options (JSON API, Python API, XMPP client), having dynamic tapping capabilities is a nice spanner to have in your toolbox.</p> <p>And the cost? Basically, about the same as a 10G switch with routing functionality.</p> <p>Naturally, the cost is varied depending on physical requirements (fibre/copper runs), port speeds (1/10/25/40/100G) and port count; this is applicable to any switch or other tap based deployment.</p> <h2>Footnote</h2> <p>I would advise any tap deployments to be carefully planned, certain topologies, such as multi-stage clos networks do not make good tap targets, both due to the number of links involved and the resulting bandwidth requirements for the TAP infrastructure.</p> <p>Depending on your goals, tapping at natural points of congestion, such as the ingress/egress points for your high performance/bandwidth network segments (transit links, firewalls etc), will likely provide highly useful information at a vastly reduce capture complexity.</p> </div> </article> <article class=post> <h1 class=title><a href="/2017/12/cluebot-wikimedia-labs-setup/">ClueBot Wikimedia Labs Setup</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />24 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/cluebot-wikimedia-labs-setup/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/general'>General</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/foss'>FOSS</a></li></ul> </div> <div class=entry> <p>A few years ago (was it really that long?!), <a href="https://en.wikipedia.org/wiki/User:ClueBot_III">ClueBot III</a> &amp; <a href="https://en.wikipedia.org/wiki/User:ClueBot_NG">ClueBot NG</a> where moved into <a href="https://wikitech.wikimedia.org/wiki/Portal:Wikimedia_Labs">Wikimedia Labs</a> from personal/community servers on <a href="https://www.cluenet.org/">Cluenet</a>.</p> <p>A while later, they were migrated again from <a href="https://wikitech.wikimedia.org/wiki/Portal:Wikimedia_Labs">Wikimedia Labs</a> into <a href="https://wikitech.wikimedia.org/wiki/Portal:Tool_Labs">Wikimedia Tool Labs</a>, providing more resources via the <a href="http://gridscheduler.sourceforge.net/">Open Grid Manager</a> cluster as well as <a href="https://wikitech.wikimedia.org/wiki/Help:Tool_Labs/Web">web services</a> and other shared community things.</p> <p>Recently due to <a href="http://releases.ubuntu.com/12.04/">Ubuntu Precise LTS</a> hitting EOL, the <a href="https://wikitech.wikimedia.org/wiki/Portal:Tool_Labs">Tool Labs</a> containers where migrated to run under <a href="http://releases.ubuntu.com/14.04/">Ubuntu Trusty LTS</a>.</p> <p>During the latest migration, the tool accounts where re-created from scratch. This post will outline how things are configured for a point of reference in the future.</p> <h1>Overview</h1> <p>Accounts:</p> <ul> <li><code>tools.cluebot</code> - Legacy account - only a web service redirect is running</li> <li><code>tools.cluebot3</code> - Dedicated account for <a href="https://en.wikipedia.org/wiki/User:ClueBot_III">ClueBot III</a></li> <li><code>tools.cluebotng</code> - Account for all things related to <a href="https://en.wikipedia.org/wiki/User:ClueBot_NG">ClueBot NG</a></li> </ul> <p>Databases:</p> <ul> <li><code>s51109__cb</code> - Legacy database, no longer updated</li> <li><code>s52585__cb</code> - Migrated database, now master</li> </ul> <p>Key Directories/Files:</p> <p><strong>tools.cluebot3</strong></p> <ul> <li>~/cluebot3 - Clone of <a href="https://github.com/DamianZaremba/cluebot3">https://github.com/DamianZaremba/cluebot3</a></li> <li>~/cluebot3/cluebot3.config.php - Config file</li> <li>~/.bigbrotherrc - Job Supervisor</li> </ul> <p><strong>tools.cluebotng</strong></p> <ul> <li>~/apps/bot - Clone of <a href="https://github.com/DamianZaremba/cluebotng">https://github.com/DamianZaremba/cluebotng</a></li> <li>~/apps/report_interface - Clone of <a href="https://github.com/DamianZaremba/cluebotng-report">https://github.com/DamianZaremba/cluebotng-report</a></li> <li>~/apps/utils - Clone of <a href="https://github.com/DamianZaremba/cbng-utils">https://github.com/DamianZaremba/cbng-utils</a></li> <li>~/apps/core - Downloads of ANN binaries from bintray</li> <li>~/public_html - Symlink to ~/apps/report_interface</li> <li>~/.cluebotng.password.only - Wikimedia password</li> <li>~/.bigbrotherrc - Job Supervisor</li> <li>~/mysql_backups - Database dumps</li> <li>crontab - Database backup/clean crons</li> </ul> <h4>Hosted externally</h4> <ul> <li>check_cluebot3.pl / check_cluebotng.pl - Scripts to check last edit time + email alerts</li> </ul> <h1>ClueBot III</h1> <h2>Setup</h2> <p>This is a very simple bot, relying on a config file only.</p> <p>The server-side setup, assuming a clean account can be done following the below (locally):</p> <ul> <li><code>pip install fabric</code></li> <li><code>git clone git@github.com:DamianZaremba/cluebot3.git</code></li> <li><code>cd cluebot3</code></li> <li><code>fab init</code></li> </ul> <p>A manual setup is required to create the config file.</p> <p>This should be created as <code>~/cluebot3/cluebot3.config.php</code> under the tool account, containing the below:</p> <pre><code class="php">&lt;?php
    $owner = 'Cobi';
    $user = 'ClueBot III';
    $pass = 'Clearly this is not the actual password';
    $status = 'rw';
    $maxlag = 2;
    $maxlagkeepgoing = true;
</code></pre> <p>In your local git clone, you can now do a full deploy (this starts the bot):</p> <ul> <li><code>fab deploy</code></li> </ul> <p>Things should be running, check the job status/logs under the tool account to confirm this.</p> <pre><code class="bash">tools.cluebot3@tools-bastion-03:~$ qstat
job-ID  prior   name       user         state submit/start at     queue                          slots ja-task-ID
-----------------------------------------------------------------------------------------------------------------
xxxxxxx 0.30169 cluebot3   tools.cluebo r     03/04/2017 10:23:33 continuous@tools-exec-xxxx.eqi     1

tools.cluebot3@tools-bastion-03:~$ tail -f ~/logs/cluebot3-2017-03-05.log
cluebot3.INFO: doarchive(xxxxxxxxxxxx) [] []
</code></pre> <p>You should also see <a href="https://en.wikipedia.org/wiki/Special:Contributions/ClueBot_III">edits</a> from the bot after a while (a number of index pages need to be checked first).</p> <h2>Debugging</h2> <p>The main bot log is normally somewhat insightful. Sometimes the bot will die due to memory usage when processing large pages, this generally isn't seen in the logs and is hard to replicate running manually; looking for restarts is an indicator.</p> <h1>ClueBot NG</h1> <p>This bot is slightly more complicated and has numerous parts. The main part is fully scripted, but a number of (non-obvious) configs need to be in place.</p> <h2>Architecture</h2> <p>This is not a depiction of request flow, but service dependencies.</p> <div class=graphviz-wrapper> <svg role=img aria-label="layer 1 encryption" width=887pt height=332pt viewBox="0.00 0.00 887.00 332.00"> <title>layer 1 encryption</title> <desc>digraph &quot;layer 1 encryption&quot; { &quot;Wikipedia IRC RC Feed&quot; -&gt; &quot;Main BOT&quot; [dir=back]; &quot;Main BOT&quot; -&gt; {&quot;Wikimedia Labs Tools Database&quot;, &quot;Wikipedia Database Replica&quot;, &quot;ANN Core&quot;, &quot;Wikimedia API&quot;, &quot;IRC Relay&quot;} &quot;Review Interface&quot; -&gt; {&quot;Wikimedia Labs Tools Database&quot;, &quot;Wikimedia API&quot;, &quot;IRC Relay&quot;} &quot;IRC Relay&quot; -&gt; &quot;ClueNet IRC&quot;; &quot;ClueNet IRC&quot; -&gt; &quot;Huggle / External Tools&quot; [dir=back]; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 328)"> <title>layer 1 encryption</title> <polygon fill=white stroke=none points="-4,4 -4,-328 883,-328 883,4 -4,4"/> <g id=node1 class=node><title>Wikipedia IRC RC Feed</title> <ellipse fill=none stroke=black cx=477 cy=-306 rx="98.1881" ry=18 /> <text text-anchor=middle x=477 y="-302.3" font-family="Times,serif" font-size="14.00">Wikipedia IRC RC Feed</text> </g> <g id=node2 class=node><title>Main BOT</title> <ellipse fill=none stroke=black cx=477 cy=-234 rx="50.0684" ry=18 /> <text text-anchor=middle x=477 y="-230.3" font-family="Times,serif" font-size="14.00">Main BOT</text> </g> <g id=edge1 class=edge><title>Wikipedia IRC RC Feed&#45;&gt;Main BOT</title> <path fill=none stroke=black d="M477,-277.665C477,-269.054 477,-259.791 477,-252.104"/> <polygon fill=black stroke=black points="473.5,-277.697 477,-287.697 480.5,-277.697 473.5,-277.697"/> </g> <g id=node3 class=node><title>Wikimedia Labs Tools Database</title> <ellipse fill=none stroke=black cx=127 cy=-162 rx="127.083" ry=18 /> <text text-anchor=middle x=127 y="-158.3" font-family="Times,serif" font-size="14.00">Wikimedia Labs Tools Database</text> </g> <g id=edge2 class=edge><title>Main BOT&#45;&gt;Wikimedia Labs Tools Database</title> <path fill=none stroke=black d="M439.695,-221.836C432.213,-219.765 424.382,-217.716 417,-216 351.278,-200.72 276.338,-187.122 219.104,-177.526"/> <polygon fill=black stroke=black points="219.431,-174.033 208.992,-175.842 218.281,-180.937 219.431,-174.033"/> </g> <g id=node4 class=node><title>Wikipedia Database Replica</title> <ellipse fill=none stroke=black cx=768 cy=-162 rx="111.186" ry=18 /> <text text-anchor=middle x=768 y="-158.3" font-family="Times,serif" font-size="14.00">Wikipedia Database Replica</text> </g> <g id=edge3 class=edge><title>Main BOT&#45;&gt;Wikipedia Database Replica</title> <path fill=none stroke=black d="M517.462,-223.267C564.311,-211.997 642.27,-193.244 698.8,-179.646"/> <polygon fill=black stroke=black points="699.835,-182.997 708.739,-177.255 698.198,-176.191 699.835,-182.997"/> </g> <g id=node5 class=node><title>ANN Core</title> <ellipse fill=none stroke=black cx=589 cy=-162 rx="49.0941" ry=18 /> <text text-anchor=middle x=589 y="-158.3" font-family="Times,serif" font-size="14.00">ANN Core</text> </g> <g id=edge4 class=edge><title>Main BOT&#45;&gt;ANN Core</title> <path fill=none stroke=black d="M500.752,-218.155C516.938,-208.039 538.575,-194.515 556.374,-183.391"/> <polygon fill=black stroke=black points="558.657,-186.092 565.282,-177.824 554.947,-180.156 558.657,-186.092"/> </g> <g id=node6 class=node><title>Wikimedia API</title> <ellipse fill=none stroke=black cx=340 cy=-162 rx="67.3907" ry=18 /> <text text-anchor=middle x=340 y="-158.3" font-family="Times,serif" font-size="14.00">Wikimedia API</text> </g> <g id=edge5 class=edge><title>Main BOT&#45;&gt;Wikimedia API</title> <path fill=none stroke=black d="M449.276,-218.834C429.073,-208.512 401.429,-194.387 379,-182.927"/> <polygon fill=black stroke=black points="380.557,-179.792 370.06,-178.359 377.372,-186.026 380.557,-179.792"/> </g> <g id=node7 class=node><title>IRC Relay</title> <ellipse fill=none stroke=black cx=474 cy=-162 rx="48.1437" ry=18 /> <text text-anchor=middle x=474 y="-158.3" font-family="Times,serif" font-size="14.00">IRC Relay</text> </g> <g id=edge6 class=edge><title>Main BOT&#45;&gt;IRC Relay</title> <path fill=none stroke=black d="M476.258,-215.697C475.928,-207.983 475.531,-198.712 475.162,-190.112"/> <polygon fill=black stroke=black points="478.658,-189.945 474.733,-180.104 471.665,-190.245 478.658,-189.945"/> </g> <g id=node9 class=node><title>ClueNet IRC</title> <ellipse fill=none stroke=black cx=474 cy=-90 rx="57.2927" ry=18 /> <text text-anchor=middle x=474 y="-86.3" font-family="Times,serif" font-size="14.00">ClueNet IRC</text> </g> <g id=edge10 class=edge><title>IRC Relay&#45;&gt;ClueNet IRC</title> <path fill=none stroke=black d="M474,-143.697C474,-135.983 474,-126.712 474,-118.112"/> <polygon fill=black stroke=black points="477.5,-118.104 474,-108.104 470.5,-118.104 477.5,-118.104"/> </g> <g id=node8 class=node><title>Review Interface</title> <ellipse fill=none stroke=black cx=337 cy=-234 rx="71.2405" ry=18 /> <text text-anchor=middle x=337 y="-230.3" font-family="Times,serif" font-size="14.00">Review Interface</text> </g> <g id=edge7 class=edge><title>Review Interface&#45;&gt;Wikimedia Labs Tools Database</title> <path fill=none stroke=black d="M295.761,-219.254C263.88,-208.627 219.376,-193.792 184.074,-182.025"/> <polygon fill=black stroke=black points="184.973,-178.635 174.38,-178.793 182.76,-185.276 184.973,-178.635"/> </g> <g id=edge8 class=edge><title>Review Interface&#45;&gt;Wikimedia API</title> <path fill=none stroke=black d="M337.742,-215.697C338.072,-207.983 338.469,-198.712 338.838,-190.112"/> <polygon fill=black stroke=black points="342.335,-190.245 339.267,-180.104 335.342,-189.945 342.335,-190.245"/> </g> <g id=edge9 class=edge><title>Review Interface&#45;&gt;IRC Relay</title> <path fill=none stroke=black d="M367.065,-217.638C387.879,-207.003 415.693,-192.792 437.737,-181.529"/> <polygon fill=black stroke=black points="439.481,-184.568 446.794,-176.901 436.296,-178.334 439.481,-184.568"/> </g> <g id=node10 class=node><title>Huggle / External Tools</title> <ellipse fill=none stroke=black cx=474 cy=-18 rx="96.2874" ry=18 /> <text text-anchor=middle x=474 y="-14.3" font-family="Times,serif" font-size="14.00">Huggle / External Tools</text> </g> <g id=edge11 class=edge><title>ClueNet IRC&#45;&gt;Huggle / External Tools</title> <path fill=none stroke=black d="M474,-61.6651C474,-53.0537 474,-43.7913 474,-36.1043"/> <polygon fill=black stroke=black points="470.5,-61.6966 474,-71.6966 477.5,-61.6967 470.5,-61.6966"/> </g> </g> </svg> </div> <p>Critical services for basic bot functionality include:</p> <ul> <li>Wikipedia API (For downloading changes + reverts)</li> <li>Tools DB (For creating vandalism IDs + recording action)</li> <li>Wikipedia DB Replicas (up to date) (For fetching extra metadata)</li> <li>Wikipedia IRC RC Feed (For the change feed)</li> <li>Main Bot (Processor)</li> <li>Core (For edit scoring)</li> </ul> <h2>Setup</h2> <p>The server-side setup, assuming a clean account can be done following the below (locally):</p> <ul> <li><code>pip install fabric</code></li> <li><code>git clone git@github.com:DamianZaremba/cluebotng.git</code></li> <li><code>cd cluebotng</code></li> <li><code>fab deploy</code></li> </ul> <h3>Config Files</h3> <p>A number of config files need to be created manually.</p> <h4>~/.cluebotng.password.only</h4> <pre><code class="plain">The Wikipedia ClueBot NG user password
</code></pre> <h4>~/apps/bot/bot/cluebot-ng.config.php</h4> <pre><code class="php">&lt;?php
namespace CluebotNG;

class Config
{
    public static $user = 'ClueBot NG';
    public static $pass = null;
    public static $status = 'auto';
    public static $angry = false;
    public static $owner = 'Cobi';
    public static $friends = 'ClueBot,DASHBotAV';
    public static $mw_mysql_host = 'enwiki.labsdb';
    public static $mw_mysql_port = 3306;
    public static $mw_mysql_user = 's52585';
    public static $mw_mysql_pass = 'a password that is actually real';
    public static $mw_mysql_db = 'enwiki_p';
    public static $legacy_mysql_host = 'tools-db';
    public static $legacy_mysql_port = 3306;
    public static $legacy_mysql_user = 's52585';
    public static $legacy_mysql_pass = 'a password that is actually real';
    public static $legacy_mysql_db = 's52585__cb';
    public static $cb_mysql_host = 'tools-db';
    public static $cb_mysql_port = 3306;
    public static $cb_mysql_user = 's52585';
    public static $cb_mysql_pass = 'a password that is actually real';
    public static $cb_mysql_db = 's52585__cb';
    public static $udpport = 3334;
    public static $coreport = 3565;
    public static $fork = true;
    public static $dry = false;
    public static $sentry_url = null;
}
</code></pre> <h4>~/apps/report_interface/web-settings.php</h4> <pre><code class="php">&lt;?PHP
    $dbHost = 'tools-db';
    $dbUser = 's52585';
    $dbPass = 'a password that is actually real';
    $dbSchema = 's52585__cb';
    $rcport = 3333;
    $recaptcha_pubkey = "something here";
    $recaptcha_privkey = "something here too";
</code></pre> <h4>~/apps/bot/relay_irc/relay_irc.conf.js</h4> <pre><code class="javascript">exports.nick = 'CBNGRelay';
exports.server = 'irc.cluenet.org';
exports.extra = [
    'OPER antiflood This Is Not The One You Are Looking For',
];
</code></pre> <h3>Re-Deploy</h3> <p>Now the config files are in place, the bot should actually work.</p> <p>In your local git clone, complete another deploy, to restart everything:</p> <ul> <li><code>fab deploy</code></li> </ul> <h3>Bot Checks</h3> <h5>First, check the job status</h5> <pre><code class="bash">tools.cluebotng@tools-bastion-03:~$ qstat
job-ID  prior   name       user         state submit/start at     queue                          slots ja-task-ID
-----------------------------------------------------------------------------------------------------------------
xxxxxxx 0.30159 lighttpd-c tools.cluebo r     03/04/2017 12:48:57 webgrid-lighttpd@tools-webgrid     1
xxxxxxx 0.30154 cbng_relay tools.cluebo r     03/04/2017 13:32:09 continuous@tools-exec-xxxx.too     1
xxxxxxx 0.30154 cbng_core  tools.cluebo r     03/04/2017 13:32:11 continuous@tools-exec-xxxx.too     1
xxxxxxx 0.30092 cbng_bot   tools.cluebo r     03/04/2017 23:56:38 continuous@tools-exec-xxxx.too     1
</code></pre> <h5>Next check the bot logs</h5> <pre><code>tools.cluebotng@tools-bastion-03:~$ tail -f ~/logs/cluebotng-2017-03-05.log
cluebotng.INFO: Processing: [[Something]] [...]
</code></pre> <h5>Then check the IRC Feeds (irc.cluenet.org)</h5> <ul> <li><code>#cluebotng-spam</code> - Should have constant messages</li> <li><code>#wikipedia-VAN</code> - Should have a message within 10min</li> </ul> <p>Confirm the bot is also <a href="https://en.wikipedia.org/wiki/Special:Contributions/ClueBot_NG">making edits</a> inline with messages reported in <code>#wikipedia-VAN</code>.</p> <h5>Finally, check the review interface</h5> <ul> <li><a href="https://tools.wmflabs.org/cluebotng/?page=List">https://tools.wmflabs.org/cluebotng/?page=List</a> - Should render</li> <li><a href="https://tools.wmflabs.org/cluebotng/?page=View&amp;id=120371">https://tools.wmflabs.org/cluebotng/?page=View&amp;id=120371</a> - Should render</li> <li>Take a recent edit from the <code>#wikipedia-VAN</code> channel and submit it as a reported</li> <li>Check Sign In works (set your test above to invalid, if it looks OK)</li> </ul> <h3>General Checks</h3> <p>After a couple of hours, check:</p> <ul> <li>check_cluebot3.pl / check_cluebotng.pl are successfully running externally</li> <li>~/mysql_backups/ contains valid database dumps</li> <li>No 'not running' emails have been received</li> <li>~/bigbrother.log for restarts</li> <li><a href="https://en.wikipedia.org/wiki/User_talk:ClueBot_Commons">ClueBot Commons</a> For user problems</li> </ul> <h2>Debugging</h2> <p>The main bot log provides a good indicator as to the source of problems but has limited data due to the logging volume.</p> <p>It is common to see 'Failed to get edit data for xxx', this is only a problem if it's happening for a large number of changes; normally this is due to delayed replicas, causing the user/page metadata for new users/pages to be non-existent.</p> <p>The relays generally don't break but may have incorrect entries in the database. The simplest fix is to kill the job and let it re-spawn.</p> <p>The report interface will likely break due to PHP being updated, it will need fixing randomly; there is a motivation to rebuild the interface to include the review functionality as well as OAuth based authentication (<a href="https://phabricator.wikimedia.org/T135323">T135323</a>).</p> </div> </article> <nav id=page_nav> <a href="/2/" class=next>Next Page &raquo;</a> </nav> </div> <footer class=footer> <div class=container> <p class=text-muted>Copyright 2009-2018 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p> <ul id=ads> <li>Need error tracking? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li> <li>Need cloud instances? Jump on <a href="http://www.bigv.io">BigV</a></li> <li>Want my website? <a href="https://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li> </ul> </div> </footer> <script src="/assests/js/jquery.min.js?_v=5790ead7ad3ba27397aedfa3d263b867"></script> <script src="/assests/js/bootstrap.min.js?_v=046ba2b5f4cff7d2eaaa1af55caa9fd8"></script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_require","inpage_linkid","//www.google-analytics.com/plugins/ga/inpage_linkid.js"]);_gaq.push(["_setAccount","UA-11817192-1"]);_gaq.push(["_setDomainName","damianzaremba.co.uk"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src="//stats.g.doubleclick.net/dc.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//damianzaremba.disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> <!--[if lt IE 9]><script src="/assests/js/html5shiv.min.js?_v=3044234175ac91f49b03ff999c592b85"></script> <script src="/assests/js/respond.min.js?_v=afc1984a3d17110449dc90cf22de0c27"></script><![endif]--> </body> </html>