<!DOCTYPE HTML>
<html>
<head>
    <title>Damian Zaremba - Blog</title>

    <!-- General meta data -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Damian Zaremba's Blog" />
    <meta name="copyright" content=">Copyright 2009-2012 Damian Zaremba" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />
    <meta name="revisit" content="7 days" />

    <!-- M$ meta data -->
    <meta name="classification" content="GENERAL" />
    <meta name="distribution" content="GLOBAL" />
    <meta name="audience" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="TRUE" />

    <!-- CSS files -->
    <link href="http://10.44.200.5:4039/assests/css/main.css" rel="stylesheet" type="text/css" />

    <!-- IE fixes -->
    <!--[if IE]>
        /* hover.htc fixes a bunch of issues with hovering objects in IE */
        body {
            behavior: url("http://10.44.200.5:4039/assests/other/hover.htc");
        }
    <![endif]-->

    <!--
    Site rendered at:  2012-08-17 22:13:49 +0100 by Jekyll.
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
</head>

<body>

    <header>
        <h1><a href="/">Damian Zaremba's Blog</a></h1>

        <nav class="menu">
            <ul class="main">
               <li><a href="/">Blog</a></li>
               <li><a href="/archives">Archives</a></li>
               <li><a href="/about">About</a></li>
            </ul>
        </nav>

        <div class="right">
            <form class="search" action="http://google.com/search" method="get">
                <input class="left" type="text" name="q" results="0">
                <input type="hidden" name="q" value="site:damianzaremba.co.uk">
            </form>

            <div class="social">
                <a class="twitter" href="http://twitter.com/DamianZaremba" title="Twitter">Twitter</a>
                <a class="github" href="https://github.com/DamianZaremba" title="GitHub">GitHub</a>
                <a class="rss" href="http://feeds.feedburner.com/DamianZaremba" title="RSS">RSS</a>
           </div>
        </div>
</header>

<div id="content">

	
	<article class="post">
	    <h1 class="title"><a href="/2012/04/radius-authentication-on-a-hp-procurve-switch">RADIUS authentication on a HP ProCurve switch</a></h1>
	    <div class="entry">
	        <p>To configure a HP ProCurve switch for RADIUS authentication you need to use radius-server with the following syntax.</p>

<p>Once this is setup you need to configure the switch to authenticate against the radius server.</p>

<p>We include the local option so that in the event of the RADIUS server being down we can still authenticate.</p>

	    </div>

	    <div class="meta">
	        <div class="date">01 Apr 2012</div>
 			<span class="comments">
 				<a href="/2012/04/radius-authentication-on-a-hp-procurve-switch#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>authentication</a>
	            
	            <a class='tag' href=''>hp</a>
	            
	            <a class='tag' href=''>network</a>
	            
	            <a class='tag' href=''>radius</a>
	            
	            <a class='tag' href=''>switch</a>
	            

	        	
	            <a class='category' href=''>How-to</a>
	            
	            <a class='category' href=''>Software</a>
	            
	            <a class='category' href=''>Work</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2012/04/radius-authentication-on-a-hp-gbe2c-l2-l3-blade-switch">RADIUS authentication on a HP GbE2c L2/L3 Blade Switch</a></h1>
	    <div class="entry">
	        <p>To configure a HP GbE2c L2/L3 Ethernet Blade Switch for RADIUS authentication you need to use radius-server with the following syntax.</p>

<p>The first and second lines setup the server/key to authenticate against.</p>

<p>The third/forth defines the port/timeout for the server we configured in the first lines.</p>

<p>The last 3 then enable the server and enable a backdoor so we can authenticate against the switch if the RADIUS server is down.</p>

	    </div>

	    <div class="meta">
	        <div class="date">01 Apr 2012</div>
 			<span class="comments">
 				<a href="/2012/04/radius-authentication-on-a-hp-gbe2c-l2-l3-blade-switch#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>authentication</a>
	            
	            <a class='tag' href=''>hp</a>
	            
	            <a class='tag' href=''>network</a>
	            
	            <a class='tag' href=''>radius</a>
	            
	            <a class='tag' href=''>switch</a>
	            

	        	
	            <a class='category' href=''>How-to</a>
	            
	            <a class='category' href=''>Software</a>
	            
	            <a class='category' href=''>Work</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2012/03/sntp-on-a-hp-procurve-switch">SNTP on a HP ProCurve switch</a></h1>
	    <div class="entry">
	        <p>Configuring NTP for switches is a rather simple process, however the syntax varies depending on the switch OS.</p>

<p>Most switches use SNTP rather than NTP, SNTP is basically NTP but lacks some of the more advanced internal algorithms and is slightly less accurate.</p>

<p>To configure a ProCurve you need to use SNTP with the following syntax.</p>

<p>The first line defines what IP to sync with, the second tells the switch to use unicast UDP rather than TCP and the third tells the switch to sync it's time with the SNTP server.</p>

<p>This needs to be done in configure mode which can be got into via enable mode.</p>

<p>Once the switch is syncing with the SNTP server you can check the time is correct with</p>

<p>Lastly just save the changes then logout</p>

<p>A full example of this is below:</p>

<p>Your switches should now keep their time in sync :)</p>

	    </div>

	    <div class="meta">
	        <div class="date">18 Mar 2012</div>
 			<span class="comments">
 				<a href="/2012/03/sntp-on-a-hp-procurve-switch#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>hp</a>
	            
	            <a class='tag' href=''>network</a>
	            
	            <a class='tag' href=''>ntp</a>
	            
	            <a class='tag' href=''>sntp</a>
	            
	            <a class='tag' href=''>switch</a>
	            

	        	
	            <a class='category' href=''>How-to</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2012/03/sntp-on-a-hp-gbe2c-l2-l3-blade-switch">NTP on a HP GbE2c L2/L3 Blade Switch</a></h1>
	    <div class="entry">
	        <p>To configure a HP GbE2c L2/L3 Ethernet Blade Switch for HP c-Class BladeSystem, you need to use NTP with the following syntax.</p>

<p>The first line enables NTP, the second tells the switch to use GMT+0 and the third/forth tells the switch which servers to sync with.</p>

<p>This needs to be done in configure mode which can be got into via enable mode.</p>

<p>Now ensure the switch timezone is correct, the command for this is slightly obnoxious. Below is an example of setting it to GB:</p>

<p>Lastly just save the changes then logout</p>

<p>A full example of this is below:</p>

<p>Your switches should now keep their time in sync :)</p>

	    </div>

	    <div class="meta">
	        <div class="date">18 Mar 2012</div>
 			<span class="comments">
 				<a href="/2012/03/sntp-on-a-hp-gbe2c-l2-l3-blade-switch#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>hp</a>
	            
	            <a class='tag' href=''>network</a>
	            
	            <a class='tag' href=''>ntp</a>
	            
	            <a class='tag' href=''>sntp</a>
	            
	            <a class='tag' href=''>switch</a>
	            

	        	
	            <a class='category' href=''>How-to</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/11/restricting-access-to-edgecast-nodes">Restricting access to EdgeCast nodes</a></h1>
	    <div class="entry">
	        <p>Today one of our clients published a mix track that was around 140mb, hosted on their account. This was no problem until he started to get hundreds of people downloading the mix which resulted in silly amounts of bandwidth being used.</p>

<p>We quickly had to move him on to the CDN to ensure the traffic impact wasn't affecting performance for him or others as well as reduce his bandwidth charges substantially.</p>

<p>Once the CDN was all set up and the content pushed out onto the nodes we started to send traffic over.</p>

<p>Due to the impact of social media and people linking directly to the content we had to devise a plan to enable access to the content for the CDN but redirect anyone linking directly to the CDNified subdomain.</p>

<p>In comes mod_rewrite. Now it appears EdgeCast don't publish their IP ranges in any format that helps my sanity, they are in fact published in a html table. To find them, login to my.edgecast.com, browse to HTTP Large, click on Customer Origin and scroll down to the bottom.</p>

<p>Linux to the rescue! First we just copy the list into a file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>cat &gt; edgecast_ranges
Asia Hong Kong 117.18.234.0 - 117.18.234.255
110.232.176.0 - 110.232.176.255
Asia Singapore 117.18.236.0 - 117.18.236.255
46.22.71.0 - 46.22.71.255
Asia Tokyo 117.18.233.0 - 117.18.233.255
110.232.177.0 - 110.232.177.255
Australia Sydney 117.18.235.0 - 117.18.235.255
110.232.179.0 - 110.232.179.255
Europe Amsterdam 93.184.208.0 - 93.184.208.255
93.184.209.0 - 93.184.209.255
93.184.217.0 - 93.184.217.255
46.22.70.0 - 46.22.70.255
46.22.72.0 - 46.22.73.255
Europe Frankfurt 72.21.89.0 - 72.21.89.255
93.184.212.0 - 93.184.212.255
93.184.213.0 - 93.184.213.255
Europe London 72.21.90.0 - 72.21.90.255
93.184.210.0 - 93.184.210.255
93.184.211.0 - 93.184.211.255
46.22.74.0 - 46.22.75.255
Europe Madrid 46.22.66.0 - 46.22.67.255
Europe Paris 93.184.214.0 - 93.184.214.255
North America Ashburn 72.21.83.0 - 72.21.83.255
68.232.36.0 - 68.232.36.255
North America Atlanta 72.21.88.0 - 72.21.88.255
72.21.93.0 - 72.21.93.255
North America Chicago 72.21.87.0 - 72.21.87.255
68.232.38.0 - 68.232.38.255
North America Dallas 72.21.86.0 - 72.21.86.255
68.232.39.0 - 68.232.39.255
North America Los Angeles 72.21.84.0 - 72.21.84.255
68.232.40.0 - 68.232.40.255
72.21.94.0 - 72.21.94.255
93.184.218.0 - 93.184.218.255
46.22.69.0 - 46.22.69.255
North America Miami 46.22.64.0 - 46.22.65.255
North America New York 72.21.95.0 - 72.21.95.255
68.232.37.0 - 68.232.37.255
North America San Jose
North America San Jose 72.21.82.0 - 72.21.82.255
68.232.41.0 - 68.232.41.255
North America Seattle 72.21.85.0 - 72.21.85.255
Other N/A 72.21.80.0 - 72.21.80.255
72.21.81.0 - 72.21.81.255
72.21.91.0 - 72.21.91.255
72.21.92.0 - 72.21.92.255
117.18.232.0 - 117.18.232.255
93.184.221.0 - 93.184.221.255
93.184.220.0 - 93.184.220.255
93.184.219.0 - 93.184.219.255
117.18.237.0 - 117.18.237.255
93.184.215.0 - 93.184.215.255
93.184.216.0 - 93.184.216.255
68.232.32.0 - 68.232.32.255
68.232.33.0 - 68.232.33.255
68.232.34.0 - 68.232.34.255
68.232.35.0 - 68.232.35.255
68.232.42.0 - 68.232.42.255
68.232.43.0 - 68.232.43.255
68.232.44.0 - 68.232.44.255
68.232.45.0 - 68.232.45.255
68.232.46.0 - 68.232.46.255
68.232.47.0 - 68.232.47.255
93.184.222.0 - 93.184.222.255
93.184.223.0 - 93.184.223.255
110.232.178.0 - 110.232.178.255
117.18.237.0 - 117.18.237.255
117.18.238.0 - 117.18.238.255
117.18.239.0 - 117.18.239.255
</code></pre>
</div>


<p>Next we need to clear out all the names etc that are randomly dumped in the file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/^.*\s.*\s//g&#39;</span> edgecast_ranges <span class="c"># Get rid of place names</span>
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;/^\s*$/d&#39;</span> edgecast_ranges <span class="c"># Get rid of blank lines</span>
</code></pre>
</div>


<p>Now let's actually turn these IP ranges into something Apache can understand (they are all /24's so we can cheat):</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/^/RewriteCond %{REMOTE_ADDR} !^/g&#39;</span> edgecast_ranges <span class="c"># Add the rewrite cond</span>
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/\.255$/.*$/g&#39;</span> edgecast_ranges <span class="c"># Add the wildcard</span>
</code></pre>
</div>


<p>Now let's create the actual htaccess file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;RewriteEngine On&#39;</span> &gt;&gt; .htaccess
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>cat edgecast_ranges &gt;&gt; .htaccess
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;RewriteRule ^downloads/(.*)$ http://media.example.com/$1 [R,L]&#39;</span> &gt;&gt; .htaccess
</code></pre>
</div>


<p>You should end up with something looking like this:</p>

<div class="highlight"><pre><code class="bash">RewriteEngine On
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.234.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.176.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.236.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.71.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.233.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.177.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.235.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.179.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.208.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.209.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.217.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.70.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.72.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.89.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.212.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.213.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.90.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.210.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.211.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.74.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.66.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.214.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.83.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.36.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.88.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.93.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.87.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.38.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.86.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.39.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.84.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.40.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.94.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.218.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.69.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.64.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.95.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.37.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.82.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.41.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.85.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.80.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.81.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.91.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.92.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.232.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.221.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.220.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.219.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.237.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.215.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.216.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.32.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.33.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.34.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.35.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.42.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.43.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.44.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.45.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.46.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.47.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.222.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.223.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.178.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.237.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.238.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.239.*<span class="err">$</span>
RewriteRule ^downloads/<span class="o">(</span>.*<span class="o">)</span><span class="nv">$ </span>http://media.example.com/<span class="nv">$1</span> <span class="o">[</span>R,L<span class="o">]</span>
</code></pre>
</div>


<p>If you browse to http://example.com/downloads/ you should be redirected to http://media.example.com/ unless you are coming from an Edgecast IP range.</p>

<p>Now you can go back to reading slashdot ;)</p>

	    </div>

	    <div class="meta">
	        <div class="date">02 Nov 2011</div>
 			<span class="comments">
 				<a href="/2011/11/restricting-access-to-edgecast-nodes#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>apache</a>
	            
	            <a class='tag' href=''>cat</a>
	            
	            <a class='tag' href=''>cdn</a>
	            
	            <a class='tag' href=''>edgecast</a>
	            
	            <a class='tag' href=''>linux</a>
	            
	            <a class='tag' href=''>mod_rewrite</a>
	            
	            <a class='tag' href=''>sed</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/changing-wordpress-tag-to-category">Changing WordPress tag to category?</a></h1>
	    <div class="entry">
	        <p>While there appears to be plugins for converting categories to tags, I can't for the life of me find one to convert tags to categories.</p>

<p>After a quick poke around in the database it seem quite simple to convert between the two.
Note: This /seems/ to work however it might kick you in the face and break stuff.</p>

<p>First find out your "term" id (category or tag):</p>

<div class="highlight"><pre><code class="bash">mysql&gt; SELECT * FROM <span class="sb">`</span>terms<span class="sb">`</span> WHERE <span class="sb">`</span>slug<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;snippets&#39;</span>;
+---------+----------+----------+------------+
| term_id | name | slug | term_group |
+---------+----------+----------+------------+
| 171 | Snippets | snippets | 0 |
+---------+----------+----------+------------+
1 row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre>
</div>


<p>Now look in the taxonomy table and find out its details:</p>

<div class="highlight"><pre><code class="bash">mysql&gt; SELECT * FROM <span class="sb">`</span>term_taxonomy<span class="sb">`</span> WHERE <span class="sb">`</span>term_id<span class="sb">`</span> <span class="o">=</span> 171;
+------------------+---------+----------+-------------+--------+-------+
| term_taxonomy_id | term_id | taxonomy | description | parent | count |
+------------------+---------+----------+-------------+--------+-------+
| 174 | 171 | post_tag | | 0 | 17 |
+------------------+---------+----------+-------------+--------+-------+
1 row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre>
</div>


<p>As you can see it is currently a "post_tag".</p>

<p>To change it to a category change the "taxonomy" field to "category":</p>

<div class="highlight"><pre><code class="bash">mysql&gt; UPDATE <span class="sb">`</span>term_taxonomy<span class="sb">`</span> SET <span class="sb">`</span>taxonomy<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;category&#39;</span> WHERE <span class="sb">`</span>term_id<span class="sb">`</span> <span class="o">=</span> 171;
Query OK, 1 row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
Rows matched: 1 Changed: 1 Warnings: 0
</code></pre>
</div>


<p>Or to change it from a category to a tag then change the "taxonomy" field to "post_tag":</p>

<div class="highlight"><pre><code class="bash">mysql&gt; UPDATE <span class="sb">`</span>term_taxonomy<span class="sb">`</span> SET <span class="sb">`</span>taxonomy<span class="sb">`</span> <span class="o">=</span> <span class="s1">&#39;post_tag&#39;</span> WHERE <span class="sb">`</span>term_id<span class="sb">`</span> <span class="o">=</span> 171;
Query OK, 1 row affected <span class="o">(</span>0.02 sec<span class="o">)</span>
Rows matched: 1 Changed: 1 Warnings: 0
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">25 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/changing-wordpress-tag-to-category#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>category to tag</a>
	            
	            <a class='tag' href=''>mysql</a>
	            
	            <a class='tag' href=''>tag to category</a>
	            
	            <a class='tag' href=''>wordpress</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>How-to</a>
	            
	            <a class='category' href=''>Software</a>
	            
	            <a class='category' href=''>Wordpress</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/changing-the-mysql-client-prompt">Changing the MySQL client prompt</a></h1>
	    <div class="entry">
	        <p>It is quite easy to get lost in MySQL when working between a lot of databases.</p>

<p>While you can find out which database you are in, it soon becomes quite irritating having to type</p>

<div class="highlight"><pre><code class="bash">mysql&gt; <span class="k">select </span>database<span class="o">()</span>;

+------------------+
| database<span class="o">()</span> |
+------------------+
| test_database |
+------------------+
1 row in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</code></pre>
</div>


<p>The simplest way to solve this and make life easier, is to change the prompt to include the info!
Simple edit the [mysql] section of your my.cnf file and add the prompt option:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>client<span class="o">]</span>
<span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;mehuser&quot;</span>
<span class="nv">pass</span> <span class="o">=</span> <span class="s2">&quot;someubersecurepassword&quot;</span>
<span class="nv">prompt</span><span class="o">=</span>mysql <span class="o">[</span><span class="se">\\</span>u@<span class="se">\\</span>h - <span class="se">\\</span>d<span class="o">]</span>&gt;
</code></pre>
</div>


<p>Now when you use the client the prompt will show mysql [<user>@<host> - <database>]>:</p>

<div class="highlight"><pre><code class="bash">mysql <span class="o">[</span>test1@localhost - test_database<span class="o">]</span>&gt;
</code></pre>
</div>


<p>No more getting confused! If you don't have access to /etc/my.cnf then use ~/.my.cnf, I usually stick the connection details in there as well - then you can have huge passwords and never have to type/remember them:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>client<span class="o">]</span>
<span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;mehuser&quot;</span>
<span class="nv">pass</span> <span class="o">=</span> <span class="s2">&quot;someubersecurepassword&quot;</span>
<span class="nv">prompt</span><span class="o">=</span>mysql <span class="o">[</span><span class="se">\\</span>u@<span class="se">\\</span>h - <span class="se">\\</span>d<span class="o">]</span>&gt;
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">25 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/changing-the-mysql-client-prompt#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>my.cnf</a>
	            
	            <a class='tag' href=''>mysql</a>
	            
	            <a class='tag' href=''>prompt</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	            <a class='category' href=''>MySQL</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/useful-cpanel-paths">Useful cPanel paths</a></h1>
	    <div class="entry">
	        <p>Some common and useful paths for cPanel are as below - please note that these may change at any time.
[table id=2 /]</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/useful-cpanel-paths#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>cpanel</a>
	            
	            <a class='tag' href=''>data</a>
	            
	            <a class='tag' href=''>paths</a>
	            

	        	
	            <a class='category' href=''>cPanel</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/upgrade-eol-clamav">Upgrade EOL Clamav</a></h1>
	    <div class="entry">
	        <p>To upgrade ClamAV on a RHEL based system perform the following:
1) wget http://pkgs.repoforge.org/clamav/clamav-0.96.1-1.el5.src.rpm
2) yum install srpm unzip
3) CFLAGS="-O0" ./configure --disable-zlib-vcheck
4) make &amp;&amp; make install
5) Update /usr/local/etc/clamd.conf (notably removing the "Example" line and un-commenting the TCP socket line).</p>

<p>ClamAV should now work once again.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/upgrade-eol-clamav#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>clamav</a>
	            
	            <a class='tag' href=''>eol</a>
	            
	            <a class='tag' href=''>update</a>
	            

	        	
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/spoon">Spoon!</a></h1>
	    <div class="entry">
	        <p>It still needs some work to smooth out the handle and round the top off as well as sanding the dip out but I've made a pretty decent start on a spoon.</p>

<p>This started out as part of a tree trunk which got removed and split with an axe, from there all the work has been done with 3 knives:</p>

<ul>
<li><p>Spoon knife - for rounding the handle and scraping out the dip</p></li>
<li><p>9" knife - for taking off the thick outer and bark</p></li>
<li><p>Gerber STL 2.5 knife - for taking tiny slivers off the handle and smoothing out some of the head</p></li>
</ul>


<p>Here are some "early" (4/5 days of on and off work) pictures...
[gallery]</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/spoon#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>hand made</a>
	            
	            <a class='tag' href=''>soon</a>
	            
	            <a class='tag' href=''>spoon knife</a>
	            
	            <a class='tag' href=''>tree</a>
	            
	            <a class='tag' href=''>would</a>
	            

	        	
	            <a class='category' href=''>Camping</a>
	            
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>Knife skills</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/smtp-authentication-in-postfix-using-local-system-accounts">SMTP Authentication in Postfix using local system accounts</a></h1>
	    <div class="entry">
	        <p>In /etc/postfix/main.cf ensure the following values are set</p>

<p>This will ensure postfix denies any un-authenticated attempts to send mail and enabled sasl authentication.</p>

<p>Next we just need to make sure sasl/postfix are setup to run:</p>

<div class="highlight"><pre><code class="bash">chkconfig saslauthd on
/etc/init.d/saslauthd restart
chkconfig postfix on
/etc/init.d/postfix restart
</code></pre>
</div>


<p>Once this is done all we need to do is add our users and they can send mail:</p>

<div class="highlight"><pre><code class="bash">adduser -s /sbin/nologin -M user1
passwd user1

adduser -s /sbin/nologin -M user2
passwd user2
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/smtp-authentication-in-postfix-using-local-system-accounts#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>email</a>
	            
	            <a class='tag' href=''>smtp</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	            <a class='category' href=''>Postfix</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/recovering-deleted-files-from-the-handlers-in-proc">Recovering deleted files from the handlers in /proc/</a></h1>
	    <div class="entry">
	        <p>On compromised servers it is very common for the exploit to delete its self/logs to try and hide its presence.</p>

<p>Even though the executable may be removed from the filesystem as the process is forked from apache the parent process will still have file handlers open.</p>

<p>This will allow you to recover log files/executables as long as you do not kill the process.</p>

<p>To recover the files use the following steps:
1) Find the PID of the process with the open file handlers (use lsof)
2) cd /proc//fd where  is what you found using lsof above
3) ls -lra and you should see a load of broken symlinks (red)
4) Copy the file using cp into another directory</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/recovering-deleted-files-from-the-handlers-in-proc#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>apache</a>
	            
	            <a class='tag' href=''>deleted files</a>
	            
	            <a class='tag' href=''>file recovary</a>
	            
	            <a class='tag' href=''>proc</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/quick-script-to-get-public-ips-on-a-natd-server">Quick script to get public IPs on a NAT'd server</a></h1>
	    <div class="entry">
	        <p>A quick one liner to get the public equivalent of internal IPs on a box behind NAT:</p>

<div class="highlight"><pre><code class="bash"><span class="k">for </span>int in <span class="k">$(</span>ifconfig | grep <span class="s2">&quot;Link encap:&quot;</span> | awk <span class="s1">&#39;{print $1}&#39;</span> | grep -v <span class="s1">&#39;lo&#39;</span><span class="k">)</span>; <span class="k">do </span><span class="nb">echo</span> <span class="s2">&quot;$int: $(ifconfig $int | grep &quot;</span>inet addr:<span class="s2">&quot; | awk &#39;{print $2}&#39; | cut -d: -f2) =&gt; $(curl -s --interface $int ipv4.canhazip.info)&quot;</span>; <span class="k">done</span>
</code></pre>
</div>


<p>I've restricted this to IPv4 only - NATing IPv6 is just silly but if you really want then it is on your head.</p>

<p>Example usage is as follows:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="k">for </span>int in <span class="k">$(</span>ifconfig | grep <span class="s2">&quot;Link encap:&quot;</span> | awk <span class="s1">&#39;{print $1}&#39;</span> | grep -v <span class="s1">&#39;lo&#39;</span><span class="k">)</span>; <span class="k">do </span><span class="nb">echo</span> <span class="s2">&quot;$int: $(ifconfig $int | grep &quot;</span>inet addr:<span class="s2">&quot; | awk &#39;{print $2}&#39; | cut -d: -f2) =&gt; $(curl -s --interface $int ipv4.canhazip.info)&quot;</span>; <span class="k">done</span>
br0: 10.44.200.5 <span class="o">=</span>&gt; 89.242.208.82
br0:1: 10.44.200.15 <span class="o">=</span>&gt; 89.242.208.82
cluevpn: 10.156.1.49 <span class="o">=</span>&gt; 89.242.208.82
eth0: <span class="o">=</span>&gt;
vnet0: <span class="o">=</span>&gt;
</code></pre>
</div>


<p>Or if you want IPv6 addresses returned:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="k">for </span>int in <span class="k">$(</span>ifconfig | grep <span class="s2">&quot;Link encap:&quot;</span> | awk <span class="s1">&#39;{print $1}&#39;</span> | grep -v <span class="s1">&#39;lo&#39;</span><span class="k">)</span>; <span class="k">do </span><span class="nb">echo</span> <span class="s2">&quot;$int: $(ifconfig $int | grep &quot;</span>inet addr:<span class="s2">&quot; | awk &#39;{print $2}&#39; | cut -d: -f2) =&gt; $(curl -s --interface $int canhazip.info)&quot;</span>; <span class="k">done</span>
br0: 10.44.200.5 <span class="o">=</span>&gt; 2001:470:9083::2
br0:1: 10.44.200.15 <span class="o">=</span>&gt;
cluevpn: 10.156.1.49 <span class="o">=</span>&gt;
eth0: <span class="o">=</span>&gt;
vnet0: <span class="o">=</span>&gt;
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/quick-script-to-get-public-ips-on-a-natd-server#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>NAT</a>
	            
	            <a class='tag' href=''>bash</a>
	            
	            <a class='tag' href=''>curl</a>
	            
	            <a class='tag' href=''>ips</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/mysql-uses-no-space-on-cpanel">MySQL uses no space on cPanel</a></h1>
	    <div class="entry">
	        <p>For some reason cPanel decided to start by default excluding sql databases from the disk usage stats.</p>

<p>To enable these again edit the /var/cpanel/cpanel.config file and change disk_usage_include_sqldbs from 0 to 1.</p>

<p>After running /scripts/update_db_cache you should now see disk stats in the interface once again.</p>

<p>Note: SQL database usage stats can be quite intensive to calculate so you may want to leave it off.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/mysql-uses-no-space-on-cpanel#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>cpanel.config</a>
	            
	            <a class='tag' href=''>mysql</a>
	            

	        	
	            <a class='category' href=''>cPanel</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/install-postgresql-on-cpanel">Install PostgreSQL on cPanel</a></h1>
	    <div class="entry">
	        <p>To install PostgreSQL on a cPanel server you can perform the following:
1) Run /scripts/installpostgres
2) Go to SQL services -> Postgre config and click Install config
3) Configure a root password for Postgre
4) Enable Postgre with chkconfig postgres on; service postgres restart</p>

<p>Now you would think that is it, right?
Well if you already have users on the box you will now need to add them into postgre otherwise they will have no access.</p>

<p>You can add them with the following script:</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/install-postgresql-on-cpanel#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>PostgreSQL</a>
	            
	            <a class='tag' href=''>cpanel</a>
	            
	            <a class='tag' href=''>hack</a>
	            
	            <a class='tag' href=''>pgsql</a>
	            

	        	
	            <a class='category' href=''>cPanel</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>PostgreSQL</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/http-basic-authentication-apache">HTTP basic authentication - Apache</a></h1>
	    <div class="entry">
	        <p>Method 1)
Inside the directory you wish to protect include a .htaccess file with the following content:</p>

<p>Method 2)
In your apache config file add the following:</p>

<p>Now you have configured apache for authentication you need to create a password "databases". This is a file in a format apache can understand.</p>

<p>You can create it with the htpasswd command:</p>

<p>Once you have your password database, if you need to update a users password or add more users you can use the htpasswd command without the -c option, like so:</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/http-basic-authentication-apache#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>apache</a>
	            
	            <a class='tag' href=''>authentication</a>
	            
	            <a class='tag' href=''>htaccess</a>
	            
	            <a class='tag' href=''>http basic</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/getting-rid-of-cpanel-ip-check-errors">Getting rid of cPanel IP Check errors</a></h1>
	    <div class="entry">
	        <p>On Linux servers behind NAT you will start getting emails warning that the DNS setup is broken.</p>

<p>cPanel states that the panel does not work behind NAT and the boxes need <strong>public</strong> ip addresses.</p>

<p>It seems that apart from this warning the panel and services function fine behind NAT (as expected) and while I wouldn't recommend it, sometimes you have no choice.</p>

<p>The email you get though is something like the following:</p>

<p>The best way I find of "fixing" this is to just disable the "Ip address dns check" option in the contact manager.</p>

<p>You could alternatively comment out the check in /scripts/maintenance, however this will be lost in updates.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/getting-rid-of-cpanel-ip-check-errors#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>error</a>
	            
	            <a class='tag' href=''>ipcheck</a>
	            

	        	
	            <a class='category' href=''>cPanel</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	            <a class='category' href=''>Software</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/force-pecl-to-install-64bit-modules">Force PECL to install 64bit modules</a></h1>
	    <div class="entry">
	        <p>To ensure PECL installs 64bit modules you need to install the 64bit php-devel package.</p>

<p>On a RHEL system perform the following:
1) pecl uninstall
2) yum remove php-devel.i386
3) yum install php-devel.x86_64
4) pecl install</p>

<p>Any further modules will now be 64bit.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/force-pecl-to-install-64bit-modules#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>pecl</a>
	            
	            <a class='tag' href=''>php</a>
	            
	            <a class='tag' href=''>x64</a>
	            

	        	
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	            <a class='category' href=''>PHP</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/fixing-iptables-for-passive-ftp">Fixing iptables for passive FTP</a></h1>
	    <div class="entry">
	        <p>To make passive FTP work with iptables you need to enable the "ip_conntrack_ftp" module. This is done by editing the /etc/sysconfig/iptables-config and changing</p>

<p>To include the ip_conntrack_ftp module, like so:</p>

<p>Once this is done, restart iptables and it should play nicely with passive FTP.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/fixing-iptables-for-passive-ftp#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>firewall</a>
	            
	            <a class='tag' href=''>ftp</a>
	            
	            <a class='tag' href=''>iptables</a>
	            
	            <a class='tag' href=''>passive ftp</a>
	            

	        	
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/exim-smtp-with-multiple-ips-and-different-helo-identifiers">Exim SMTP with multiple IPs and different HELO identifiers</a></h1>
	    <div class="entry">
	        <p>To enable different helo commands on multiple IPs we need to utilize the Exim router and transport settings, these are available in Exim 4+.</p>

<p>The first thing we need to create is a custom Router, all the options are listed <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch15.html">here</a> and <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch17.html">here</a>.</p>

<p>An example router:</p>

<p>The senders option is a CSV list of addresses to match in the From header. These can contain regex which makes matching whole domains really easy.</p>

<p>The transport option is a reference to your custom transport (see below).</p>

<p>Next we need to create a custom Transport, all the options are listed <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch24.html">here</a> and <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch30.html">here</a>.</p>

<p>An example transport is:</p>

<p>The interface setting is the IP address this transport should be used on and the helo_data is the command to send.</p>

<p>This makes Exim an awesome platform for shared mail servers. It is very simple to offer whitelisting and protection against spammers.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/exim-smtp-with-multiple-ips-and-different-helo-identifiers#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>email</a>
	            
	            <a class='tag' href=''>helo</a>
	            
	            <a class='tag' href=''>multiple ips</a>
	            
	            <a class='tag' href=''>shared server</a>
	            
	            <a class='tag' href=''>smtp</a>
	            

	        	
	            <a class='category' href=''>Exim</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	            <a class='category' href=''>Software</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/common-pci-compliance-issues-cpanel">Common PCI compliance issues - cPanel</a></h1>
	    <div class="entry">
	        <p>It is quite common for companies running cPanel to attempt to gain PCI compliance. Here are a few common things to do before submitting a scan request.</p>

<p>1) Setup a firewall - PCI love to moan about ports that are not secure. Sometimes they don't even header check what is running, they just assume based on IANA assignments what is running.</p>

<p>For ports that ARE secure but PCI refuse to believe (self signed certs, cPanel/WHM ports) etc there is a quick and dirty solution. Restrict access to those ports from your office IP.</p>

<p>If the PCI scanner can't access the port it can't complain. Also fixes any real security issue - who wants to leave a panel that uses system logins open to the public!</p>

<p>Make sure things like MySQL are blocked off - yes, they have ACLs but the scanner is like a nazi at a blond, jewish party.</p>

<p>2) Fix SSL by disabling v2 and some weaker encryption methods.</p>

<p>In the httpd.conf (or just the SSL vhosts) add the following:</p>

<p>In the /usr/lib/courier-imap/etc/pop3d-ssl and /usr/lib/courier-imap/etc/imapd-ssl files add the following:</p>

<p>In the exim.conf file add the following:</p>

<p>3) Update the server (you should be doing this already).</p>

<div class="highlight"><pre><code class="bash">/scripts/upcp
yum update
</code></pre>
</div>


<p>4) Disable mod_userdir.
You can disable this in WHM under Security -> Apache -> mod_userdir tweak.</p>

<p>5) Tell apache to reveal nothing much about its self. In httpd.conf add the following:</p>

<p>Also diable the TRACE method. To do this go into WHM -> Service configuration -> Apache -> Global configuration and set TraceEnable to off.</p>

<p>Notes:
Passing a PCI scan does not mean your server is secure. It means you have passed the very small set of tests they have available.</p>

<p>You should take some major steps to harden the server against local users as well as remote attacks.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/common-pci-compliance-issues-cpanel#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>compliance</a>
	            
	            <a class='tag' href=''>hardening</a>
	            
	            <a class='tag' href=''>pci</a>
	            
	            <a class='tag' href=''>security</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	            <a class='category' href=''>cPanel</a>
	            
	            <a class='category' href=''>Exim</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/check-for-cve-fixs">Check for CVE fixs</a></h1>
	    <div class="entry">
	        <p>To check if a CVE has been patched on a RHEL based system perform the following.</p>

<p>First, get the real package name:</p>

<div class="highlight"><pre><code class="bash">rpm -qa | grep &lt;package&gt;
</code></pre>
</div>


<p>Now check the package change log for CVE patches:</p>

<div class="highlight"><pre><code class="bash">rpm -q &lt;package&gt; --changelog | grep &lt;cve number&gt;
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/check-for-cve-fixs#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>cve</a>
	            
	            <a class='tag' href=''>linux</a>
	            
	            <a class='tag' href=''>rpm</a>
	            

	        	
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/apache-segmentation-fault-debugging">Apache segmentation fault debugging</a></h1>
	    <div class="entry">
	        <p>Sometimes you will see lines like this in the Apache error log:</p>

<p>This means for some reason the child thread/fork has segfaulted when trying to process the request.</p>

<p>By default apache won't give you any more info than this. To get core dumps you will need to do the following.</p>

<p>1) Enable system coredumps for the apache user.
In /etc/security/limits.conf ensure the following line is present:</p>

<p>2) Tell apache what directory to put dumps into, do this with the following config line:</p>

<p>3) Ensure the dump directory is writeable by the apache user (if not then you will get no dumps!).</p>

<p>4) Restart apache and wait for a segfault.</p>

<p>Now if you look in your specified CoreDumpDirectory you should see a number of .dump files.</p>

<p>To debug these you will need to understand system calls and have some general debugging experience when it comes to executables.</p>

<p>An example of how to load up the core dump into a debugger (gdb) is as follows:</p>

<p>Some genreal tips on how to use a debugger for looking at Apache dumps can be found on <a href="http://httpd.apache.org/dev/debugging.html">their website</a>.</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/apache-segmentation-fault-debugging#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>apache</a>
	            
	            <a class='tag' href=''>core dumps</a>
	            
	            <a class='tag' href=''>segfault</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/apache-process-id">Apache process ID</a></h1>
	    <div class="entry">
	        <p>Sometimes you need to know the Apache PID when trying to track down segfaults or CPU usage issues.</p>

<p>There is a very simple way to do this by altering your LogFormat, a command format to have is the CLF (common log format):</p>

<p>To enable logging the pid just add the %P var like so:</p>

	    </div>

	    <div class="meta">
	        <div class="date">23 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/apache-process-id#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>apache</a>
	            
	            <a class='tag' href=''>logformat</a>
	            
	            <a class='tag' href=''>process</a>
	            

	        	
	            <a class='category' href=''>Apache</a>
	            
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/08/php-curl-dual-stack-issue">PHP CURL dual stack issue</a></h1>
	    <div class="entry">
	        <p>I had a slightly strange issue this morning with PHP and curl (multi_curl actually but it affects curl too).
ClueBot NG was returning API errors all over the place, after a quick look though the main code it appeared that the data from the toolserver API wasn't getting returned properly. Trying to get the headers from the curl handler went no where, everything was returning back empty or NULL.</p>

<p>After testing the code on a different machine and it working fine I started to look at the URL that was being requested, a quick curl (on the command line) found that it hung. Off I went to look at its DNS entries and realised the tunnel on the server had dropped again (really need to get the server admin to move the tunnel somewhere more stable).</p>

<p>Now you would expect that if you cannot get traffic out on IPv6 that CURL would fall back to IPv4, it appears that it doesn't! What actually happens is it sits trying IPv6 until the connection timeout is hit then, showing no warning/error returns back NULL data. Yay for CURL!</p>

<p>A quick fix (until the datacenter gets native IPv6) is to force CURL to use ipv4 when resolving domain names. Now anyone that has looked at developing things in C with CURL will know this is really easy, however the PHP bindings don't even document that you can set the IPRESOLVE option, but you can! Yay for php...</p>

<p>The option is CURLOPT_IPRESOLVE and the value is either CURL_IPRESOLVE_V4, CURL_IPRESOLVE_V6 or CURL_IPRESOLVE_WHATEVER. To force IPv4 just use:</p>

<div class="highlight"><pre><code class="php"><span class="x">curl_setopt( $ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4 );</span>
</code></pre>
</div>


<p>My test script in a broken state is:</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
 <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_USERAGENT</span><span class="p">,</span> <span class="s1">&#39;ClueBot/2.0&#39;</span> <span class="p">);</span>
 <span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxyhost</span> <span class="p">)</span> <span class="k">and</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxyport</span> <span class="p">)</span> <span class="k">and</span> <span class="nv">$proxyport</span> <span class="o">!=</span> <span class="k">null</span> <span class="k">and</span> <span class="nv">$proxyhost</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span> <span class="p">{</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXYTYPE</span><span class="p">,</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxytype</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$proxytype</span> <span class="o">:</span> <span class="nx">CURLPROXY_HTTP</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXY</span><span class="p">,</span> <span class="nv">$proxyhost</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXYPORT</span><span class="p">,</span> <span class="nv">$proxyport</span> <span class="p">);</span>
 <span class="p">}</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="s2">&quot;http://toolserver.org/~cobi/cb.php?user=124.124.10.106&amp;ns=0&amp;title=Sayala&amp;timestamp=1313668350&quot;</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_MAXREDIRS</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">120</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HTTPGET</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_ENCODING</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>

<span class="nb">var_dump</span><span class="p">(</span> <span class="nb">curl_exec</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">)</span> <span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>


<p>And the test script in the fixed status is:</p>

<div class="highlight"><pre><code class="php"><span class="cp">&lt;?php</span>
 <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_USERAGENT</span><span class="p">,</span> <span class="s1">&#39;ClueBot/2.0&#39;</span> <span class="p">);</span>
 <span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxyhost</span> <span class="p">)</span> <span class="k">and</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxyport</span> <span class="p">)</span> <span class="k">and</span> <span class="nv">$proxyport</span> <span class="o">!=</span> <span class="k">null</span> <span class="k">and</span> <span class="nv">$proxyhost</span> <span class="o">!=</span> <span class="k">null</span> <span class="p">)</span> <span class="p">{</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXYTYPE</span><span class="p">,</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$proxytype</span> <span class="p">)</span> <span class="o">?</span> <span class="nv">$proxytype</span> <span class="o">:</span> <span class="nx">CURLPROXY_HTTP</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXY</span><span class="p">,</span> <span class="nv">$proxyhost</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_PROXYPORT</span><span class="p">,</span> <span class="nv">$proxyport</span> <span class="p">);</span>
 <span class="p">}</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="s2">&quot;http://toolserver.org/~cobi/cb.php?user=124.124.10.106&amp;ns=0&amp;title=Sayala&amp;timestamp=1313668350&quot;</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_MAXREDIRS</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_TIMEOUT</span><span class="p">,</span> <span class="mi">120</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_CONNECTTIMEOUT</span><span class="p">,</span> <span class="mi">10</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HTTPGET</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_ENCODING</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="p">);</span>
 <span class="nb">curl_setopt</span><span class="p">(</span> <span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_IPRESOLVE</span><span class="p">,</span> <span class="nx">CURL_IPRESOLVE_V4</span> <span class="p">);</span>

<span class="nb">var_dump</span><span class="p">(</span> <span class="nb">curl_exec</span><span class="p">(</span> <span class="nv">$ch</span> <span class="p">)</span> <span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>


<p>Simples!</p>

	    </div>

	    <div class="meta">
	        <div class="date">18 Aug 2011</div>
 			<span class="comments">
 				<a href="/2011/08/php-curl-dual-stack-issue#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>curl</a>
	            
	            <a class='tag' href=''>php</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>How-to</a>
	            
	            <a class='category' href=''>Linux</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/07/centos-6-0-kickstart-partitioning-issue">Centos 6.0 kickstart partitioning issue</a></h1>
	    <div class="entry">
	        <p>In my kickstart files I "cheat" on disk sizes and let them grow automatically rather than figuring out the size, setting it then having to manually expand it later.</p>

<p>To do this I use the following in my kickstarts:</p>

<p>Basically in the pre section of the kickstart I write out the disk partition stuff using some bash/list-harddrives into a file. This is then included in the main body of the kickstart (due to the pre code being run before the main stuff this works fine).</p>

<p>Now the issue I had with Centos6 was an error getting throw by Anaconda "Partition requires a size specification".</p>

<p>It looks like this is caused by a change in the kickstart script which checks if the size is set (pd.size = None was changed to not self.size).</p>

<p>The simplest way to fix this is just to make --size=1 (lets face it, your minimum partition size isn't going to be smaller 1mb!).</p>

<p>Apart from some other little things like removing the editors, text-internet etc groups out of the kickstart file and downloading the new vmlinuz/initrd.img files everything worked fine first time.</p>

<p>Now to wait for the mirror to finish syncing so I can get some fast installs going (=</p>

	    </div>

	    <div class="meta">
	        <div class="date">10 Jul 2011</div>
 			<span class="comments">
 				<a href="/2011/07/centos-6-0-kickstart-partitioning-issue#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>anaconda</a>
	            
	            <a class='tag' href=''>kickstart</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/twitter">Twitter?</a></h1>
	    <div class="entry">
	        <p>It appears twitter decided to have a re-style once again as can be seen below;</p>

<p><strong>2011</strong>
<img src="http://10.44.200.5:4039/2011/06/twitter/twitter1.png" alt="" /></p>

<p><strong>2010</strong>
<img src="http://10.44.200.5:4039/2011/06/twitter/twitter2.png" alt="" /></p>

<p><strong>2009</strong>
<img src="http://10.44.200.5:4039/2011/06/twitter/twitter3.png" alt="" /></p>

<p>They also keep playing with the web theme as well, mainly the homepage which has changed twice this year and the login link colors which last week where orange but are now back to white.</p>

<p>I think they should focus more on scaling their API and web stack so that they can remove the API limits and increase the platform stability.</p>

<p>Things could change now they have purchased tweetdeck however this may just slowly replace the "official" twitter client.</p>

<p>The recent changes to send email notifications on events also seems to be a step backwards - they are moving things away from near-real time to slow time. The notifications also seem to be quite slow along with the search feeds which I hope they speed up soon.</p>

<p>The one notification I wouldn't mind getting via email is un-follow notifications, I currently rely on third-party services + a bunch of Perl for them.</p>

	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/twitter#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/quick-update">Quick update</a></h1>
	    <div class="entry">
	        <p>Well, it has been a while.</p>

<p>Currently just merging wiki.damianzaremba.co.uk (most the stuff is hidden at the moment) and thegeekstop.net into this single blog.</p>

<p>Once everything is merged learnabouttheweb.co.uk and thegeekstop.net will point to damianzaremba.co.uk/blog/!</p>

<p>Apart from my tumblr account (which I post random pictures too) I don't see the point in having separate blogs all over the place.</p>

<p>Here will become my random content, how to, scripts and generally anything I get time to post about.</p>

<p>Some topics I'm trying to catch up on at the moment are:</p>

<ul>
<li><p>Camping/outdoor skills</p></li>
<li><p>Bushcraft skills</p></li>
<li><p>New equipment</p></li>
<li><p>Tech items</p></li>
<li><p>Events</p></li>
<li><p>Other stuff...</p></li>
</ul>


<p>I also intend to get the calendar up to date (it is missing a LOT of stuff at the moment but the first items on that to-do list are syncing up the scout calendars with the activity plans for the year. If I can find a decent video editing app/camera then I might start using you tube more for publishing content.</p>

<p>Currently quite busy as there is a lot of stuff going on, lots of ideas for next year and plans for this - will post more about them later.</p>

	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/quick-update#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/meth-stove">Meth stove</a></h1>
	    <div class="entry">
	        <p>I saw pretty cool stove the other day and decided to have a go at it.</p>

<p>The final stove was a little messy but <em>should</em> work fine - I'm going to test it on Thursday and see if it works or not.</p>

<p><a href="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0356.jpg"><img src="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0356-225x300.jpg" alt="" /></a></p>

<p>Some notes before starting that I found out the hard way:</p>

<ul>
<li><p>Be careful once you start making cuts - You end up with tiny bits of metal that are <em>very</em> sharp.</p></li>
<li><p>File off the edges - It makes the metal easier to work with and stops you from slicing your fingers open.</p></li>
<li><p>Measure the height of your inner wall - It makes fitting the thing together much easier.</p></li>
<li><p>Don't slice down the side of the can when scoring off the bottoms - This makes it easier to get the bottoms off but means you need a spare can for the inner.</p></li>
<li><p>Be careful when making the holes in the top - I started out with a pin that made nice round holes then broke it so used a knife that made much bigger "slots".</p></li>
<li><p>When rolling your inner wall use a bit of tape - it will burn off later.</p></li>
</ul>


<h2>How to</h2>

<p>First you are going to need:</p>

<ul>
<li><p>2 x Empty drinks cans</p></li>
<li><p>1 x Very sharp knife</p></li>
<li><p>1 x File</p></li>
<li><p>1 x Saw (You could use your knife but a saw makes it easier)</p></li>
<li><p>1 pair of scissors (Once again you could use your knife but this makes it easier)</p></li>
</ul>


<h3>Step1</h3>

<p>Firstly take 1 empty can and turn it upside down so the end <em>without</em> a hole is at the top for you to work on.</p>

<p>Carefully punch a bunch of holes around the outside for burners and a few holes right in the middle for filling.</p>

<p>Make sure not to put the middle holes too close to the outside - you need enough space for the middle wall to separate the fuel.</p>

<p>You should end up with something like this...</p>

<p><a href="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0357.jpg"><img src="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0357.jpg" alt="" /></a></p>

<h3>Step2</h3>

<p>Next you need to cut off the bottom of the can (the actual bottom, where you just made holes in). This will be the "top" of your burner.</p>

<p>An easy way is to clip your knife onto the back of a book then score around the outside.</p>

<p>Once you have a good score line take your saw and run it around to make a cut.</p>

<p>Then after you have just the bottom of the can left take your file and smooth off the top. If need be use your scissors/knife to trim off any crap.</p>

<h3>Step3</h3>

<p>Now you need to make an inner wall which fits around the "dip" in your burners top.</p>

<p>Slice down the side of the can (use the bit you just cut off) and remove the top of the can.</p>

<p>You should be left with basically the body of the can (you may need to use another can depending how big you cut the top of your stove)</p>

<p>Now roll it up to fit around the dip in your burners top and mark it with your knife.</p>

<p>Take a pair of scissors and cut it down to size then tape both ends just to hold it in place.</p>

<p>I taped it a little smaller than it needed to be then pushed it around the dip - this made a tight fit so the next step was easier.</p>

<h3>Step4</h3>

<p>Cut out some notches in the top of your inner wall - this will be where the fuel can flow though into the bottom of the burner.</p>

<p>You should end up with a circle of notches sticking out the top of your burner top.</p>

<h3>Step5</h3>

<p>Now to make the burner bottom, take another empty can and measure it against your burner top.</p>

<p>You want to make it about 1½ times the size of the burner top.</p>

<p>This will fit over your burner top and make the base of the burner where the fuel flows into.</p>

<h3>Step6</h3>

<p>Now we need to fix the bottom to the top.</p>

<p>You want to end up with your inner wall matching up with your little dip in the bottom of the burner as you did with the top.</p>

<p>You can use a spare piece of the side to help you ease the cans together.</p>

<p>You should get a really tight fit - I had to cut down and file off the outer can after as I did the measuring wrong.</p>

<p>Now you should basically have a can with an inner can - You put the fuel in the middle and it flows down to the bottom of the can where you can light it.</p>

<h2>Footnotes</h2>

<p>I've seen a few other people's stoves and they seem to cut them down to just under 2".</p>

<p>Mine ended up slightly bigger as can be seen below. I'm not sure how this will affect its performance but it should produce a better cooking height.</p>

<p><a href="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0358.jpg"><img src="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0358-225x300.jpg" alt="" /></a> <a href="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0359.jpg"><img src="http://damianzaremba.co.uk/wp-content/uploads/2011/06/IMG_0359-225x300.jpg" alt="" /></a></p>

<p>Another thing that was done differently was the number of burners - this will probably use more fuel but should produce a larger heat.</p>

<h3>Other</h3>

<p>I'm going to light this on thursday and see if it works fine - It might explode or work fine. I think I slightly crimped the inner wall while fitting it together.</p>

<p>If it works fine I'll probably build another and document it better else I'll do a design review. As long as my phone doesn't die on me I'll try to get a video of lighting it which could turn out quite funny...</p>

<p>Update:
The stove didn't work very well - upon lighting it the meths burnt off in a big puff of singed hair and wouldn't turn into anything more.</p>

<p>I'm guessing the holes where too big causes a massive rush of oxygen into the fuel "store" and it burning off very quickly.</p>

<p>I'll have another go at building one some time soon as I burnt this attempted (we had a reasonably sized fire, what else would you do) and let you know if it turns out any better.</p>

	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/meth-stove#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>iscout</a>
	            

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/example-of-building-nagios-configs-from-ldap">Example of building nagios configs from LDAP</a></h1>
	    <div class="entry">
	        <p>Over at ClueNet we have a bunch of servers all stored in LDAP with owners and admins linked to user accounts also stored in LDAP! One thing we wanted to implement (as well as graphing, but cacti sorts that out) was service monitoring.</p>

<p>After getting a box up and a bot in IRC to relay stuff I set about hacking up a script to add in servers and add owners/admins as contacts (so they can get notifications and access the Nagios web interface to disable checks and stuff (it uses mod_auth_krb to let people login over HTTPS)).</p>

<p>Some notes about this script:</p>

<ul>
<li><p>Currently we don't store attributes in the servers entry relating to what services to monitor, this is something I'm looking at implimenting</p></li>
<li><p>IP addresses and SSH ports are stored in LDAP</p></li>
<li><p>Server owners AND admins should have access to update the server in Nagios (they do in LDAP!)</p></li>
<li><p>There is no attribute under the users entry to determine if we <em>should</em> notify them about alerts so we don't atm!</p></li>
<li><p>The only way people know about alerts is the relay channel on IRC or the web interface</p></li>
</ul>


<p>The main thing I want to implement that would improve this script is per service attributes in the servers entry following the standard for ClueNet.</p>

<p>I propose the attribute clueServiceMonitoring be added into the ldap scheme and added to the servers entries.</p>

<p>An example is as below:
Server: hex
Services to be monitored:</p>

<ul>
<li><p>ping (via ICMP)</p></li>
<li><p>ssh (will use port listed in LDAP)</p></li>
<li><p>http (port 8080)</p></li>
<li><p>ldap</p></li>
<li><p>kerberos</p></li>
</ul>


<p>This would allow the script to check for the attributes and write out the services definitions as necessary. The current solution works but is a little inflexible.</p>

<p>Also, the Perl could do with tidying up a little as I'm not the best Perl programmer on the planet.</p>

<div class="highlight"><pre><code class="perl"><span class="c1">#!/usr/bin/env perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::</span><span class="n">Path</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Net::</span><span class="n">LDAP</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Data::</span><span class="n">Dumper</span><span class="p">;</span>

<span class="c1"># Config stuff</span>
<span class="k">my</span> <span class="nv">$base_dir</span> <span class="o">=</span> <span class="s">&quot;/usr/local/nagios/etc/cluenet/&quot;</span><span class="p">;</span>

<span class="c1"># Main code</span>
<span class="k">my</span> <span class="nv">$ldap</span> <span class="o">=</span> <span class="nn">Net::</span><span class="n">LDAP</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="s">&quot;ldap.cluenet.org&quot;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$ldap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Could not connect to ldap\n&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">print</span> <span class="s">&quot;Clearing current configs\n&quot;</span><span class="p">;</span>
<span class="n">rmtree</span><span class="p">(</span><span class="nv">$base_dir</span><span class="p">);</span>
<span class="nb">mkdir</span><span class="p">(</span><span class="nv">$base_dir</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">@admins</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">@owners</span> <span class="o">=</span> <span class="p">();</span>
<span class="k">my</span> <span class="nv">$mesg</span> <span class="o">=</span> <span class="nv">$ldap</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span>
    <span class="n">filter</span> <span class="o">=&gt;</span> <span class="s">&quot;(&amp;(objectClass=server)(isActive=TRUE))&quot;</span><span class="p">,</span>
    <span class="n">base</span> <span class="o">=&gt;</span> <span class="s">&quot;ou=servers,dc=cluenet,dc=org&quot;</span>
<span class="p">);</span>
<span class="k">my</span> <span class="nv">@entries</span> <span class="o">=</span> <span class="nv">$mesg</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;Starting server configs\n&quot;</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">@entries</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$entry</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
    <span class="k">print</span> <span class="s">&quot;Starting &quot;</span> <span class="o">.</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;cn&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$hostname</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;cn&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$hostname</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;Skipping - missing hostname\n&quot;</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$servername</span> <span class="o">=</span> <span class="nv">$hostname</span><span class="p">;</span>
    <span class="nv">$servername</span> <span class="o">=~</span> <span class="sr">s/\.cluenet\.org$//</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$owner</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">);</span>
    <span class="nv">$owner</span> <span class="o">=~</span> <span class="sr">s/uid=(.*),ou=people,dc=cluenet,dc=org/$1/</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$owner</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;Skipping - missing owner\n&quot;</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$ip_address</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;ipAddress&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$ip_address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&quot;Skipping - missing ip address\n&quot;</span><span class="p">;</span>
        <span class="k">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$ssh_port</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;sshPort&#39;</span><span class="p">);</span>

    <span class="k">my</span> <span class="nv">$description</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$description</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$description</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$os</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;operatingSystem&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$os</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$os</span> <span class="o">=</span> <span class="s">&#39;linux&#39;</span><span class="p">;</span> <span class="c1"># windows sux</span>
    <span class="p">}</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">FH</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;$base_dir/$hostname.cfg&quot;</span><span class="p">);</span>
    <span class="c1"># Write the host out</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">define</span> <span class="n">host</span> <span class="p">{</span>
    <span class="n">host_name</span> <span class="nv">$hostname</span>
    <span class="n">alias</span> <span class="nv">$servername</span>
    <span class="n">address</span> <span class="nv">$ip_address</span>
    <span class="n">hostgroups</span> <span class="nv">$owner</span><span class="o">\</span><span class="n">_servers</span>
    <span class="n">max_check_attempts</span> <span class="mi">5</span>
    <span class="n">check_period</span> <span class="mi">24</span><span class="n">x7</span>
    <span class="n">contacts</span> <span class="nv">$owner</span>
    <span class="n">contact_groups</span> <span class="nv">$servername</span><span class="o">\</span><span class="n">_admins</span>
    <span class="n">notification_period</span> <span class="mi">24</span><span class="n">x7</span>
<span class="p">}</span>

<span class="n">EOS</span>
<span class="p">;</span>

    <span class="c1"># Write out the services</span>
    <span class="c1"># - I&#39;d like these to be ldap attributes but I&#39;m not sure how we can do shit for now so hardcoding</span>
    <span class="k">print</span> <span class="s">&quot;Adding ping check\n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">define</span> <span class="n">service</span> <span class="p">{</span>
    <span class="n">host_name</span> <span class="nv">$hostname</span>
    <span class="n">service_description</span> <span class="n">PING</span> <span class="n">check</span>
    <span class="n">notification_period</span> <span class="mi">24</span><span class="n">x7</span>
    <span class="n">check_period</span> <span class="mi">24</span><span class="n">x7</span>
    <span class="n">max_check_attempts</span> <span class="mi">3</span>
    <span class="n">normal_check_interval</span> <span class="mi">5</span>
    <span class="n">retry_check_interval</span> <span class="mi">1</span>
    <span class="n">notification_interval</span> <span class="mi">30</span>
    <span class="n">notification_options</span> <span class="n">w</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">s</span>
    <span class="n">check_command</span> <span class="n">check_ping</span><span class="o">!</span><span class="mf">100.0</span><span class="p">,</span><span class="mi">20</span><span class="nv">%</span><span class="err">!</span><span class="nv">500</span><span class="mf">.00</span><span class="p">,</span><span class="mi">60</span><span class="nv">%</span>
<span class="err">}</span>

<span class="nv">EOS</span>
<span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">grep</span><span class="p">(</span><span class="sr">/windows/i</span><span class="p">,</span> <span class="nv">$os</span><span class="p">))</span> <span class="p">{</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$ssh_port</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">print</span> <span class="s">&quot;Adding SSH check on port $ssh_port\n&quot;</span><span class="p">;</span>
            <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;authorizedAdministrator&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>
        <span class="nv">$user</span> <span class="o">=~</span> <span class="sr">s/uid=(.*),ou=people,dc=cluenet,dc=org/$1/</span><span class="p">;</span>
        <span class="nv">$members</span> <span class="o">=</span> <span class="nv">$members</span> <span class="o">.</span> <span class="s">&quot;, &quot;</span> <span class="o">.</span> <span class="nv">$user</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">grep</span><span class="p">(</span><span class="sr">/$user/</span><span class="p">,</span> <span class="nv">@admins</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">push</span><span class="p">(</span><span class="nv">@admins</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;cn&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">print</span> <span class="s">&quot;Finished server configs\n&quot;</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;Starting user config\n&quot;</span><span class="p">;</span>
<span class="nb">open</span><span class="p">(</span><span class="n">FH</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;$base_dir/users.cfg&quot;</span><span class="p">);</span>
<span class="k">print</span> <span class="s">&quot;Adding __nagiosbot__\n&quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">define</span> <span class="n">contact</span> <span class="p">{</span>
    <span class="n">contact_name</span> <span class="n">__nagiosbot__</span>
    <span class="n">alias</span> <span class="n">General</span> <span class="n">nagios</span> <span class="n">bot</span>
    <span class="n">host_notification_period</span> <span class="mi">24</span><span class="n">x7</span>
    <span class="n">service_notification_period</span> <span class="mi">24</span><span class="n">x7</span>
    <span class="n">host_notification_commands</span> <span class="n">host</span><span class="o">-</span><span class="n">notify</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">irc</span>
    <span class="n">service_notification_commands</span> <span class="n">notify</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">irc</span>

<span class="p">}</span>
<span class="n">EOS</span>
<span class="p">;</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">@admins</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Adding user $_ \n&quot;</span><span class="p">;</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">search</span><span class="p">(</span>
        <span class="n">filter</span> <span class="o">=&gt;</span> <span class="s">&quot;(&amp;(objectClass=person)(uid=&quot;</span> <span class="o">.</span> <span class="nv">$_</span> <span class="o">.</span> <span class="s">&quot;))&quot;</span><span class="p">,</span>
        <span class="n">base</span> <span class="o">=&gt;</span> <span class="s">&quot;ou=people,dc=cluenet,dc=org&quot;</span>
    <span class="p">);</span>

    <span class="k">foreach</span><span class="p">(</span><span class="nv">$mesg</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$entry</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">;</span>

        <span class="k">my</span> <span class="nv">$gecos</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;gecos&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$gecos</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">print</span> <span class="n">FH</span> <span class="s">&quot;\talias $gecos\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">my</span> <span class="nv">$mail</span> <span class="o">=</span> <span class="nv">$entry</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="s">&#39;mail&#39;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$mail</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">print</span> <span class="n">FH</span> <span class="s">&quot;#\temail $mail\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="p">}</span>

<span class="n">EOS</span>
<span class="p">;</span>
<span class="p">}</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">@owners</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="n">FH</span> <span class="o">&lt;</span><span class="n">define</span> <span class="n">hostgroup</span> <span class="p">{</span>
    <span class="n">hostgroup_name</span> <span class="nv">$_</span><span class="o">\</span><span class="n">_servers</span>
    <span class="n">alias</span> <span class="nv">$_</span><span class="o">\</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">servers</span>
<span class="p">}</span>

<span class="n">EOS</span>
<span class="p">;</span>
<span class="p">}</span>

<span class="nb">close</span><span class="p">(</span><span class="n">FH</span><span class="p">);</span>
<span class="k">print</span> <span class="s">&quot;Finished user config\n&quot;</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;Reloading\n&quot;</span><span class="p">;</span>
<span class="sb">`/etc/init.d/nagios reload`</span>
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/example-of-building-nagios-configs-from-ldap#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/download-festival-hack">Download festival hack</a></h1>
	    <div class="entry">
	        <p>I didn't make it to download this year but the pictures look awesome, before they disappear into nowhere I wanted to grab a copy so I hacked up a bit of python to do some scraping and it works (not very well, but it was more of a 5min thing rather than a let's make a good job of it thing.). Script is as below:</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Uber hack to download images from download website, kinda works.</span>
<span class="sd">Very messy as I ripped most the code out of other scripts I&#39;ve written.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">from</span> <span class="nn">BeautifulSoup</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="s">&#39;/home/damian/Pictures/download-2011&#39;</span>

<span class="k">def</span> <span class="nf">get_total_pages</span><span class="p">():</span>
 <span class="n">uh</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://photos.downloadfestival.co.uk/view/&quot;</span><span class="p">)</span>
 <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span>
 <span class="n">uh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">count</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;class&quot;</span><span class="p">:</span> <span class="s">&quot;page_count&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
 <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Page 1 of &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
 <span class="k">return</span> <span class="n">count</span>

<span class="k">def</span> <span class="nf">get_images</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
 <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
 <span class="n">uh</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&quot;http://photos.downloadfestival.co.uk/view/?page=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">page</span><span class="p">)</span>
 <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">uh</span><span class="p">)</span>
 <span class="n">uh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ul&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;class&quot;</span><span class="p">:</span> <span class="s">&quot;item_list&quot;</span><span class="p">})</span>
 <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&quot;li&quot;</span><span class="p">):</span>
 <span class="n">image</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="s">&#39;src&#39;</span><span class="p">]</span>
 <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">images</span>

<span class="k">class</span> <span class="nc">Runner</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
 <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
 <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
 <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
 <span class="n">urldata</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">urldata</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
 <span class="n">file_name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="n">ext</span><span class="p">)</span>
 <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

<span class="n">uh</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
 <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
 <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">uh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
 <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 <span class="n">uh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
 <span class="k">print</span> <span class="s">&quot;Downloaded image to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">file_path</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
 <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
 <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>

<span class="n">total</span> <span class="o">=</span> <span class="n">get_total_pages</span><span class="p">()</span>
 <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> pages found&quot;</span> <span class="o">%</span> <span class="n">total</span>
 <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
 <span class="k">print</span> <span class="s">&quot;Processing page </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">p</span>
 <span class="n">i</span> <span class="o">=</span> <span class="n">get_images</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;Found </span><span class="si">%d</span><span class="s"> images&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
 <span class="n">images</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

 <span class="k">print</span> <span class="s">&quot;Downloading </span><span class="si">%d</span><span class="s"> images&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
 <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
 <span class="n">thread</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
 <span class="n">thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
 <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
 <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
 <span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/download-festival-hack#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>python</a>
	            
	            <a class='tag' href=''>scraper</a>
	            

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>General</a>
	            
	            <a class='category' href=''>How-to</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/06/configuring-a-cisco-1700-series-access-router-for-an-adsl-connection-with-tunneled-ipv6">Configuring a Cisco 1700 series access router for an ADSL connection with tunneled IPv6</a></h1>
	    <div class="entry">
	        <p>I decided to re-configure my home router from scratch so that I could tidy up the config and ACLs which had been messily generated over time.</p>

<p>The main reason being my old IPv6 ACLs pretty much where non-existent and before properly configuring my lan for auto assigning v6 IPs, I wanted to limit the incoming traffic.</p>

<p>I've included an example config below with comments</p>

<p>I might update it to support VPN connections rather than tunnelling them though to a openvpn box, but openvpn + SSL certs just work for when I want lan access (not that often..). For the rest of the time just plain old SSH with a little tunnelling where needed does the job.
One thing that does need doing is sending the system logs over to the syslog box - Currently things like NAT table overflow warnings just spam the console. Once I get a bit of time to re-configure rancid I'll start playing with the configs, for now they work just fine.</p>

	    </div>

	    <div class="meta">
	        <div class="date">28 Jun 2011</div>
 			<span class="comments">
 				<a href="/2011/06/configuring-a-cisco-1700-series-access-router-for-an-adsl-connection-with-tunneled-ipv6#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>Cisco 1700</a>
	            
	            <a class='tag' href=''>cisco</a>
	            

	        	
	            <a class='category' href=''>Security</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/04/wordpress-plugin">Wordpress plugin</a></h1>
	    <div class="entry">
	        

	    </div>

	    <div class="meta">
	        <div class="date">09 Apr 2011</div>
 			<span class="comments">
 				<a href="/2011/04/wordpress-plugin#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2011/03/canhazip">canhazip</a></h1>
	    <div class="entry">
	        <p>I was a little bored this afternoon so made <a href="http://canhazip.info">canhazip.info</a>! Inspired by the awesome service <a href="http://icanhazip.com/">icanhazip.com</a> run by <a href="http://rackerhacker.com/">RackerHacker</a>, it basically does the same thing but there are some differences.</p>

<h4>Basic Usage</h4>

<p><a href="http://canhazip.info/">http://canhazip.info/</a></p>

<p>This will return your public IP - if you have dual stack (IPv4 and IPv6) then it will return your v6 address.</p>

<h4>Specific IP type</h4>

<p><a href="http://ipv4.canhazip.info/">http://ipv4.canhazip.info/</a></p>

<p>This will return your public IPv4 address if you are have a working one, else it will time-out (uses an A record).</p>

<p><a href="http://ipv6.canhazip.info/">http://ipv6.canhazip.info/</a></p>

<p>This will return your public IPv6 address if you are have a working one, else it will time-out (uses an AAAA record).</p>

<h4>Output format</h4>

<p>By default the output will be plain text however you can optionally pass a format to be returned. To pass a format simply add /<your format>
to the end of the URL.</p>

<p>Accepted formats are:</p>

<ul>
<li><p>xml</p></li>
<li><p>json</p></li>
<li><p>yaml</p></li>
<li><p>php (serialize of an array)</p></li>
<li><p>plain</p></li>
</ul>


<p>Example usage:</p>

<p><a href="http://canhazip.info/xml">http://canhazip.info/xml</a></p>

<h4>FAQ</h4>

<h5>icanhazip exists, why another service that does the same thing?</h5>

<ol>
<li><p>Because I can</p></li>
<li><p>Because .info domains were on special offer ($1.87!)</p></li>
<li><p>The servers hosting the site are in London and Manchester not the US (latency)</p></li>
<li><p>The secondary service I was using previously no longer exists (I like basic redundancy)</p></li>
</ol>


<h5>Do you keep logs</h5>

<p>I have logs from the web server which I keep for a few days just in case there is any abuse. These are not shared with anyone and access to the server is heavily restricted.</p>

<h5>Why different formats?</h5>

<p>For developers wanting more than plain text. I plan to add in extended information such as GeoIP and the option to specify an IP to get the info for. This will appear in time as I get randomly bored.</p>

<h5>Is this reliable</h5>

<p>I make no guarantee but the 2 servers are split between two data centres with multiple A/AAAA records per name. The NS servers are also split between 3 providers and in total there are 7.</p>

<h5>Example usage</h5>

<p>(I currently use this to keep my TunnelBroker endpoint updated) - It could probably be done much nicer but this kinda just works.</p>

<div class="highlight"><pre><code class="php"><span class="x">#!/usr/bin/php</span>
<span class="cp">&lt;?php</span>
 <span class="nv">$PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
 <span class="nv">$TUNNELID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nv">$USERID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
 <span class="nv">$currentIP</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;http://ipv4.canhazip.info/&#39;</span><span class="p">);</span>
 <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">)){</span>
 <span class="nv">$currentIP</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;http://ipv4.icanhazip.com/&#39;</span><span class="p">);</span>
 <span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">)){</span>
 <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Could not get current IP&#39;</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
 <span class="p">}</span>

<span class="nv">$currentIP</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">);</span>
 <span class="nv">$return</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;https://ipv4.tunnelbroker.net/ipv4_end.php?ipv4b=&quot;</span> <span class="o">.</span> <span class="nv">$currentIP</span> <span class="o">.</span> <span class="s2">&quot;&amp;pass=&quot;</span> <span class="o">.</span> <span class="nv">$PASSWORD</span> <span class="o">.</span> <span class="s2">&quot;&amp;user_id=&quot;</span> <span class="o">.</span> <span class="nv">$USERID</span> <span class="o">.</span> <span class="s2">&quot;&amp;tunnel_id=&quot;</span> <span class="o">.</span> <span class="nv">$TUNNELID</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$return</span><span class="p">,</span> <span class="s2">&quot;That IPv4 endpoint is already in use.&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">False</span><span class="p">){</span>
 <span class="k">print</span> <span class="s2">&quot;IP has not changed&quot;</span><span class="p">;</span>
 <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
 <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$return</span><span class="p">,</span> <span class="s2">&quot;Your tunnel endpoint has been updated to:&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">False</span><span class="p">){</span>
 <span class="k">print</span> <span class="s2">&quot;Tunnel endpoint has been updated&quot;</span><span class="p">;</span>
 <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
 <span class="k">print</span> <span class="s2">&quot;Unknown return!?!?!&quot;</span><span class="p">;</span>
 <span class="k">print</span> <span class="nv">$return</span><span class="p">;</span>
 <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
 <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>


<h5>Another example</h5>

<p>Basic screen scraping example (I use this to keep my Cluenet VPN endpoint updated)</p>

<div class="highlight"><pre><code class="php"><span class="x">#!/usr/bin/php</span>
<span class="cp">&lt;?php</span>
 <span class="nv">$ACCESSKEY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
 <span class="nv">$NODENAME</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

<span class="nv">$currentIP</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;http://ipv4.canhazip.info/&#39;</span><span class="p">);</span>
 <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">)){</span>
 <span class="nv">$currentIP</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;http://ipv4.icanhazip.com/&#39;</span><span class="p">);</span>
 <span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">)){</span>
 <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Could not get current IP&#39;</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
 <span class="p">}</span>

<span class="nv">$currentIP</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$currentIP</span><span class="p">);</span>
 <span class="nv">$bnlTable</span> <span class="o">=</span> <span class="o">@</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;http://a.core.cluenet.org/main/cluevpnpanel.php?page=printbnl&#39;</span><span class="p">);</span>
 <span class="nv">$bnlTable</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;&lt;table border=6 class=\&quot;wikitable sortable\&quot;&gt;&#39;</span><span class="p">,</span> <span class="nv">$bnlTable</span><span class="p">);</span> <span class="nv">$bnlTable</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="nv">$bnlTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="nv">$bnlTable</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$bnlTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="nv">$bnlTable</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">,</span> <span class="nv">$bnlTable</span><span class="p">);</span> <span class="nb">unset</span><span class="p">(</span><span class="nv">$bnlTable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="nb">unset</span><span class="p">(</span><span class="nv">$bnlTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
 <span class="nv">$nodes</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="k">foreach</span><span class="p">(</span><span class="nv">$bnlTable</span> <span class="k">as</span> <span class="nv">$entry</span><span class="p">){</span>
 <span class="nv">$entry</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">$entry</span><span class="p">);</span> <span class="nv">$entry</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;&lt;td align=center&gt;&#39;</span><span class="p">,</span> <span class="nv">$entry</span><span class="p">);</span>
 <span class="nv">$nodes</span><span class="p">[</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$entry</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
 <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
 <span class="s1">&#39;ip&#39;</span> <span class="o">=&gt;</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$entry</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
 <span class="s1">&#39;ipv6′ =&gt; trim($entry[4]),</span>
<span class="s1"> &#39;</span><span class="nx">port</span><span class="s1">&#39; =&gt; trim($entry[5]),</span>
<span class="s1"> &#39;</span><span class="nx">ipv6pref</span><span class="s1">&#39; =&gt; trim($entry[6]),</span>
<span class="s1"> &#39;</span><span class="nx">subnet</span><span class="s1">&#39; =&gt; trim($entry[7]),</span>
<span class="s1"> );</span>
<span class="s1"> }</span>

<span class="s1">$currentVPNIP = $nodes[$NODENAME][&#39;</span><span class="nx">ip</span><span class="s1">&#39;];</span>
<span class="s1"> if($currentIP != $currentVPNIP){</span>
<span class="s1"> /* Update IP */</span>
<span class="s1"> $ch = curl_init (&quot;http://a.core.cluenet.org/main/cluevpnpanel.php?page=updateiphandle&quot;);</span>
<span class="s1"> curl_setopt($ch, CURLOPT_COOKIE, &#39;</span><span class="nx">clueauth_tokenstack</span><span class="o">=</span><span class="s1">&#39;.$ACCESSKEY);</span>
<span class="s1"> curl_setopt($ch, CURLOPT_POSTFIELDS, &#39;</span><span class="nx">nodename</span><span class="o">=</span><span class="s1">&#39;.$NODENAME.&#39;</span><span class="o">&amp;</span><span class="nx">newip</span><span class="o">=</span><span class="s1">&#39;.$currentIP.&#39;</span><span class="o">&amp;</span><span class="nx">newport</span><span class="o">=</span><span class="mi">3406</span><span class="o">&amp;</span><span class="nx">submit</span><span class="o">=</span><span class="nx">Change</span><span class="s1">&#39;);</span>
<span class="s1"> curl_setopt($ch, CURLOPT_POST, 1);</span>
<span class="s1"> curl_setopt ($ch, CURLOPT_RETURNTRANSFER, true);</span>
<span class="s1"> $output = curl_exec ($ch);</span>

<span class="s1">if(strpos($output, &#39;</span><span class="nx">Success</span><span class="o">.</span><span class="s1">&#39;) != 0){</span>
<span class="s1"> die(&#39;</span><span class="nx">IP</span> <span class="nx">Updated</span> <span class="nx">Successfully</span><span class="s1">&#39;.&quot;\n&quot;);</span>
<span class="s1"> }else{</span>
<span class="s1"> die(&#39;</span><span class="nx">IP</span> <span class="k">Not</span> <span class="nx">Updated</span> <span class="nx">Successfully</span><span class="s1">&#39;.&quot;\n&quot;);</span>
<span class="s1"> }</span>
<span class="s1"> }else{</span>
<span class="s1"> die(&#39;</span><span class="nx">IP</span> <span class="nx">has</span> <span class="k">not</span> <span class="nx">changed</span><span class="err">&#39;</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
 <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">30 Mar 2011</div>
 			<span class="comments">
 				<a href="/2011/03/canhazip#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>Work</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/12/unix-time-to-human-readable">Unix time to human readable?</a></h1>
	    <div class="entry">
	        <p>You can quickly convert Unix time to a human readable format by using the date command. This proves to be very helpful for bash scripts etc when you don't feel like calling out to Perl.</p>

<p>Quick example:</p>

<div class="highlight"><pre><code class="bash">root@localhost <span class="o">[</span>/<span class="o">]</span><span class="c"># date -d @1290705757</span>
Thu Nov 25 18:22:37 CET 2010
</code></pre>
</div>


<p>You can also format the output of date to suit your needs, for example:</p>

<div class="highlight"><pre><code class="bash">root@localhost <span class="o">[</span>/<span class="o">]</span><span class="c"># date -d@1290705757 +&quot;%H:%M:%S %d/%m/%Y&quot;</span>
18:22:37 25/11/2010
</code></pre>
</div>


<p>As expect this can very easily be scripted for example I was checking create times on some cPanel accounts:</p>

<div class="highlight"><pre><code class="bash">root@localhost <span class="o">[</span>/var/cpanel/users<span class="o">]</span><span class="c"># for user in *; do echo -n &quot;$user: &quot;; date -d@$(grep STARTDATE $user | cut -d’=’ -f2); done</span>
damian: Thu Nov 18 21:17:44 CET 2010
<span class="nb">test</span>: Mon Nov 8 00:01:04 CET 2010
bob: Mon Nov 15 17:34:18 CET 2010
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">12 Dec 2010</div>
 			<span class="comments">
 				<a href="/2010/12/unix-time-to-human-readable#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>Knowledge Base</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/12/system-activity-reporter">System activity reporter</a></h1>
	    <div class="entry">
	        <p>Ever wanted to be able to get historical performance data on your linux system without setting up an entire rrd based graphing system? Maybe you don't even want graphs you just want to know that if needed you can find out what your memory usage was last week.</p>

<p>A nice simple program is the system activity reporter or SAR.</p>

<p>To get started you'll want to install and start sysstat, on a centos box this can be done as below:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># Make sure the system is up to date</span>
yum update

<span class="c"># Install the sysstat program (includes sar and iostat)</span>
sudo yum install sysstat

<span class="c"># Make sure sysstat is enabled</span>
chkconfig sysstat on

<span class="c"># Start sysstat – this starts the system activity data collector</span>
service sysstat start
</code></pre>
</div>


<p>Ok once we have sysstat installed there are a few programs we can use to get performance data, iostat and sar (there are loads of other things such as mpstat, pidstat, nfsiostat, cifsiostat etc but for this post I'll only be covering the 2). I'll give you some basic examples of what we can do with these tools but they are very extensive so I suggest that you check out the man pages (man sar + man iostat)</p>

<p><strong>IOStat</strong></p>

<p>iostat is mainly for reporting CPU statistics and input/output statistics for devices/partitions. Some examples of this can be seen below:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@xxx ~<span class="o">]</span><span class="c"># iostat</span>
Linux my.kernel.version <span class="o">(</span>my.hostname<span class="o">)</span> 12/07/10
avg-cpu: %user %nice %system %iowait %steal %idle
0.35 0.00 0.19 0.61 0.01 98.84
Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 11.04 174.56 96.57 1575022426 871286088
xvdb 0.92 14.90 10.14 134403952 91524480
xvdc 0.91 12.16 10.53 109676480 95014488
</code></pre>
</div>


<p>The above output is avg history since last boot, now if your debugging a current issue on the system this probably isin't helpful to you so lets get the current values at 2 second intervals instead:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@xxx ~<span class="o">]</span><span class="c"># iostat -d 2</span>
Linux my.kernel.version <span class="o">(</span>my.hostname<span class="o">)</span> 12/07/10
avg-cpu: %user %nice %system %iowait %steal %idle
0.35 0.00 0.19 0.61 0.01 98.84
Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 11.04 174.56 96.57 1575022426 871286088
xvdb 0.92 14.90 10.14 134403952 91524480
xvdc 0.91 12.16 10.53 109676480 95014488

Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 0.00 0.00 0.00 0 0
xvdb 0.00 0.00 0.00 0 0
xvdc 0.00 0.00 0.00 0 0

Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 0.00 0.00 0.00 0 0
xvdb 0.00 0.00 0.00 0 0
xvdc 0.00 0.00 0.00 0 0
</code></pre>
</div>


<p>This output actually just carries on adding a new entry every 2 seconds, to limit the entries then just specify the number as below:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@xxx ~<span class="o">]</span><span class="c"># iostat -d 2 2</span>
Linux my.kernel.version <span class="o">(</span>my.hostname<span class="o">)</span> 12/07/10
avg-cpu: %user %nice %system %iowait %steal %idle
0.35 0.00 0.19 0.61 0.01 98.84
Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 11.04 174.56 96.57 1575022426 871286088
xvdb 0.92 14.90 10.14 134403952 91524480
xvdc 0.91 12.16 10.53 109676480 95014488

Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
xvda 0.00 0.00 0.00 0 0
xvdb 0.00 0.00 0.00 0 0
xvdc 0.00 0.00 0.00 0 0
</code></pre>
</div>


<p>As you can see this testing vm is actually currently doing nothing but if I run this on a production machine you can see why this information is helpful for spotting bottle necks etc:</p>

<div class="highlight"><pre><code class="bash">root@xxx:~# iostat -d 2 2
Linux my.kernel.version <span class="o">(</span>my.hostname<span class="o">)</span> 12/07/10 _x86_64_

Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
sda 31.14 411.84 757.85 1890371422 3478544478
sda1 31.01 409.90 755.62 1881435002 3468289496
sdb 9.97 88.27 303.57 405165646 1393372152
sdb1 9.97 88.27 303.57 405164878 1393372152
sdc 7.54 57.13 131.10 262215600 601759006
sdc1 7.54 57.13 131.10 262214832 601759006

Device: tps Blk_read/s Blk_wrtn/s Blk_read Blk_wrtn
sda 269.00 4.00 5968.00 8 11936
sda1 269.00 4.00 5968.00 8 11936
sdb 15.00 8.00 416.00 16 832
sdb1 15.00 8.00 416.00 16 832
sdc 71.00 12.00 752.00 24 1504
sdc1 71.00 12.00 752.00 24 1504
</code></pre>
</div>


<p>Yes I know I started talking about memory, cpu etc at the start of this post but you should care about your disks too! Anyway onto sar..</p>

<p><strong>System activity reporter (Sar)</strong>
As the name suggests it's not for reporting io data, it is mainly for reporting system data. What do we mean by "system data"? Well this covers lots of things such as:</p>

<ul>
<li><p>CPU</p></li>
<li><p>Load avg</p></li>
<li><p>Memory usage</p></li>
<li><p>Inode/file/kernel table usage</p></li>
<li><p>Swapping stats</p></li>
<li><p>Process statistics</p></li>
<li><p>TTY device activity</p></li>
<li><p>Much much more....</p></li>
</ul>


<p>Some common things your probably want to look at;
CPU usage:</p>

<div class="highlight"><pre><code class="bash">sar -u
</code></pre>
</div>


<p>Memory usage:</p>

<div class="highlight"><pre><code class="bash">sar -r
</code></pre>
</div>


<p>Load avg (and queue length):</p>

<div class="highlight"><pre><code class="bash">sar -q
</code></pre>
</div>


<p>Now without any other options sar is going to return you information from the current sar file, to get a different days content then specify the file.</p>

<p>Today is the 7th, say I wanted to see CPU data for yesterday I would run:</p>

<div class="highlight"><pre><code class="bash">sar -s -f /var/log/sa/sa06
</code></pre>
</div>


<p>Now depending on what data you are requesting (please read the man page on what data you can retrive and how you can format it, I am refering to the defaults!) the output will vary, example output for CPU data is as follows:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@xxx~<span class="o">]</span><span class="c"># sar -s | head</span>
Linux my.kernel.version <span class="o">(</span>my.hostname<span class="o">)</span> 12/07/10

08:00:01 CPU %user %nice %system %iowait %steal %idle
08:10:01 all 0.61 0.00 0.40 0.14 0.08 98.78
08:20:01 all 0.29 0.00 0.28 0.01 0.01 99.41
08:30:01 all 0.23 0.00 0.25 0.01 0.01 99.50
08:40:01 all 0.56 0.00 0.36 0.07 0.01 99.00
08:50:01 all 0.29 0.00 0.28 0.04 0.01 99.39
09:00:01 all 0.21 0.00 0.26 0.02 0.01 99.50
09:10:01 all 0.66 0.00 0.41 0.34 0.03 98.57
</code></pre>
</div>


<p><strong>But I want some graphs!</strong>
Awesome, let's make some using gnuplot! We are going to use sadf, this is a program that lets us format/display sar data in different formats really easily.
You like excel? I'm sorry to hear that, here is an example of outputting cpu idle data in csv form anyway (just to keep you happy):</p>

<div class="highlight"><pre><code class="bash">sadf -- -u | awk <span class="s1">&#39;/%idle/ {print $3&quot;,&quot;$6}&#39;</span>
</code></pre>
</div>


<p>Anyway for those geeks among us lets make some pretty stuff in gnuplot:</p>

<div class="highlight"><pre><code class="bash"><span class="c"># Make a tmp file</span>
<span class="nv">cpu_data_file</span><span class="o">=</span><span class="k">$(</span>mktemp /tmp/cpu_data.XXX<span class="k">)</span>;
<span class="c"># Fill the file with stuff</span>
sadf -- -u | awk <span class="s1">&#39;/%idle/ {print $3&quot; &quot;$6}&#39;</span> &gt; <span class="nv">$cpu_data_file</span>
<span class="c"># Make a pretty graph</span>
<span class="nb">echo</span> <span class="s2">&quot;set terminal dump;</span>
<span class="s2">set title &#39;CPU usage&#39;;</span>
<span class="s2">set xdata time;</span>
<span class="s2">set timefmt &#39;%s&#39;;</span>
<span class="s2">set xlabel &#39;Time&#39;;</span>
<span class="s2">plot &#39;$cpu_data_file&#39; using 1:2 with lines title &#39;CPU usage&#39;;&quot;</span> | gnuplot
<span class="c"># Remove tmp file</span>
rm -f <span class="nv">$cpu_data_file</span>
</code></pre>
</div>


<p>If your not a ASCII type of guy then change set terminal dump; to set terminal png; and pipe the output to file for some nice images.</p>

<p>If your interested then I hacked up a quick example of making graphs for displaying on the web:</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c"># sar_graph.sh - Makes pretty web pages from sar</span>
<span class="c"># Written by Damian Zaremba - Released under GPLv3</span>
<span class="c">#</span>
<span class="c"># Please note this is a quick hack to demonstrate it can be done</span>
<span class="c"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

<span class="nv">GNU_PLOT</span><span class="o">=</span><span class="k">$(</span>whereis gnuplot | cut -d<span class="s1">&#39; &#39;</span> -f2<span class="k">)</span>
<span class="nv">SADF</span><span class="o">=</span><span class="k">$(</span>whereis sadf | cut -d<span class="s1">&#39; &#39;</span> -f2<span class="k">)</span>
<span class="nv">GRAPH_TYPE</span><span class="o">=</span><span class="s2">&quot;image&quot;</span>
<span class="c">#GRAPH_TYPE=&quot;ascii&quot;</span>
<span class="nv">HTML_DST</span><span class="o">=</span><span class="s2">&quot;/var/www/vhosts/stuff.damianzaremba.co.uk/public/sar_graph/&quot;</span>
<span class="nv">POST_COMMANDS</span><span class="o">=</span><span class="s1">&#39;chown www-server:www-data -R &#39;</span><span class="nv">$HTML_DST</span>

<span class="c"># Check gnuplot is all good</span>
<span class="k">if</span> <span class="o">[</span> ! -x <span class="s2">&quot;$GNU_PLOT&quot;</span> <span class="o">]</span>;
<span class="k">then</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Please ensure gnuplot is avaible on \$PATH&quot;</span>
 <span class="nb">exit </span>1;
<span class="k">fi</span>

<span class="c"># Check sadf is all good</span>
<span class="k">if</span> <span class="o">[</span> ! -x <span class="s2">&quot;$SADF&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Please ensure sadf is avaible on \$PATH&quot;</span>
 <span class="nb">exit </span>1;
<span class="k">fi</span>

<span class="c"># Check graph type</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;image&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> !<span class="o">=</span> <span class="s2">&quot;ascii&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Invalid graph type specified&quot;</span>
 <span class="nb">exit </span>1;
<span class="k">fi</span>

<span class="c"># Some functions for writing out the html, just incase you ever want to make it pretty or something..</span>
<span class="k">function </span>make_header <span class="o">{</span>
 <span class="nv">HTML</span><span class="o">=</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Sar graphs!&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span><span class="nv">$HTML</span>;
<span class="o">}</span>

<span class="k">function </span>make_footer <span class="o">{</span>
 <span class="nv">HTML</span><span class="o">=</span><span class="nv">$HTML</span><span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>;
<span class="o">}</span>

<span class="k">function </span>make_graph <span class="o">{</span>
 <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>; <span class="k">then return </span>1; <span class="k">else </span><span class="nv">title</span><span class="o">=</span><span class="nv">$1</span>; <span class="k">fi</span>
<span class="k"> if</span> <span class="o">[</span> -z <span class="s2">&quot;$2&quot;</span> <span class="o">]</span>; <span class="k">then return </span>1; <span class="k">else </span><span class="nv">format</span><span class="o">=</span><span class="nv">$2</span>; <span class="k">fi</span>
<span class="k"> if</span> <span class="o">[</span> -z <span class="s2">&quot;$3&quot;</span> <span class="o">]</span>; <span class="k">then return </span>1; <span class="k">else </span><span class="nv">field</span><span class="o">=</span><span class="nv">$3</span>; <span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Making $title&quot;</span>
 <span class="nv">output_file</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$title</span> | sed <span class="s1">&#39;s/ /_/g&#39;</span><span class="k">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="o">]</span>;
 <span class="k">then</span>
<span class="k"> </span><span class="nv">output_format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span>
 <span class="nv">output_file</span><span class="o">=</span><span class="nv">$output_file</span><span class="s2">&quot;.png&quot;</span>
 <span class="k">else</span>
<span class="k"> if</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;ascii&quot;</span> <span class="o">]</span>
 <span class="k">then</span>
<span class="k"> </span><span class="nv">output_format</span><span class="o">=</span><span class="s2">&quot;dumb&quot;</span>
 <span class="nv">output_file</span><span class="o">=</span><span class="nv">$output_file</span><span class="s2">&quot;.txt&quot;</span>
 <span class="k">fi</span>
<span class="k"> fi</span>

<span class="nv">output_path</span><span class="o">=</span><span class="nv">$HTML_DST</span><span class="s2">&quot;/&quot;</span><span class="nv">$output_file</span>
 <span class="nv">dat_file</span><span class="o">=</span><span class="k">$(</span>mktemp /tmp/sar_graph.XXX<span class="k">)</span>
 <span class="nb">echo</span> <span class="s2">&quot;Data file: $dat_file&quot;</span>
 <span class="nv">$SADF</span> -- <span class="nv">$format</span> | awk <span class="s1">&#39;/&#39;</span><span class="nv">$field</span><span class="s1">&#39;/ {print $3&quot; &quot;$6}&#39;</span> &gt; <span class="nv">$dat_file</span>

<span class="nb">echo</span> <span class="s2">&quot;set terminal $output_format;</span>
<span class="s2"> set title &#39;$title&#39;;</span>
<span class="s2"> set xdata time;</span>
<span class="s2"> set timefmt &#39;%s&#39;;</span>
<span class="s2"> set xlabel &#39;Time&#39;;</span>
<span class="s2"> plot &#39;$dat_file&#39; using 1:2 with lines title &#39;$title&#39;;&quot;</span> | <span class="nv">$GNU_PLOT</span> &gt; <span class="nv">$output_path</span>
 <span class="nb">echo</span> <span class="s2">&quot;Outputted $output_file&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="o">]</span>;
 <span class="k">then</span>
<span class="k"> </span><span class="nv">HTML</span><span class="o">=</span><span class="nv">$HTML</span><span class="s1">&#39;&lt;img src=&quot;&#39;</span><span class="nv">$output_file</span><span class="s1">&#39;&quot; alt=&quot;&#39;</span><span class="nv">$title</span><span class="s1">&#39;&quot; /&gt;&#39;</span>
 <span class="k">else</span>
<span class="k"> if</span> <span class="o">[</span> <span class="s2">&quot;$GRAPH_TYPE&quot;</span> <span class="o">==</span> <span class="s2">&quot;ascii&quot;</span> <span class="o">]</span>
 <span class="k">then</span>
<span class="k"> </span><span class="nv">HTML</span><span class="o">=</span><span class="nv">$HTML</span><span class="s1">&#39;&lt;iframe src=&quot;&#39;</span><span class="nv">$output_file</span><span class="s1">&#39;&quot; width=&quot;650px&quot; height=&quot;350px&quot; scrolling=&quot;no&quot;&gt;&lt;/iframe&gt;&#39;</span>
 <span class="k">fi</span>
<span class="k"> fi</span>
<span class="o">}</span>

<span class="c"># Main script stuff</span>
<span class="nb">test</span> -d <span class="s2">&quot;$HTML_DST&quot;</span> <span class="o">||</span> mkdir -p <span class="s2">&quot;$HTML_DST&quot;</span>
<span class="nv">HTML</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="c"># CPU stuff</span>
make_graph <span class="s2">&quot;CPU usage&quot;</span> <span class="s2">&quot;-u&quot;</span> <span class="s2">&quot;%idle&quot;</span>

<span class="c"># Swap stuff</span>
make_graph <span class="s2">&quot;Swap usage&quot;</span> <span class="s2">&quot;-r&quot;</span> <span class="s2">&quot;kbbuffers&quot;</span>

<span class="c"># 1min load avg</span>
make_graph <span class="s2">&quot;1min Load avg&quot;</span> <span class="s2">&quot;-q&quot;</span> <span class="s2">&quot;ldavg-1&quot;</span>

<span class="c"># Make the html index</span>
<span class="nb">echo</span> <span class="s2">&quot;Writing $HTML_DST/index.html&quot;</span>
make_header; make_footer
<span class="nb">echo</span> <span class="nv">$HTML</span> &gt; <span class="s2">&quot;$HTML_DST/index.html&quot;</span>

<span class="c"># Post stuff</span>
<span class="sb">`</span><span class="nv">$POST_COMMANDS</span><span class="sb">`</span>

<span class="c"># Tidy</span>
rm -rf <span class="s2">&quot;$base_dir&quot;</span>
</code></pre>
</div>




	    </div>

	    <div class="meta">
	        <div class="date">07 Dec 2010</div>
 			<span class="comments">
 				<a href="/2010/12/system-activity-reporter#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>FOSS</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/12/lots-of-files-to-remove">Lots of files to remove?</a></h1>
	    <div class="entry">
	        <p>So I recently have a few hundred thousand files in /tmp/ (was testing something and needed to remove them all)!</p>

<p>Bash as always is very helpful</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># rm -rf /tmp/*</span>
-bash: /bin/rm: Argument list too long”
</code></pre>
</div>


<p>You also have this issue? Don't worry you can use find and feed the results into rm as follows</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/ | xargs rm</span>
</code></pre>
</div>


<p>(You could also specify -type f or -type d if you only wanted files or directory, you may need rm -r rather than rm if you want to recurse into directories)</p>

<p>If you have seen the output of find previously you will know why this works, if not then here is a quick snippet:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/</span>
/tmp/repoup1291034701
/tmp/repoup1291034701/live
/tmp/repoup1291034701/live/.git
</code></pre>
</div>


<p>xargs just converts from standard input to command line arguments as can be seen below:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/ | head -n 1 | xargs echo rm</span>
rm /tmp/repoup1291034701
</code></pre>
</div>


<p>Hope this helps</p>

	    </div>

	    <div class="meta">
	        <div class="date">01 Dec 2010</div>
 			<span class="comments">
 				<a href="/2010/12/lots-of-files-to-remove#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>FOSS</a>
	            
	            <a class='category' href=''>How-to</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/11/compiling-nginx-and-php-fpm-on-centos-5">Compiling nginx and PHP-FPM on CentOS 5</a></h1>
	    <div class="entry">
	        <p><a href="http://lukecarrier.me/">Luke Carrier</a>, founder and lead developer at <a href="http://CloudFlux.net">CloudFlux</a> recently wrote a how-to on compiling Nginx and PHP-FPM (can be found <a href="http://lukecarrier.me/?p=59">here</a>). Nginx is well known for being a high-performance HTTP server and reverse proxy, in fact this very website is running on-top of Nginx. A few websites you might know that run Nginx are:</p>

<ul>
<li><p><a href="http://GitHub.com">GitHub</a></p></li>
<li><p><a href="http://Wordpress.com">Wordpress</a></p></li>
<li><p><a href="http://Ohloh.net">Ohloh</a></p></li>
<li><p><a href="http://CloudFlux.net">CloudFlux</a></p></li>
</ul>


<p>These sites show how Nginx can be deployed in many high traffic configurations, GitHub being well know for the use of RoR, Wordpress the use of PHP etc. Whether you are deploying PHP under FPM, RoR under Passenger, static files or data from memcached Nginx can outperform many other web servers.</p>

<p>The main advantage to using Nginx is it's event-driven (asynchronous) architecture, this means that alongside providing high-performance there is a small predictable memory footprint. All the features make the server a good performer in all environments from single VPS systems to web clusters.</p>

<p>Some features you'll probably love:</p>

<ul>
<li><p>Modules for load balancing</p></li>
<li><p>Direct memcached integration</p></li>
<li><p>Simple proxy configuration</p></li>
<li><p>Passenger integration</p></li>
<li><p>Ability to serve over 50,000 simultaneous connections</p></li>
<li><p>Statistics module</p></li>
<li><p>Low memory footprint</p></li>
<li><p>Clean simple to edit configuration files</p></li>
<li><p>Zero downtime configuration and binary updates</p></li>
<li><p>PCRE based rewrite rules</p></li>
</ul>


<p>As you can see from <a href="http://wiki.nginx.org/NginxWhyUseIt">their site</a> Nginx as a server is highly regarded and recommended. I'd suggest taking a look, having a play and revealing what it can do for you.</p>

	    </div>

	    <div class="meta">
	        <div class="date">29 Nov 2010</div>
 			<span class="comments">
 				<a href="/2010/11/compiling-nginx-and-php-fpm-on-centos-5#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>FOSS</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/10/job-change-house-move-and-more">Job change, house move and more</a></h1>
	    <div class="entry">
	        <p>So yeah it's been a busy few months. I've finished my new server setup, ready to move mail onto it. Moved flats. Made loads of progress in a project and got let go from a job.</p>

<p>I moved from Bury to Manchester a month ago, it's strange living in the city it's like the world never sleeps. Currently still have a messy flat as I haven't completely un-packed but things are getting there. Hopefully won't have to move any time soon as the last time was a bit of a nightmare. Moving into the center might help improve my current non existent social life or maybe just give me reason to be in an office 24/7 working (tbc). In other news the 7th A Rochdale scout groups website had a bunch of issues completed over the last few weeks, once the images are all done and I can write the actual text content then we should be good to get it online and hopefully expand the group even further! Shame I'm not the best designer but I should be able to do a better job than the current "made in word" version ;)</p>

<p>As well as all the fun times had recently I've also got a bit of a change work wise, after being "let go" from my current job at UKFast I've decided to try and find a small passionate company where I can really have an impact and do what I enjoy. Unfortunately the job I did have wasn't right for me as there was little room for diversity within the role or change.</p>

<p>Currently I'm looking for a passionate small/start-up company where I can utilize my current skills, learn a lot and dedicate my time to making a difference.</p>

<p>Thanks to everyone at UKFast for the fun times, advise and support. Maybe one day we will work together once again.</p>

	    </div>

	    <div class="meta">
	        <div class="date">06 Oct 2010</div>
 			<span class="comments">
 				<a href="/2010/10/job-change-house-move-and-more#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>7thA</a>
	            
	            <a class='tag' href=''>UKFast</a>
	            

	        	
	            <a class='category' href=''>Work</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/09/time">Time</a></h1>
	    <div class="entry">
	        <p>Time is a funny thing, in one sense you seem to achieve a lot in a short amount but from another point of view you haven't even dipped your toe into the water. School, college, unit is starting again with the people working hard to pass exams and start their lives, choices we make in life seem insignificant at the time however the time passes so quickly and you don't even realise it.</p>

<p>Personally I never did the whole college and uni thing, it is something that in one sense I regret but in another it's something I am proud of. The choice for me was simple, waste 5/6 years 'studying' things that weren't relevant to what I wanted to do to get a piece of paper and a few grand worth of debt or dive in at the deep end and try not to sink.</p>

<p>After leaving school I pretty much wasted a year, during the time I did pretty much run a small hosting company with some friends and decide on what I was going to do going forwards but all in all progress was not anything to comment on. After passing some random exams I got my current job and that’s where I'm pretty much at now looking forward to passing some other exams and progressing my career.</p>

<p>Tonight I've just been reminded that it was two years ago I left School where the projects ended and the search began, an analysis of the time spent since then yields mixed feelings. Bearing in mind I pretty much want to have filled most my career ambitions by the time I'm 20 I take the following from this reflection.</p>

<p>I regret not going to college/uni - This would of let me grow as a person however could of potentially prevented my career from starting and left me without the opportunities I'm currently chasing. The main disadvantages are not being able to socialize, gain experience in certain areas such as student radio that I would of loved to have been a part of.</p>

<p>I'm glad I went the hard way - Life's value is clear to me now, you have to run at every opportunity you get and never let one pass you buy. With confidence you can be much better than you currently think you are.  If I didn't chose the path I did then I most likely would not be sat in my of flat across the road from the office where I work as a Linux engineer and I wouldn't have the opportunities presented to me that I do right at this very moment.</p>

<p>Time moves so very quickly and you don't often stop to think about what you have achieved. It is easy to see how far you have to go to meet your goal and think there is never any chance of hitting them but if you step back for a moment and look at where you have been and how far you have travelled then you can see there is every chance of smashing your goals.</p>

<p>Slight ramble but the general point being never let anyone tell you that you can't do something, there is always a way even if you have to fight against everyone to get there. Opportunities will present themselves when needed and belief is something you should never change for other people. Time will run away from you but every so often step back and look at how much you've done - it will be amazing.</p>

	    </div>

	    <div class="meta">
	        <div class="date">14 Sep 2010</div>
 			<span class="comments">
 				<a href="/2010/09/time#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/07/powershell">Powershell!?!?!?!</a></h1>
	    <div class="entry">
	        <p>Most of been bored last night, decided to have my first bash at automation in windows using powershell, kinda impressed but now where near the level that you can get in *nix :D
Hack of an attempt can be seen below (it works mainly but is pretty untested for the function actions as I don't have a windows server that can run hyperv, looks right per the docs though!):</p>

<p>Anyway back to making this CSS I'm working on look half decent in IE!</p>

	    </div>

	    <div class="meta">
	        <div class="date">21 Jul 2010</div>
 			<span class="comments">
 				<a href="/2010/07/powershell#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>Fun</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/07/virt-install-is-a-life-server">virt-install is a life server</a></h1>
	    <div class="entry">
	        <p>So on one of my many servers that sit around doing nothing all day I have KVM installed, recently I've been playing about with this quite a bit. Still trying to figure out libvirt and the api to it which is like a black hole when it comes to documented functions as the python classes (which is what I'm using) are generated pretty much straight off the C api stuff. Anyway as I was playing with that and rrdtool trying to make a cool graphing utility I got bored of having to type loads to install a new dom. So thanks to the power of lighttpd to serve my kickstats, virt-install to do the leg work and the amazing thing called lvm I hacked up a bash script to do the hard work for me. Find it as follows:</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nv">VG</span><span class="o">=</span><span class="s1">&#39;/dev/virtual_disks&#39;</span>
<span class="nv">KS_ADDR</span><span class="o">=</span><span class="s1">&#39;http://192.168.100.1:5843/kickstarts&#39;</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
 centos<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; ks=$KS_ADDR/centos_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://mirror.limestonenetworks.com/centos/5.5/os/x86_64/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 fedora<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; ks=$KS_ADDR/fedora_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://www.mirrorservice.org/sites/download.fedora.redhat.com/pub/fedora/linux/releases/13/Fedora/x86_64/os/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 debian<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; url=$KS_ADDR/debian_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://debian.intergenia.de/debian/dists/lenny/main/installer-amd64/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 ubuntu<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; url=$KS_ADDR/ubuntu_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s2">&quot;http://ubuntu.intergenia.de/ubuntu/dists/lucid/main/installer-amd64/&quot;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 *<span class="o">)</span>
 <span class="nb">echo</span> <span class="s2">$&quot;Usage: $0 {centos|fedora|debian|ubuntu} {Disk Size} {Ram Allocation} {Name} {Kickstart}&quot;</span>
 <span class="nb">exit </span>2
 ;;
<span class="k">esac</span>
</code></pre>
</div>


<p>Example usage:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@virtual1 ~<span class="o">]</span><span class="c"># ./vm_install.sh fedora 50 1024 CharityHosting1 basic</span>
Installing vm CharityHosting1 with 50G disk and 1024 ram allocation passing kernel arguments <span class="s1">&#39;auto=true hostname=CharityHosting1 domain=&#39;&#39; ks=http://192.168.100.1:5843/kickstarts/fedora_basic.ks&#39;</span>
 Logical volume <span class="s2">&quot;CharityHosting1&quot;</span> created
Starting install...
Retrieving file .treeinfo... | 2.4 kB 00:00 ...
Retrieving file vmlinuz... | 6.7 MB 00:01 ...
Retrieving file initrd.img... | 57 MB 00:15 ...
Creating domain... | 0 B 00:00
Domain installation still in progress. You can reconnect to
the console to <span class="nb">complete </span>the installation process.
:0
</code></pre>
</div>


<p>The :0 thrown out at the end is the VNC port you can connect to which is pretty much the console on the vm. Bear in mind this does very very little validation, if a domain is already defined it will error out at that stage so your pretty safe but for example if you tell it to use a lvm that already exists it will error but carry on installing and wipe everything off :-)</p>

<p>2 Variables are as follows:
VG - This is the volume group the lvm's are going to reside in, the path is the format that you would use when calling lvcreate (duh)
KS_ADDR - This is the base http path to where the kick-starts are located, I personally use lighttpd to do this basic job. All kickstats have the format $distro"_"$name".ks"</p>

<p>The main work is done in the kick-start file, at the moment they are pretty static but eventually will be built dynamically out of a database so you can customize things like the root password, set static ips, install packages etc without having to write out a custom one.</p>

<p>The other thing I do along side this is make dnsmasq hand out "static" ips to servers because I use NAT for mapping the public to private addresses, this is because I only run a couple of production vms on that server (Such as the charity hosting servers and graphing server) and the rest are test servers with no need for public addresses.</p>

<p>Setup for dnsmasq/the script to make the assignments static are as follows:
DNSMASQ config:</p>

<p>/root/fix_leases.py script (this runs every 2min)</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">leases</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">known_hosts</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/var/lib/dnsmasq/dnsmasq.leases&#39;</span><span class="p">):</span>
 <span class="n">leases_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/var/lib/dnsmasq/dnsmasq.leases&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">leases_fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">clientid</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
 <span class="n">leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
 <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
 <span class="s">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
 <span class="s">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">clientid</span><span class="p">,</span>
 <span class="p">}</span>

<span class="n">leases_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">):</span>
 <span class="n">known_host_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">known_host_fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="k">if</span> <span class="s">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;# Host&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 <span class="k">elif</span> <span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
 <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s">&#39;Unknown&#39;</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
 <span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
 <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
 <span class="s">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
 <span class="p">}</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<span class="n">new_leases</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">leases</span><span class="p">:</span>
 <span class="k">if</span> <span class="n">mac</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_hosts</span><span class="p">:</span>
 <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="n">leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span>

<span class="n">hosts</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">known_hosts</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>
 <span class="n">hosts</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Host </span><span class="si">%s</span><span class="se">\n</span><span class="s">dhcp-host=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>

<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">new_leases</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>
 <span class="n">hosts</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Host </span><span class="si">%s</span><span class="se">\n</span><span class="s">dhcp-host=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>

<span class="n">hosts</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;Updating done :)&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;service dnsmasq reload&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>To make the above work I run dnsmasq outside of libvirt which is not the default (you have to enable dhcp in libvirt to do it) but it works pretty well for me, just have to clear the leases out every now and then ;-)</p>

<p>Until next time which may include some C as I'm currently working on a DNS management app for the iPhone (I will probably give up on it soon though due to time constrictions!)</p>

	    </div>

	    <div class="meta">
	        <div class="date">06 Jul 2010</div>
 			<span class="comments">
 				<a href="/2010/07/virt-install-is-a-life-server#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>kvm</a>
	            
	            <a class='tag' href=''>virsh</a>
	            

	        	
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/06/work-and-scouts">Work and scouts</a></h1>
	    <div class="entry">
	        <p>Many of you probably don't know but I am actually a member of the scout association and enjoy helping out at my "local" scout group. It is not really local group anymore as I went from living in Rossendale to Yorkshire and now Bury and 7th A is in Rochdale but I travel the extra distance because it is where my scouting history is.</p>

<p>Now up until 6months ago I attended regularly and would be available at most times to help out that was until I started at UKFast now as with all new jobs I let it slide that I couldn't make it down to 7th A twice a week but I feel now is the time to get back into it. With the rota I'm currently on I can get down for a couple of weeks (I currently work 4days on 4days off) but when I switch back to the usual rota this wouldn't be possible. Hopefully I can arrange to finish earlier on wed/thurs and work extra hours but that's up to my boss. I'm sure he will understand and maybe say yes!</p>

<p>So what's been happening recently?
Well I'm still working on there new site (yes still.. sorry) it's proving quite a challenge as I don't know 100% what platform they have at there web host, I have so many ideas but can't guarantee that there will be access to such basic things as a database (Not that this is a massive problem as I could just host a db for there site if really needed, I happen to work in hosting and have a bunch of servers sat doing nothing :-)). Currently it will be pretty much a static site but some things I'd like to implement (totally not even discussed, this is the first time they have come out of my head):</p>

<ul>
<li><p>Monthly/Bi-Monthly newsletter that parents/friends can sign up to from the website - Manageable though an admin interface - Yeah I'd need a db for that :(</p></li>
<li><p>New stream on the website - Manageable though an admin interface - I'll need a db for that</p></li>
<li><p>Ideas/feedback form for website/group</p></li>
<li><p>Some interactive tour stuff of HQ</p></li>
<li><p>"Meet the leaders" page - Manageable though an admin interface - Yeah I'd need a db for that as well</p></li>
</ul>


<p>Loads of other stuff as well just all depends on how flexible the hosting is tbh, should have the site finished by the end of the month to a basic level though!</p>

<p>Other ideas I have include writing a decent management system for groups.</p>

<p>Slightly dull post, more fun things to come soon though I hope!</p>

	    </div>

	    <div class="meta">
	        <div class="date">29 Jun 2010</div>
 			<span class="comments">
 				<a href="/2010/06/work-and-scouts#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>7thA</a>
	            
	            <a class='tag' href=''>scouts</a>
	            

	        	
	            <a class='category' href=''>Fun</a>
	            
	            <a class='category' href=''>General</a>
	            
	            <a class='category' href=''>Work</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/06/download-2010-2">Download 2010</a></h1>
	    <div class="entry">
	        <p>IT WAS AMAZING! No really it was probably the best 2 days of my entire life. It started out with AC/DC's last 2 songs (I went from work so missed the start) and ended with rain! I missed seeing a few bands that I really wanted to see but all the others were just amazing so I couldn't leave.</p>

<p>I am burnt to a crisp from the sun and battered from the mosh pits, tired from no sleep and cover in mud but it was all worth it! It was one of the most mental decisions made in the past few years, just days before it opened I got the tickets. With no planning at all and hardly any funds put to one side I set off for the weekend of my life. Only regrets are going alone and missing a friends 18th party, everything else was perfect. The most amazing things happened this weekend, the most noticeable was RATM.</p>

<p>RATM are the only band I have ever seen to fill the stage completely and have <em>everyone</em> jumping around just mins in, the security even stopped the music and asked everyone to move back! It was totally un-real, just feet from the front totally rocking it out. The only band I am really really really sad about missing are FlyLeaf, I have never seen them live and want too so badly. Found out they were on after it happened :'(</p>

<p>I can't even begin to describe what it was like, if you weren't there you don't know just think WOOOOOOOOOOOOW!!!!!!!!!!!!!! while jumping up and down and running around and into people!</p>

<p>So to round up it was 500000000000000000000% amazing and I will be going next year no matter what, I'll also be taking my best friend ever and swear I'll be dating someone by then. Lots shall change the only thing constant will be my love for music. Now to do some of that work I left at the weekend! Got loads of new bands to listen too while coding now though =D</p>

	    </div>

	    <div class="meta">
	        <div class="date">15 Jun 2010</div>
 			<span class="comments">
 				<a href="/2010/06/download-2010-2#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	

	        	
	            <a class='category' href=''>Fun</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/06/coding-help">Coding Help</a></h1>
	    <div class="entry">
	        <p>So I'm currently working on a small project which will require authentication. Not really sure how to achieve what I want so here's a quick explanation for anyone if you want to share ideas:
Basic SQL definition:</p>

<div class="highlight"><pre><code class="bash">mysql&gt;; describe users;
+---------------------------+------------------+------+-----+---------+----------------+
| Field | Type | Null | Key | Default | Extra |
+---------------------------+------------------+------+-----+---------+----------------+
| id | int<span class="o">(</span>11<span class="o">)</span> | NO | PRI | NULL | auto_increment |
| username | varchar<span class="o">(</span>500<span class="o">)</span> | NO | | NULL | |
| password | varchar<span class="o">(</span>100<span class="o">)</span> | NO | | NULL | |
| salt | varchar<span class="o">(</span>15<span class="o">)</span> | NO | | NULL | |
| group_id | int<span class="o">(</span>20<span class="o">)</span> | NO | | NULL | |
| perm_login | <span class="nb">set</span><span class="o">(</span><span class="s1">&#39;Y&#39;</span>,<span class="s1">&#39;N&#39;</span>,<span class="s1">&#39;G&#39;</span><span class="o">)</span> | NO | | G | |
+---------------------------+------------------+------+-----+---------+----------------+

mysql&gt;; describe user_groups;
+---------------------------+---------------+------+-----+---------+----------------+
| Field | Type | Null | Key | Default | Extra |
+---------------------------+---------------+------+-----+---------+----------------+
| id | int<span class="o">(</span>11<span class="o">)</span> | NO | PRI | NULL | auto_increment |
| name | varchar<span class="o">(</span>500<span class="o">)</span> | NO | | NULL | |
| perm_login | <span class="nb">set</span><span class="o">(</span><span class="s1">&#39;Y&#39;</span>,<span class="s1">&#39;N&#39;</span><span class="o">)</span> | NO | | Y | |
+---------------------------+---------------+------+-----+---------+----------------+
</code></pre>
</div>


<p>For permissions I want to do groups but then have the option to override them on a per user basis. All permissions fields are named perm_ , in the users table there are the Y/N as options then G, if the field is G then it uses the identical permissions field from the group table that the user is part of (group_id matches up with id in the user_groups table).</p>

<p>Basic SQL idea:</p>

<div class="highlight"><pre><code class="bash">SELECT IF<span class="o">((</span><span class="sb">`</span>users<span class="sb">`</span>.<span class="sb">`</span>perm_test<span class="sb">`</span> <span class="o">=</span> <span class="s2">&quot;G&quot;</span><span class="o">)</span>, <span class="sb">`</span>user_groups<span class="sb">`</span>.<span class="sb">`</span>perm_test<span class="sb">`</span>, <span class="sb">`</span>users<span class="sb">`</span>.<span class="sb">`</span>perm_test<span class="sb">`</span><span class="o">)</span> AS allowed from users LEFT JOIN <span class="o">(</span><span class="sb">`</span>user_groups<span class="sb">`</span><span class="o">)</span> ON <span class="o">(</span><span class="sb">`</span>user_groups<span class="sb">`</span>.<span class="sb">`</span>id<span class="sb">`</span><span class="o">=</span><span class="sb">`</span>users<span class="sb">`</span>.<span class="sb">`</span>group_id<span class="sb">`</span><span class="o">)</span> WHERE <span class="sb">`</span>users<span class="sb">`</span>.<span class="sb">`</span>username<span class="sb">`</span> <span class="o">=</span> <span class="s2">&quot;testuser&quot;</span>
</code></pre>
</div>


<p>Now this works just fine however I can see issues mainly limitations to only being able to check one permission at a time. For 99% of the time this wouldn't be an issue for example when using the web interface/api there would be at a minimum of 2 calls and most of the time that would be it however in certain cases where you needed a full list there would be large issues. For a start getting a list of permissions would be highly recourse intensive and returning everyone would result in running something like the above for every permission. This may be a few hundred times per user per load.</p>

<p>I'm thinking of a way to move permissions into there own table then call them in a relational fashion but cannot think how to do this keeping the user/group system. Any ideas would be massively appreciated, for the moment db scheme changes are fine as this is very much a testing structure.</p>

<p>Speak to you soon :)</p>

	    </div>

	    <div class="meta">
	        <div class="date">09 Jun 2010</div>
 			<span class="comments">
 				<a href="/2010/06/coding-help#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>python</a>
	            

	        	
	            <a class='category' href=''>Fun</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/06/5min-hack-in-python">5min hack in python</a></h1>
	    <div class="entry">
	        <p>So I was trying to test some SELlinux stuff out on my KVM box and was getting flooded by tail -f thanks to someone trying to brute force my box (good luck by the way because a) password auth is disabled and b) root login is disabled >.>) anyway I got bored of this for about 5min then spent the next 5min writing this:</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">bannedHosts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">failedHosts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ignoredIPs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">failLimit</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Better change this</span>
<span class="n">bannedChain</span> <span class="o">=</span> <span class="s">&quot;Hackor&quot;</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;iptables -N </span><span class="si">%s</span><span class="s"> &amp;&gt;/dev/null&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">))</span>
<span class="n">iptables</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;iptables --list </span><span class="si">%s</span><span class="s"> -n | egrep -v </span><span class="se">\&quot;</span><span class="s">target.+prot.+opt.+source.+destination</span><span class="se">\&quot;</span><span class="s"> | egrep -v </span><span class="se">\&quot;</span><span class="s">Chain </span><span class="si">%s</span><span class="s"> .+ references</span><span class="se">\&quot;</span><span class="s"> | awk &#39;{print $4}&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">,</span> <span class="n">bannedChain</span><span class="p">))</span>
<span class="k">for</span> <span class="n">bannedIP</span> <span class="ow">in</span> <span class="n">iptables</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="n">bannedHosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bannedIP</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

<span class="n">loginFailures</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;grep failure /var/log/secure | grep pam | awk -F </span><span class="se">\&quot;</span><span class="s">rhost=</span><span class="se">\&quot;</span><span class="s"> &#39;{print $2}&#39; | awk &#39;{print $1}&#39; | uniq --count&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loginFailures</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
 <span class="k">try</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="n">host</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
 <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">host</span>

<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">failLimit</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is currently over fail limit, processing&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>

<span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">bannedHosts</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is allready banned, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
 <span class="k">continue</span>

<span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ignoredIPs</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is an ingored ip, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
 <span class="k">continue</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> not allready banned, banning for </span><span class="si">%s</span><span class="s"> failed attempts&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
 <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;iptables -A </span><span class="si">%s</span><span class="s"> -s </span><span class="si">%s</span><span class="s"> -j DROP&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
 <span class="k">else</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is currently under fail limit, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span>
</code></pre>
</div>


<p>Which happens to nicely do the job as can be seen below:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@virtual1 ~<span class="o">]</span><span class="c"># ./die_hackorz.py</span>
213.225.207.41 is currently over fail limit, processing
mx-pool207-res41.momax.it not allready banned, banning <span class="k">for </span>15 failed attempts
88.191.92.219 is currently over fail limit, processing
sd-15684.dedibox.fr not already banned, banning <span class="k">for </span>1317 failed attempts
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
88.191.92.219 is currently over fail limit, processing
sd-15684.dedibox.fr not already banned, banning <span class="k">for </span>1014 failed attempts
114.207.245.128 is currently over fail limit, processing
114.207.245.128 not already banned, banning <span class="k">for </span>1350 failed attempts
62.182.30.165 is currently over fail limit, processing
30-165.kartel.komi.me not already banned, banning <span class="k">for </span>171 failed attempts
</code></pre>
</div>


<p>Oh yeah and I know the code is rubbish, it was very much a make it work thing ;) Also even though this "makes" the chain in iptables you still need to do:</p>

<div class="highlight"><pre><code class="bash">iptables -I INPUT -j Hackor
iptables -I OUTPUT -j Hackor
iptables -I FORWARD -j Hackor
</code></pre>
</div>


<p>Because I didn't add in any code to check if they existed, nor the chain for that matter. Without them traffic won't get processed by these rules, also make sure they go near the top above any other allow rule C=</p>

	    </div>

	    <div class="meta">
	        <div class="date">06 Jun 2010</div>
 			<span class="comments">
 				<a href="/2010/06/5min-hack-in-python#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>python</a>
	            

	        	
	            <a class='category' href=''>Fun</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/05/the-difference">The difference</a></h1>
	    <div class="entry">
	        <p>I have nothing but python to post at the moment so I shall post the difference instead! Once I have some cool stable python up I will be posting more.</p>

<p><img src="http://10.44.200.5:4039/2010/05/the-difference/the_difference.jpg" alt="" /></p>

	    </div>

	    <div class="meta">
	        <div class="date">08 May 2010</div>
 			<span class="comments">
 				<a href="/2010/05/the-difference#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>python</a>
	            

	        	
	            <a class='category' href=''>General</a>
	            
	        -->
	        </div>
	    </div>
	</article>

	<article class="post">
	    <h1 class="title"><a href="/2010/04/why-i-love-python">Why I love Python</a></h1>
	    <div class="entry">
	        <p>So I've been playing with python a lot recently and it is just so amazing!</p>

<p>Here are some quick example that all took less than 10mins to write:</p>

<p>SMTP proxy to allow you to connect to a server via the specified port and it be silently forwarded to another server on another port! (Note it's a bad idea to use localhost as it will make you an open proxy)</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Meta data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">__author__</span><span class="o">=</span><span class="s">&quot;Damian Zaremba&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Import modules</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">smtpd</span>
<span class="kn">import</span> <span class="nn">asyncore</span>

<span class="n">smtpd</span><span class="o">.</span><span class="n">PureProxy</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">2535</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;mail.damianzaremba.co.uk&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</code></pre>
</div>


<p>Email parser to allow you to process email using a IMAP connection. This is really slow atm and would be improved massively by threading but it's still really cool and took about 10min to write!</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Meta data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">__author__</span><span class="o">=</span><span class="s">&quot;Damian Zaremba&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Import modules</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">imaplib</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">MH</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4</span><span class="p">(</span><span class="s">&#39;mail.damianzaremba.co.uk&#39;</span><span class="p">)</span>
<span class="n">MH</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;inboximporter-text@damianzaremba.co.uk&#39;</span><span class="p">,</span> <span class="s">&#39;testy&#39;</span><span class="p">)</span>
<span class="n">MH</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;INBOX&#39;</span><span class="p">)</span>

<span class="n">emails</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">MH</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;ALL&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
 <span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">MH</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;(RFC822)&#39;</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">attachments</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

<span class="n">email_data</span> <span class="o">=</span> <span class="n">emails</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
 <span class="s">&#39;message_id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;from&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;to&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;attachments&#39;</span><span class="p">:</span> <span class="p">[]</span>
 <span class="p">}</span>

<span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">value</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
 <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Message-ID:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;message_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Date:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Subject:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;From:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;To:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;attachments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>

<span class="n">MH</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">MH</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
<span class="k">print</span> <span class="n">emails</span>
</code></pre>
</div>


<p>Now I just need to learn Django properly and I can do some really cool socket based interfaces to things! Hopefully if I can get what I'm working on at the moment to function correctly I can reveal some cool things in the future!</p>

	    </div>

	    <div class="meta">
	        <div class="date">17 Apr 2010</div>
 			<span class="comments">
 				<a href="/2010/04/why-i-love-python#disqus_thread">Comments</a>
 			</span>
	        <div class="tags">
	        <!--
	        	
	            <a class='tag' href=''>python</a>
	            

	        	
	            <a class='category' href=''>Fun</a>
	            
	        -->
	        </div>
	    </div>
	</article>



<nav id="page_nav">
    <a href="/blog/1/" class="next">Previous</a>
    <a href="/blog/archives" class="center">Blog Archives</a>
    <a href="/blog/2/" class="next">Next</a>
</nav>
</div>

<footer>
    <p>Copyright 2009-2012 Damian Zaremba</p>
    <p>
        Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a> &dash;
        Need hosting? Try <a href="http://www.vision108.com/">Vision180</a>
    </p>
</footer>

<script src="http://10.44.200.5:4039/assests/js/jquery.fancybox.pack.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="http://10.44.200.5:4039/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
<![endif]-->

<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="http://10.44.200.5:4039/assests/js/jquery.js"%3E%3C/script%3E'))

    var disqus_shortname = 'damianzaremba';
    var disqus_script = 'count.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</body>
</html>