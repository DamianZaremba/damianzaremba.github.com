<!DOCTYPE HTML>
<html>
<head>
    <title>Damian Zaremba - Powershell!?!?!?!</title>

    <!-- General meta data -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <meta name="copyright" content=">Copyright 2009-2012 Damian Zaremba" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />
    <meta name="revisit" content="7 days" />

    <!-- M$ meta data -->
    <meta name="classification" content="GENERAL" />
    <meta name="distribution" content="GLOBAL" />
    <meta name="audience" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="TRUE" />

    <!-- CSS files -->
    <link href="/assests/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS files -->
    <script src="http://mint.damianzaremba.co.uk/?js" type="text/javascript"></script>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11817192-1']);
        _gaq.push(['_setDomainName', 'damianzaremba.co.uk']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www');
            ga.src += '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=126887194078923";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        window.___gcfg = {lang: 'en-GB'};
        (function() {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();
    </script>

    <!-- IE fixes -->
    <!--[if IE]>
        /* hover.htc fixes a bunch of issues with hovering objects in IE */
        body {
            behavior: url("/assests/other/hover.htc");
        }
    <![endif]-->

    <!--
    Site rendered at: 2012-08-18 16:54:45 +0100 by Jekyll.
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
</head>

<body>
    <header>
        <h1><a href="/">Damian Zaremba</a></h1>

        <nav class="menu">
            <ul class="main">
               <li><a href="/">Blog</a></li>
               <li><a href="/archives">Archives</a></li>
               <li><a href="/about">About</a></li>
            </ul>
        </nav>

        <div class="right">
            <form class="search" action="http://google.com/search" method="get">
                <input class="left" type="text" name="q" results="0">
                <input type="hidden" name="q" value="site:damianzaremba.co.uk">
            </form>
        </div>
</header>

<div id="content">
<article class="post">
    <h1 class="title">Powershell!?!?!?!</h1>
    <div class="entry">
        <p>Most of been bored last night, decided to have my first bash at automation in windows using powershell, kinda impressed but now where near the level that you can get in *nix :D
Hack of an attempt can be seen below (it works mainly but is pretty untested for the function actions as I don't have a windows server that can run hyperv, looks right per the docs though!):</p>

<p>[powershell]</p>

<h1>Settings</h1>

<h2>Email</h2>

<p>$email_system = ""</p>

<p>$email_contact = ""</p>

<p>$email_host = ''</p>

<p>$email_username = ''</p>

<p>$email_password = ''</p>

<h2>Database</h2>

<p>$database_host = ""</p>

<p>$database_name = ""</p>

<p>$database_user = ""</p>

<p>$database_pass = ""</p>

<h2>Run task settings</h2>

<p>$run_tasks = 1</p>

<p>$run_reboots = 1</p>

<p>$run_poweroffs = 1</p>

<p>$run_powerups = 1</p>

<h1>Log file directory</h1>

<p>$file_log_dir = 'C:\automation_logs\'
#</p>

<p>#</p>

<p>#</p>

<h1>Don't touch below here</h1>

<p>#</p>

<p>#</p>

<p>#</p>

<h1>Session varibles</h1>

<p>$base_log_name = $file_log_dir+$(Get-Date -format 'd-M-y-h-m-s')+'-'</p>

<h1>Functions</h1>

<h2>Core functions</h2>

<p>function log([string]$message, [string]$type = 'info')</p>

<p>{</p>

<p>if ((Test-Path -path $file_log_dir) -ne $True){</p>

<h1>Make log dir if it dosn't exist</h1>

<p>write-host 'Making log dir'</p>

<p>New-Item $file_log_dir -type directory</p>

<p>}
$log_file = $base_log_name+$($type)+'.log'</p>

<p>write-host $message</p>

<p>add-content $log_file $message</p>

<p>}
function error([string]$traceback)</p>

<p>{</p>

<p>$error = 'Hit exception:'+$traceback</p>

<p>log $error 'error'</p>

<p>mail 'Exception encountered' $error</p>

<p>}
function mail([string]$subject, [string]$message)</p>

<p>{</p>

<h1>$smtp_handler = new-object Net.Mail.SmtpClient($email_host)</h1>

<h1>$smtp_handler.Credentials = New-Object System.Net.NetworkCredential($email_username, $email_password)</h1>

<h1>$smtp_handler.Send($email_system, $email_contact, $subject, $message)</h1>

<p>}
function marktaskFailed([int]$task_id)</p>

<p>{</p>

<p>$time = [int][double]::Parse((Get-Date -UFormat %s))
try {
 $command = $database_handler.CreateCommand()
 $command.CommandText = "update queue set status = 'f', run_time = '$($time)' where id = '$($task_id)'"</p>

<p>$command.ExecuteNonQuery()</p>

<p>} catch {</p>

<p>log "Could not set status = failed for task id $task_id"</p>

<p>error $_.Exception.ToString()</p>

<p>}</p>

<p>}
function marktaskSuccess([int]$task_id)</p>

<p>{</p>

<p>$time = [int][double]::Parse((Get-Date -UFormat %s))
try {</p>

<p>$command = $database_handler.CreateCommand()</p>

<p>$command.CommandText = "update queue set status = 'c', run_time = '$($time)' where id = '$($task_id)'"</p>

<p>$command.ExecuteNonQuery()</p>

<p>} catch {</p>

<p>log "Could not set status = complete for task id $task_id"</p>

<p>error $_.Exception.ToString()</p>

<p>}</p>

<p>}</p>

<h2>Action functions</h2>

<p>function rebootHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.InitiateShutdown("$true", "Automated shutdown requested")
if($result.returnvalue -match "0"){</p>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM msvm_computersystem WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.requeststatechange(2)
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue powerup"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not shutdown vm"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
function poweroffHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.InitiateShutdown("$true", "Automated shutdown requested")
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue reboot"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
function poweronHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM msvm_computersystem WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.requeststatechange(2)
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue powerup"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}</p>

<p>&nbsp;</p>

<h1>Main code</h1>

<h2>Load what we need!</h2>

<p>try{</p>

<p>[void][System.Reflection.Assembly]::LoadWithPartialName("MySql.Data")</p>

<p>} catch {</p>

<p>log "Could not load mysql.net connector"</p>

<p>error $_.Exception.ToString()</p>

<p>break</p>

<p>}</p>

<h2>Main loop</h2>

<p>while (1) {</p>

<p>write-host 'Doing run....'</p>

<h2>Connect to the database</h2>

<p>try{</p>

<p>$database_handler = New-Object MySql.Data.MySqlClient.MySqlConnection</p>

<p>$database_handler.ConnectionString = "server=$database_host;uid=$database_user;pwd=$database_pass;database=$database_name;"</p>

<p>$database_handler.Open()</p>

<p>} catch {</p>

<p>log "Could not connect to the database :("</p>

<p>error $_.Exception.ToString()</p>

<p>break</p>

<p>}
write-host 'Connected to database'
try {</p>

<p>$command = $database_handler.CreateCommand()</p>

<p>$command.CommandText = "select * from <code>queue</code> where <code>status</code> = 'n'"</p>

<p>$data = $command.ExecuteReader()</p>

<p>} catch {</p>

<p>log "Could not run query against database"</p>

<p>error $_.Exception.ToString()</p>

<p>continue</p>

<p>}
write-host 'Got queue from database'</p>

<h1>Array where we will put our tasks!</h1>

<p>$tasks_to_run = @()
write-host 'Loading queue'
while ($data.Read()) {</p>

<h1>task</h1>

<p>try {</p>

<p>$task = @{}</p>

<p>$task['type'] = $data.GetValue(1).ToString()</p>

<p>$task['task_id'] = $data.GetValue(0).ToString()</p>

<p>$task['machine_id'] = $data.GetValue(3).ToString()</p>

<h1>Add task to list of tasks to run</h1>

<p>$tasks_to_run += $task</p>

<p>write-host "Entered task $($task['task_id']) into queue"</p>

<p>} catch {</p>

<p>log "Could not add task to queue"</p>

<p>error $_.Exception.ToString()</p>

<p>continue</p>

<p>}</p>

<p>}</p>

<p>$data.close() # Close the data reader</p>

<p>write-host 'Loaded queue'
if($tasks_to_run.length -gt 0){</p>

<p>write-host "Tasks to run: $($tasks_to_run.length)!"</p>

<h1>Loop though the list of tasks to run</h1>

<p>for ( $i = 0 ; $i -lt $tasks_to_run.length; $i++ ){</p>

<p>$task = $tasks_to_run[$i]
log "Running task $($task['task_id']) (Action '$($task['type'])' for instance '$($task['machine_id'])')"
 if($run_tasks -eq 1){</p>

<h1>The bit that decides what we are going to do</h1>

<p>switch ($task['type']) {</p>

<p>poweron {</p>

<p>if($run_powerups -eq 1){</p>

<p>&amp;poweronHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', powerup tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
poweroff {
 if($run_poweroffs -eq 1){</p>

<p>&amp;poweroffHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', poweroff tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
reboot {
 if($run_reboots -eq 1){</p>

<p>&amp;rebootHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', reboot tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
default { # We were asked to do something we don't understand!</p>

<p>log "Tried to run an unknown action: '$($task['type'])' for task '$($task['task_id'])' this will need running manually!"</p>

<p>mail "Tried to run an unknown action: '$($task['type'])' for task '$($task['task_id'])' this will need running manually!"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
 }else{
 log "Not running task '$($task['task_id'])', tasks are disabled"</p>

<p>marktaskFailed($task['task_id'])
 }</p>

<p>}</p>

<p>write-host 'Tasks run'</p>

<p>}else{</p>

<p>write-host "No tasks to run!"</p>

<p>}
write-host 'Run complete....'</p>

<h1>Sleep 10 seconds until next run</h1>

<p>Start-Sleep 10</p>

<p>}
[/powershell]</p>

<p>Anyway back to making this CSS I'm working on look half decent in IE!</p>

    </div>
</article>

<section id="related">
	<h2>Related posts</h2>
	<ul id="related_posts">
	
		<li><span>07 Dec 2010</span> &raquo; <a href="/2010/12/system-activity-reporter/">System activity reporter</a></li>
	
		<li><span>06 Jul 2010</span> &raquo; <a href="/2010/07/virt-install-is-a-life-server/">virt-install is a life server</a></li>
	
		<li><span>28 Jun 2011</span> &raquo; <a href="/2011/06/meth-stove/">Meth stove</a></li>
	
	</ul>
</section>


<section id="comment">
	<h2>Comments</h2>
	<div id="disqus_thread" aria-live="polite">
		<noscript>Please enable JavaScript to view the comments</noscript>
	</div>
</section>

<script type="text/javascript">
    var disqus_shortname = 'damianzaremba';
    var disqus_identifier = 'http://damianzaremba.co.uk/2010/07/powershell/';
    var disqus_url = 'http://damianzaremba.co.uk/2010/07/powershell/';
    var disqus_script = 'embed.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

</div>

<footer>
    <p class="copyright">Copyright 2009-2012 Damian Zaremba</p>
    <p class="ads">
        <ul class="ads">
            <li>Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li>
            <li>Need hosting? Try <a href="http://www.vision108.com/">Vision180</a></li>
        </ul>
    </p>
</footer>

<script src="/assests/js/jquery.fancybox.pack.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
<![endif]-->

<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
</body>
</html>