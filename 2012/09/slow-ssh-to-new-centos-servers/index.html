<!DOCTYPE HTML> <html> <head> <title>Damian Zaremba - Slow SSH to new CentOS servers</title> <meta http-equiv=Content-Type content="text/html; charset=UTF-8"/> <meta name=copyright content=">Copyright 2009-2012 Damian Zaremba" /> <meta name=google-site-verification content=qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo /> <meta name=author content="Damian Zaremba"/> <link rel=alternate type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba"/> <meta name=robots content=INDEX /> <meta name=robots content=FOLLOW /> <meta name=robots content="INDEX,FOLLOW"/> <meta name=revisit content="7 days"/> <meta name=classification content=GENERAL /> <meta name=distribution content=GLOBAL /> <meta name=audience content=all /> <meta name=MSSmartTagsPreventParsing content=TRUE /> <link href="/assests/css/main.css" rel=stylesheet type="text/css"/> <link href="/assests/css/pygments.css" rel=stylesheet type="text/css"/> <script src="http://mint.damianzaremba.co.uk/?js" type="text/javascript"></script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-11817192-1"]);_gaq.push(["_setDomainName","damianzaremba.co.uk"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src=("https:"==document.location.protocol?"https://ssl":"http://www");b.src+=".google-analytics.com/ga.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();</script> <!--[if IE]>/* hover.htc fixes a bunch of issues with hovering objects in IE */ body { behavior: url("/assests/other/hover.htc"); }<![endif]--> </head> <body> <header> <h1><a href="/">Damian Zaremba</a> <span>Slow SSH to new CentOS servers</span></h1> <nav> <ul id=main> <li><a href="/">Blog</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/about">About</a></li> <li><a href="/cv">CV</a></li> </ul> </nav> <div id=right> <p> <a href="http://twitter.com/DamianZaremba" title=Twitter><img src="/assests/images/twitter.png"/></a> <a href="https://plus.google.com/110559147647328161061" title=GooglePlus><img src="/assests/images/googleplus.png"/></a> <a href="http://facebook.com/DamianZaremba" title=Facebook><img src="/assests/images/facebook.png"/></a> <a href="https://github.com/DamianZaremba" title=GitHub><img src="/assests/images/github.png"/></a> <a href="http://feeds.feedburner.com/DamianZaremba" title=RSS><img src="/assests/images/rss.png"/></a> </p> <form class=search action="http://google.com/search" method=get> <input class=left type=text name=q results=0> <input type=hidden name=q value="site:damianzaremba.co.uk"> </form> </div> </header> <div id=content> <article class=post> <div class=meta> <span><img src="/assests/images/date.png"/>08 Sep 2012</span> <span><img src="/assests/images/comments.png"/><a href="/2012/09/slow-ssh-to-new-centos-servers/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/software'>Software</a></li><li><a href='/tag/ssh'>SSH</a></li><li><a href='/tag/centos'>CentOS</a></li><li><a href='/tag/dns'>DNS</a></li><li><a href='/tag/ipv4'>IPv4</a></li><li><a href='/tag/ipv6'>IPv6</a></li><li><a href='/tag/linux'>Linux</a></li></ul> </div> <div class=entry> <p>Recently when installing new servers I 'randomly' had an issue where SSH connections would lag out for 20-30 seconds on login then function fine once authenticated.</p> <p>I noticed this issue on CentOS 5/6 servers, however it probably applies to anything running glibc 2.10+.</p> <p>Now while there are a few reasons SSH might be doing this (most of which can be seen using verbose flags), it wasn't the usual suspects (GSSAPI etc).</p> <p>The interesting part was, this wasn't happening on all servers (they are standard config wise thanks to puppet).</p> <p>It turns out the UseDNS setting was failing, very slowly. Now a simple way to quickly solve the issue is to set <code>UseDNS no</code> in your sshd_config file.</p> <p>This might be acceptable, depending on how much you have access restricted however there is an alternative.</p> <p>It turns out there was a change in glibc that can be seen on the changelog <a href="http://sourceware.org/ml/libc-alpha/2009-10/msg00063.html">here</a>.</p> <p>Under some circumstances (especially when firewalls are involved) DNS resolution will fail and glibc should fallback, close the socket and start again. It would seem this takes rather a long while when trying to SSH!</p> <p>Thankfully there is a (<a href="https://bugzilla.kernel.org/show_bug.cgi?id=38542">recently</a> documented) option that you can add to your resolv.conf file <code>single-request-reopen</code>. This forces glibc to enter fallback mode straight away and kills the delay.</p> <p>An example of the 'patched' /etc/resolv.conf file</p> <div class=highlight><pre><code class="text"># This file is managed via Puppet

# Servers
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 208.67.222.222
nameserver 208.67.220.220

# Options
options single-request-reopen
</code></pre> </div> <p>Now you might want to dig into your network stack a little more and make sure you can handle IPv6/dual stack properly but for now, problem solved!</p> </div> </article> <section id=related> <h2>Related posts</h2> <ul id=related_posts> <li>&raquo; <a href="/2012/09/kvirc-update-breaks-irssi-proxy/">KVIrc update breaks Irssi Proxy</a></li> <li>&raquo; <a href="/2012/08/running-a-wsgi-app-via-gunicorn-from-python/">Running a WSGI app via Gunicorn from Python</a></li> <li>&raquo; <a href="/2012/08/radius-authentication-on-a-dell-powerconnect-m6220-switch/">RADIUS authentication on a Dell PowerConnect M6220 switch</a></li> </ul> </section> <section id=comment> <h2>Comments</h2> <div id=disqus_thread aria-live=polite> <noscript>Please enable JavaScript to view the comments</noscript> </div> </section> <script type="text/javascript">var disqus_shortname="damianzaremba";var disqus_identifier="http://damianzaremba.co.uk/2012/09/slow-ssh-to-new-centos-servers/";var disqus_url="http://damianzaremba.co.uk/2012/09/slow-ssh-to-new-centos-servers/";var disqus_script="embed.js";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="http://"+disqus_shortname+".disqus.com/"+disqus_script;(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </div> <footer> <p class=copyright>Copyright 2009-2012 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p> <p class=ads> <ul id=ads> <li>Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li> <li>Need hosting? Try <a href="http://www.vision108.com/">Vision180</a></li> <li>Want my website? <a href="http://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li> </ul> </p> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script> <script type="text/javascript">!window.jQuery&&document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'));</script><![endif]--> <script type="text/javascript">!window.jQuery&&document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'));var disqus_shortname="damianzaremba";var disqus_script="count.js";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="http://"+disqus_shortname+".disqus.com/"+disqus_script;(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </body> </html>