<!DOCTYPE html> <html lang=en> <head> <title>Damian Zaremba - A look at low-cost tap aggregation</title> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="IE=edge"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta http-equiv=Content-Type content="text/html; charset=UTF-8"/> <meta name=google-site-verification content=qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo /> <meta name=author content="Damian Zaremba"/> <link rel=alternate type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba"/> <meta name=robots content=INDEX /> <meta name=robots content=FOLLOW /> <meta name=robots content="INDEX,FOLLOW"/> <link href="/assests/css/bootstrap.min.css?_v=58a49b3689d699cb72ffda7252d99fcb" rel=stylesheet> <link href="/assests/css/main.css?_v=d2c89647dc3d0886383e347a9048f62c" rel=stylesheet> </head> <body> <nav class="navbar navbar-default navbar-fixed-top"> <div class=container> <div class=navbar-header> <button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target="#navbar" aria-expanded=false aria-controls=navbar> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href="/">Damian Zaremba</a> </div> <div id=navbar class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li class=active><a href="/">Blog</a></li> <li class=""><a href="/about/">About</a></li> <li class=""><a href="/cv/">CV</a></li> <li class=""><a href="/archive/">Archive</a></li> <li class=""><a href="/projects/">Projects</a></li> </ul> <div class="social-icons navbar-right visible-md visible-lg"> <a href="http://twitter.com/DamianZaremba"> <img class=twitter src="/assests/images/twitter.png?_v=5c9d07bd2ff1f5224934583b6be57b0a" alt=Twitter /> </a> <a href="https://github.com/DamianZaremba"> <img class=github src="/assests/images/github.png?_v=438c17272c5f0e9f4a6da34d3e4bc5bd" alt=GitHub /> </a> <a href="http://feeds.feedburner.com/DamianZaremba"> <img class=rss src="/assests/images/rss.png?_v=f6fa89d6cfe5f5e95f0f87205d8c4b11" alt=RSS /> </a> </div> </div> </div> </nav> <div class=container> <article class=post> <h1 class=title><a href="/2017/12/a-look-at-low-cost-tap-aggregation/">A look at low-cost tap aggregation</a></h1> <div class=meta> <span><img src="/assests/images/date.png?_v=1673aede74ad16063dfcd243a3d61d41" title=Date alt=Date />25 Dec 2017</span> <span><img src="/assests/images/comments.png?_v=33159642eac6a274ec5483d1bc54f52c" title=Content alt=Content /><a href="/2017/12/a-look-at-low-cost-tap-aggregation/#disqus_thread">Comments</a></span> <ul class=categories> <li><a href='/tag/network'>Network</a></li><li><a href='/tag/how-to'>How-to</a></li><li><a href='/tag/python'>Python</a></li></ul> </div> <div class=entry> <p>A while ago, I had a project that required capturing traffic from a number of sources, thus an adventure into possible solutions was born.</p> <h2>Why do we want to capture traffic?</h2> <p>There are numerous reasons to capture traffic including:</p> <ul> <li>Network troubleshooting</li> <li>Traffic monitoring (including intrusion detection)</li> <li>Legal requests/requirements</li> </ul> <p>Ultimately it's about getting visibility, either for security or operations.</p> <p>Our goal is given any path, to be able to replicate the traffic, with minimal impact.</p> <h2>How can we capture traffic?</h2> <p>There are generally 3 different methods for capturing traffic, each with their own complexities.</p> <h3>From a target device</h3> <p>At a basic level, a device can capture traffic in 2 ways:</p> <ul> <li>'CPU bound'; traffic that has been brought up the network stack and is 'destined' for this device</li> <li>Raw sockets; 'raw' network traffic that the device receives on a network interface.</li> </ul> <p>CPU bound traffic can be efficient to capture if filtered appropriately. When dealing with high traffic volumes processing traffic can take critical resources away from your business applications.</p> <p>Raw sockets are generally very limited, hub-based topologies are not widely used, limiting any traffic to broadcast for the servers subnet, or targeted (CPU bound) traffic (multicast/unicast).</p> <p>Generally, to be usable by an analyser the traffic would need to be encapsulated and transmitted, using further resources on the device.</p> <h3>Span a switch</h3> <p>This is similar to inline, but I've separated it here due to implementation differences.</p> <p>SPAN's generally come in 3 forms:</p> <ul> <li>SPAN - take traffic from port A, mirror to port B, on the same device</li> <li>RSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 2)</li> <li>ERSPAN - take traffic from port A, mirror to port B, on a remote device (over layer 3)</li> </ul> <p>There are a number of downsides:</p> <ul> <li>Vendors have varying levels of support; <ul> <li>RSPAN on a Juniper EX series switch doesn't work over an AE</li> <li>Tricks can be used, for example, spanning into a GRE tunnel to accomplish ERSPAN, this becomes hardware dependent though</li> </ul> </li> <li>CPU generated (ICMP/ARP/LLDP/BPDU etc) packets generally do not get mirrored</li> <li>Invalid packets will not be seen (those dropped due to checksum errors for example)</li> <li>CPU usage can increase drastically due to extra processing requirements</li> <li>As we're spanning in an L2 domain arp table churn can happen if you're not careful</li> </ul> <p>However, if you need insight into a switched domain and don't want to inline-tap every cable, it might work for you.</p> <h3>Inline</h3> <p>Inline-taps come in many different flavours, supporting different media types. At a basic level, there are 2 main differences.</p> <h4>Passive tap</h4> <ul> <li>Require no power, pass the original signal onto the output</li> <li>Reduce the output power by a known ratio (important when dealing with fibre)</li> <li>No monitoring data or other insights possible</li> <li>Very failure resistant</li> </ul> <h5>Logical operation</h5> <div class=graphviz-wrapper> <svg role=img aria-label="passive tap" width=474pt height=206pt viewBox="0.00 0.00 474.00 205.89"> <title>passive tap</title> <desc>digraph &quot;passive tap&quot; { subgraph cluster_Input { label = &quot;Input Port&quot;; color = black; &quot;Input TX&quot;; &quot;Input RX&quot;; } subgraph cluster_Output { label = &quot;Output Port&quot;; color = black; &quot;Output TX&quot;; &quot;Output RX&quot;; } subgraph cluster_Monitor { label = &quot;Monitor Port&quot;; color = black; &quot;Monitor TX2&quot;; &quot;Monitor TX1&quot;; } &quot;Input TX&quot; -&gt; &quot;Output RX&quot; &quot;Input TX&quot; -&gt; &quot;Monitor TX1&quot; &quot;Output TX&quot; -&gt; &quot;Input RX&quot; &quot;Output TX&quot; -&gt; &quot;Monitor TX2&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 201.889)"> <title>passive tap</title> <polygon fill=white stroke=none points="-4,4 -4,-201.889 470,-201.889 470,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_Input</title> <polygon fill=none stroke=black points="8,-91 8,-166 218,-166 218,-91 8,-91"/> <text text-anchor=middle x=113 y="-150.8" font-family="Times,serif" font-size="14.00">Input Port</text> </g> <g id=clust2 class=cluster><title>cluster_Output</title> <polygon fill=none stroke=black points="226,-91 226,-166 458,-166 458,-91 226,-91"/> <text text-anchor=middle x=342 y="-150.8" font-family="Times,serif" font-size="14.00">Output Port</text> </g> <g id=clust3 class=cluster><title>cluster_Monitor</title> <polygon fill=none stroke=black points="145,-8 145,-83 412,-83 412,-8 145,-8"/> <text text-anchor=middle x="278.5" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text> </g> <g id=node1 class=node><title>Input TX</title> <ellipse fill=none stroke=black cx=166 cy=-117 rx="43.319" ry=18 /> <text text-anchor=middle x=166 y="-113.3" font-family="Times,serif" font-size="14.00">Input TX</text> </g> <g id=node4 class=node><title>Output RX</title> <ellipse fill=none stroke=black cx=284 cy=-117 rx="50.0684" ry=18 /> <text text-anchor=middle x=284 y="-113.3" font-family="Times,serif" font-size="14.00">Output RX</text> </g> <g id=edge1 class=edge><title>Input TX&#45;&gt;Output RX</title> <path fill=none stroke=black d="M209.328,-117C214.05,-117 218.771,-117 223.493,-117"/> <polygon fill=black stroke=black points="223.83,-120.5 233.83,-117 223.83,-113.5 223.83,-120.5"/> </g> <g id=node6 class=node><title>Monitor TX1</title> <ellipse fill=none stroke=black cx=211 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=211 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text> </g> <g id=edge2 class=edge><title>Input TX&#45;&gt;Monitor TX1</title> <path fill=none stroke=black d="M175.324,-99.2167C181.437,-88.2128 189.554,-73.6021 196.501,-61.0976"/> <polygon fill=black stroke=black points="199.736,-62.4818 201.533,-52.0404 193.617,-59.0822 199.736,-62.4818"/> </g> <g id=node2 class=node><title>Input RX</title> <ellipse fill=none stroke=black cx=60 cy=-117 rx="44.2946" ry=18 /> <text text-anchor=middle x=60 y="-113.3" font-family="Times,serif" font-size="14.00">Input RX</text> </g> <g id=node3 class=node><title>Output TX</title> <ellipse fill=none stroke=black cx=401 cy=-117 rx="49.0941" ry=18 /> <text text-anchor=middle x=401 y="-113.3" font-family="Times,serif" font-size="14.00">Output TX</text> </g> <g id=edge3 class=edge><title>Output TX&#45;&gt;Input RX</title> <path fill=none stroke=black d="M389.619,-134.566C377.906,-150.863 358.013,-174.054 334,-184 290.475,-202.029 165.168,-202.868 122,-184 102.82,-175.617 86.9279,-158.049 76.0362,-143.006"/> <polygon fill=black stroke=black points="78.7606,-140.791 70.2141,-134.529 72.9905,-144.754 78.7606,-140.791"/> </g> <g id=node5 class=node><title>Monitor TX2</title> <ellipse fill=none stroke=black cx=346 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=346 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text> </g> <g id=edge4 class=edge><title>Output TX&#45;&gt;Monitor TX2</title> <path fill=none stroke=black d="M389.604,-99.2167C381.934,-87.9217 371.685,-72.8267 363.05,-60.1099"/> <polygon fill=black stroke=black points="365.895,-58.0687 357.381,-51.7618 360.103,-62.001 365.895,-58.0687"/> </g> </g> </svg> </div> <p>There are different technologies for mirroring the payload when using copper, these are generally resistor based, for fibre they're either thin film or fused biconical taper based.</p> <p><em>Note: Thin film is generally preferred for 40G+ links, due to their lower loss rate caused by more even light distribution.</em></p> <p>The concept for all of them is the same:</p> <ul> <li>Given an input of 100%</li> <li>Bleed off x% of the signal to the mirror port</li> <li>Pass the remaining 100-x% through to the output port</li> </ul> <p>A key consideration when using fibre is the 'split ratio' aka how much light to bleed off, both the monitor and the output interfaces need enough light for the optics on the other end.</p> <h4>Active tap</h4> <ul> <li>They require power and re-generate the output signals.</li> <li>Monitoring data can be provided (light levels etc)</li> <li>When using fibre there are no split ratio considerations</li> </ul> <h5>Logical operation</h5> <div class=graphviz-wrapper> <svg role=img aria-label="active tap" width=474pt height=254pt viewBox="0.00 0.00 474.00 254.00"> <title>active tap</title> <desc>digraph &quot;active tap&quot; { subgraph cluster_Input { label = &quot;Input Port&quot;; color = black; &quot;Input TX&quot;; &quot;Input RX&quot;; } subgraph cluster_Output { label = &quot;Output Port&quot;; color = black; &quot;Output TX&quot;; &quot;Output RX&quot;; } subgraph cluster_Monitor { label = &quot;Monitor Port&quot;; color = black; &quot;Monitor TX2&quot;; &quot;Monitor TX1&quot;; } subgraph cluster_Processor { color = black; shape = square; &quot;Processor&quot;; } &quot;Processor&quot; -&gt; &quot;Input TX&quot; &quot;Input RX&quot; -&gt; &quot;Processor&quot; &quot;Processor&quot; -&gt; &quot;Output TX&quot; &quot;Output RX&quot; -&gt; &quot;Processor&quot; &quot;Processor&quot; -&gt; &quot;Monitor TX1&quot; &quot;Processor&quot; -&gt; &quot;Monitor TX2&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 250)"> <title>active tap</title> <polygon fill=white stroke=none points="-4,4 -4,-250 470,-250 470,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_Input</title> <polygon fill=none stroke=black points="8,-163 8,-238 218,-238 218,-163 8,-163"/> <text text-anchor=middle x=113 y="-222.8" font-family="Times,serif" font-size="14.00">Input Port</text> </g> <g id=clust2 class=cluster><title>cluster_Output</title> <polygon fill=none stroke=black points="226,-163 226,-238 458,-238 458,-163 226,-163"/> <text text-anchor=middle x=342 y="-222.8" font-family="Times,serif" font-size="14.00">Output Port</text> </g> <g id=clust3 class=cluster><title>cluster_Monitor</title> <polygon fill=none stroke=black points="113,-8 113,-83 380,-83 380,-8 113,-8"/> <text text-anchor=middle x="246.5" y="-67.8" font-family="Times,serif" font-size="14.00">Monitor Port</text> </g> <g id=clust4 class=cluster><title>cluster_Processor</title> <polygon fill=none stroke=black points="172,-91 172,-143 278,-143 278,-91 172,-91"/> </g> <g id=node1 class=node><title>Input TX</title> <ellipse fill=none stroke=black cx=166 cy=-189 rx="43.319" ry=18 /> <text text-anchor=middle x=166 y="-185.3" font-family="Times,serif" font-size="14.00">Input TX</text> </g> <g id=node2 class=node><title>Input RX</title> <ellipse fill=none stroke=black cx=60 cy=-189 rx="44.2946" ry=18 /> <text text-anchor=middle x=60 y="-185.3" font-family="Times,serif" font-size="14.00">Input RX</text> </g> <g id=node7 class=node><title>Processor</title> <ellipse fill=none stroke=black cx=225 cy=-117 rx="44.271" ry=18 /> <text text-anchor=middle x=225 y="-113.3" font-family="Times,serif" font-size="14.00">Processor</text> </g> <g id=edge2 class=edge><title>Input RX&#45;&gt;Processor</title> <path fill=none stroke=black d="M87.3679,-174.716C95.5656,-170.838 104.608,-166.662 113,-163 136.485,-152.754 163.086,-142.029 184.469,-133.621"/> <polygon fill=black stroke=black points="185.861,-136.835 193.897,-129.931 183.309,-130.317 185.861,-136.835"/> </g> <g id=node3 class=node><title>Output TX</title> <ellipse fill=none stroke=black cx=401 cy=-189 rx="49.0941" ry=18 /> <text text-anchor=middle x=401 y="-185.3" font-family="Times,serif" font-size="14.00">Output TX</text> </g> <g id=node4 class=node><title>Output RX</title> <ellipse fill=none stroke=black cx=284 cy=-189 rx="50.0684" ry=18 /> <text text-anchor=middle x=284 y="-185.3" font-family="Times,serif" font-size="14.00">Output RX</text> </g> <g id=edge4 class=edge><title>Output RX&#45;&gt;Processor</title> <path fill=none stroke=black d="M270.018,-171.411C262.67,-162.693 253.527,-151.845 245.404,-142.208"/> <polygon fill=black stroke=black points="248.003,-139.861 238.882,-134.47 242.65,-144.372 248.003,-139.861"/> </g> <g id=node5 class=node><title>Monitor TX2</title> <ellipse fill=none stroke=black cx=314 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=314 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX2</text> </g> <g id=node6 class=node><title>Monitor TX1</title> <ellipse fill=none stroke=black cx=179 cy=-34 rx="58.2422" ry=18 /> <text text-anchor=middle x=179 y="-30.3" font-family="Times,serif" font-size="14.00">Monitor TX1</text> </g> <g id=edge1 class=edge><title>Processor&#45;&gt;Input TX</title> <path fill=none stroke=black d="M211.39,-134.147C203.956,-142.967 194.604,-154.064 186.323,-163.889"/> <polygon fill=black stroke=black points="183.453,-161.863 179.684,-171.765 188.805,-166.374 183.453,-161.863"/> </g> <g id=edge3 class=edge><title>Processor&#45;&gt;Output TX</title> <path fill=none stroke=black d="M256.696,-129.669C280.535,-138.547 313.95,-151.206 343,-163 348.934,-165.409 355.179,-168.02 361.285,-170.616"/> <polygon fill=black stroke=black points="360.13,-173.928 370.7,-174.65 362.887,-167.494 360.13,-173.928"/> </g> <g id=edge6 class=edge><title>Processor&#45;&gt;Monitor TX2</title> <path fill=none stroke=black d="M242.16,-100.382C255.323,-88.4031 273.695,-71.6819 288.565,-58.1483"/> <polygon fill=black stroke=black points="290.936,-60.7231 295.976,-51.4038 286.225,-55.5462 290.936,-60.7231"/> </g> <g id=edge5 class=edge><title>Processor&#45;&gt;Monitor TX1</title> <path fill=none stroke=black d="M215.469,-99.2167C209.116,-88.0303 200.646,-73.1166 193.469,-60.4773"/> <polygon fill=black stroke=black points="196.501,-58.729 188.519,-51.7618 190.414,-62.1858 196.501,-58.729"/> </g> </g> </svg> </div> <p>The internal complexity varies, but the principle is:</p> <ul> <li>Given an input of X</li> <li>Generate the payload of X into Y and Z</li> <li>Transmit Y to the monitor interface</li> <li>Transmit Z to the output interface</li> </ul> <p>It is possible to buy active taps, with the capability to 'fail open' meaning in the event of a power failure traffic will continue to flow.</p> <p>I still prefer to use passive taps, which should be as resilient as a fibre patch panel.</p> <h2>Why do we want to aggregate it?</h2> <p>In the most simplistic deployment, we can simply send from the source to the destination:</p> <div class=graphviz-wrapper> <svg role=img aria-label="one to one tap" width=184pt height=44pt viewBox="0.00 0.00 184.00 44.00"> <title>one to one tap</title> <desc>digraph &quot;one to one tap&quot; { rankdir=LR; &quot;TAP&quot; -&gt; &quot;Analyser&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 40)"> <title>one to one tap</title> <polygon fill=white stroke=none points="-4,4 -4,-40 180,-40 180,4 -4,4"/> <g id=node1 class=node><title>TAP</title> <ellipse fill=none stroke=black cx=28 cy=-18 rx="27.0966" ry=18 /> <text text-anchor=middle x=28 y="-14.3" font-family="Times,serif" font-size="14.00">TAP</text> </g> <g id=node2 class=node><title>Analyser</title> <ellipse fill=none stroke=black cx=134 cy=-18 rx="42.4939" ry=18 /> <text text-anchor=middle x=134 y="-14.3" font-family="Times,serif" font-size="14.00">Analyser</text> </g> <g id=edge1 class=edge><title>TAP&#45;&gt;Analyser</title> <path fill=none stroke=black d="M55.5127,-18C63.4707,-18 72.4867,-18 81.4834,-18"/> <polygon fill=black stroke=black points="81.5755,-21.5001 91.5754,-18 81.5754,-14.5001 81.5755,-21.5001"/> </g> </g> </svg> </div> <p>However, there are a number of reasons to have an aggregation step in the middle:</p> <ul> <li>Number of ingress points <ul> <li>Aggregation of smaller capture points into larger interfaces</li> <li>Reduction in rack space required for analysers, servers etc</li> <li>Strategic aggregation to reduce physical requirements (fibre, rack space)</li> </ul> </li> <li>Multiple destinations <ul> <li>Apply filtering logic to save on analyser licensing</li> <li>Send traffic to security appliances and network monitoring devices</li> </ul> </li> <li>Apply software logic to capture rules</li> <li>Support multiple media types <ul> <li>Provide longer reach for copper-based taps</li> <li>SMF, MMF, XFP, QSFP, Copper support</li> </ul> </li> <li>Single view of traffic <ul> <li>Certain DPI/IDS appliances require full flows, difficult in ECMP networks</li> <li>I don't recommend this due to the associated scaling issues</li> </ul> </li> </ul> <p>Downsides to having an aggregation step:</p> <ul> <li>Potential congestion issues (we're taking raw traffic, limited by the sender)</li> <li>Single point of failure <ul> <li>This could be mitigated using layer 1 fibre switches or similar</li> <li>It's for monitoring traffic, so uptime is likely not as critical</li> </ul> </li> <li>Cost</li> </ul> <p>Historically TAP aggregation has been a very expensive game, around 2-4k a port!</p> <p>Thankfully Arista changed that with their 7150 series switch, which supports a tap mode as well as a 'DANZ' software suite for loss/latency monitoring, packet filtering and mirroring.</p> <p>The DANZ suite is now available on the 7150, 7280E and 7500E series switches from Arista, opening up options from 1/2U fixed form to 7/11U chassi based deployments.</p> <p>The 7150 series gives some nice features:</p> <ul> <li>Port density; up to 64 10G ports</li> <li>LANZ+ features for micro-burst analysis</li> <li>PTP support for packet time stamping</li> <li>~350ns latency for all packets</li> <li>Multi-port mirroring</li> <li>Hitless (ISSU) upgrades</li> <li>A 'normal' Linux environment and Python based toolset</li> <li>You configure it like any other switch!</li> </ul> <h2>Let's implement a solution!</h2> <p>We'll keep it simple with 1 aggregation point, 6 inputs and 2 outputs. In reality, this could be multiple levels of aggregation.</p> <p>Inputs:</p> <ul> <li>2 x Passive taps</li> <li>2 x SPANs</li> <li>2 x Active taps</li> </ul> <p>Logical Groups:</p> <ul> <li>Group 1 - Internet</li> <li>Group 2 - Corporate</li> <li>Group 3 - Regional</li> </ul> <p>Outputs:</p> <ul> <li>Bro Network Security Monitor (Internet + Regional only)</li> <li>Server (Corporate only)</li> </ul> <h3>Logical Diagram</h3> <div class=graphviz-wrapper> <svg role=img aria-label="active tap" width=1020pt height=243pt viewBox="0.00 0.00 1020.00 243.00"> <title>active tap</title> <desc>digraph &quot;active tap&quot; { subgraph cluster_PassiveTap { label = &quot;Passive Optical Tap&quot;; color = black; &quot;Transit Provider 1&quot;; &quot;Transit Provider 2&quot;; } subgraph cluster_Corporate1 { label = &quot;Corporate DMZ&quot;; color = black; &quot;Corporate Spine 1&quot;; } subgraph cluster_Corporate2 { label = &quot;Corporate DMZ&quot;; color = black; &quot;Corporate Spine 2&quot;; } subgraph cluster_Regional { label = &quot;Active TAP&quot;; color = black; &quot;Wan Provider 1&quot;; &quot;Wan Provider 2&quot;; } subgraph cluster_7150 { color = black; shape = square; &quot;Tap Switch&quot;; } subgraph cluster_Bro { color = black; shape = square; &quot;Bro Network Security Monitor&quot;; } subgraph cluster_Server { color = black; shape = square; &quot;Secret Server&quot;; } &quot;Transit Provider 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Transit Provider 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Corporate Spine 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Corporate Spine 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Wan Provider 1&quot; -&gt; &quot;Tap Switch&quot; &quot;Wan Provider 2&quot; -&gt; &quot;Tap Switch&quot; &quot;Tap Switch&quot; -&gt; &quot;Bro Network Security Monitor&quot; &quot;Tap Switch&quot; -&gt; &quot;Secret Server&quot; }</desc> <g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 239)"> <title>active tap</title> <polygon fill=white stroke=none points="-4,4 -4,-239 1016,-239 1016,4 -4,4"/> <g id=clust1 class=cluster><title>cluster_PassiveTap</title> <polygon fill=none stroke=black points="8,-152 8,-227 343,-227 343,-152 8,-152"/> <text text-anchor=middle x="175.5" y="-211.8" font-family="Times,serif" font-size="14.00">Passive Optical Tap</text> </g> <g id=clust2 class=cluster><title>cluster_Corporate1</title> <polygon fill=none stroke=black points="351,-152 351,-227 517,-227 517,-152 351,-152"/> <text text-anchor=middle x=434 y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text> </g> <g id=clust3 class=cluster><title>cluster_Corporate2</title> <polygon fill=none stroke=black points="525,-152 525,-227 691,-227 691,-152 525,-152"/> <text text-anchor=middle x=608 y="-211.8" font-family="Times,serif" font-size="14.00">Corporate DMZ</text> </g> <g id=clust4 class=cluster><title>cluster_Regional</title> <polygon fill=none stroke=black points="699,-152 699,-227 1004,-227 1004,-152 699,-152"/> <text text-anchor=middle x="851.5" y="-211.8" font-family="Times,serif" font-size="14.00">Active TAP</text> </g> <g id=clust5 class=cluster><title>cluster_7150</title> <polygon fill=none stroke=black points="462,-80 462,-132 580,-132 580,-80 462,-80"/> </g> <g id=clust6 class=cluster><title>cluster_Bro</title> <polygon fill=none stroke=black points="292,-8 292,-60 548,-60 548,-8 292,-8"/> </g> <g id=clust7 class=cluster><title>cluster_Server</title> <polygon fill=none stroke=black points="556,-8 556,-60 688,-60 688,-8 556,-8"/> </g> <g id=node1 class=node><title>Transit Provider 1</title> <ellipse fill=none stroke=black cx=260 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=260 y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 1</text> </g> <g id=node7 class=node><title>Tap Switch</title> <ellipse fill=none stroke=black cx=521 cy=-106 rx="51.0191" ry=18 /> <text text-anchor=middle x=521 y="-102.3" font-family="Times,serif" font-size="14.00">Tap Switch</text> </g> <g id=edge1 class=edge><title>Transit Provider 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M305.54,-163.666C318.88,-159.826 333.507,-155.683 347,-152 388.506,-140.671 435.78,-128.491 470.567,-119.664"/> <polygon fill=black stroke=black points="471.652,-122.999 480.486,-117.151 469.933,-116.214 471.652,-122.999"/> </g> <g id=node2 class=node><title>Transit Provider 2</title> <ellipse fill=none stroke=black cx=91 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=91 y="-174.3" font-family="Times,serif" font-size="14.00">Transit Provider 2</text> </g> <g id=edge2 class=edge><title>Transit Provider 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M133.473,-163.092C146.958,-159.059 162.003,-154.952 176,-152 275.082,-131.101 392.345,-118.276 461.486,-111.913"/> <polygon fill=black stroke=black points="462.101,-115.371 471.745,-110.984 461.47,-108.4 462.101,-115.371"/> </g> <g id=node3 class=node><title>Corporate Spine 1</title> <ellipse fill=none stroke=black cx=434 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=434 y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 1</text> </g> <g id=edge3 class=edge><title>Corporate Spine 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M454.618,-160.411C466.242,-151.058 480.913,-139.254 493.505,-129.123"/> <polygon fill=black stroke=black points="495.829,-131.745 501.426,-122.749 491.441,-126.291 495.829,-131.745"/> </g> <g id=node4 class=node><title>Corporate Spine 2</title> <ellipse fill=none stroke=black cx=608 cy=-178 rx="75.0904" ry=18 /> <text text-anchor=middle x=608 y="-174.3" font-family="Times,serif" font-size="14.00">Corporate Spine 2</text> </g> <g id=edge4 class=edge><title>Corporate Spine 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M587.382,-160.411C575.758,-151.058 561.087,-139.254 548.495,-129.123"/> <polygon fill=black stroke=black points="550.559,-126.291 540.574,-122.749 546.171,-131.745 550.559,-126.291"/> </g> <g id=node5 class=node><title>Wan Provider 1</title> <ellipse fill=none stroke=black cx=928 cy=-178 rx="67.3907" ry=18 /> <text text-anchor=middle x=928 y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 1</text> </g> <g id=edge5 class=edge><title>Wan Provider 1&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M889.6,-163.044C877.389,-159.009 863.742,-154.913 851,-152 757.767,-130.687 647.253,-118.13 580.708,-111.911"/> <polygon fill=black stroke=black points="580.693,-108.395 570.415,-110.967 580.053,-115.366 580.693,-108.395"/> </g> <g id=node6 class=node><title>Wan Provider 2</title> <ellipse fill=none stroke=black cx=775 cy=-178 rx="67.3907" ry=18 /> <text text-anchor=middle x=775 y="-174.3" font-family="Times,serif" font-size="14.00">Wan Provider 2</text> </g> <g id=edge6 class=edge><title>Wan Provider 2&#45;&gt;Tap Switch</title> <path fill=none stroke=black d="M733.596,-163.63C721.22,-159.751 707.593,-155.594 695,-152 653.764,-140.232 606.655,-128.13 571.863,-119.444"/> <polygon fill=black stroke=black points="572.487,-115.993 561.938,-116.976 570.797,-122.786 572.487,-115.993"/> </g> <g id=node8 class=node><title>Bro Network Security Monitor</title> <ellipse fill=none stroke=black cx=420 cy=-34 rx="120.359" ry=18 /> <text text-anchor=middle x=420 y="-30.3" font-family="Times,serif" font-size="14.00">Bro Network Security Monitor</text> </g> <g id=edge7 class=edge><title>Tap Switch&#45;&gt;Bro Network Security Monitor</title> <path fill=none stroke=black d="M498.585,-89.4647C485.079,-80.1044 467.644,-68.0206 452.629,-57.6141"/> <polygon fill=black stroke=black points="454.329,-54.5336 444.116,-51.7139 450.341,-60.2869 454.329,-54.5336"/> </g> <g id=node9 class=node><title>Secret Server</title> <ellipse fill=none stroke=black cx=622 cy=-34 rx="57.2688" ry=18 /> <text text-anchor=middle x=622 y="-30.3" font-family="Times,serif" font-size="14.00">Secret Server</text> </g> <g id=edge8 class=edge><title>Tap Switch&#45;&gt;Secret Server</title> <path fill=none stroke=black d="M543.415,-89.4647C557.309,-79.835 575.363,-67.3229 590.661,-56.7199"/> <polygon fill=black stroke=black points="593.073,-59.3069 599.298,-50.7339 589.085,-53.5536 593.073,-59.3069"/> </g> </g> </svg> </div> <h3>Switch configuration</h3> <p>The switch config is where we wire everything together, there are 3 key concepts:</p> <ul> <li>Tap - input</li> <li>Tool - output</li> <li>Tap Group - logical grouping of TAP ports</li> </ul> <p>The configuration is quite simple and <a href="https://www.arista.com/en/um-eos/eos-section-16-3-tap-aggregation-configuration">well documented</a>.</p> <p>First, let's put the switch into tap mode</p> <pre><code>switch&gt;en
switch#configure terminal
switch(config)#tap aggregation
switch(config-tap-agg)#mode exclusive
</code></pre> <p>This will place all switch ports into error disabled and enable tap/tool ports.</p> <p>Next, define our tap ports</p> <pre><code>switch(config)#interface ethernet 1
switch(config-if-Et1)#description Transit Provider 1
switch(config-if-Et1)#switchport mode tap
switch(config-if-Et1)#switchport tool group INTERNET

switch(config)#interface ethernet 2
switch(config-if-Et2)#description Transit Provider 2
switch(config-if-Et2)#switchport mode tap
switch(config-if-Et2)#switchport tool group INTERNET

switch(config)#interface ethernet 3
switch(config-if-Et3)#description Corporate Spine 1
switch(config-if-Et3)#switchport mode tap
switch(config-if-Et3)#switchport tool group CORPORATE

switch(config)#interface ethernet 4
switch(config-if-Et4)#description Corporate Spine 2
switch(config-if-Et4)#switchport mode tap
switch(config-if-Et4)#switchport tool group CORPORATE

switch(config)#interface ethernet 5
switch(config-if-Et5)#description Wan Provider 1
switch(config-if-Et5)#switchport mode tap
switch(config-if-Et5)#switchport tool group WAN

switch(config)#interface ethernet 6
switch(config-if-Et6)#description Wan Provider 2
switch(config-if-Et6)#switchport mode tap
switch(config-if-Et6)#switchport tool group WAN
</code></pre> <p>We now have 3 groups with 3 interfaces in each.</p> <p>Finally, map those groups onto our outputs.</p> <pre><code>switch(config)#interface ethernet 10
switch(config-if-Et10)#description Bro Network Security Monitor
switch(config-if-Et10)#switchport mode tool
switch(config-if-Et10)#switchport tool group set INTERNET WAN

switch(config)#interface ethernet 11
switch(config-if-Et11)#description Secret Server
switch(config-if-Et11)#switchport mode tool
switch(config-if-Et11)#switchport tool group set CORPORATE
</code></pre> <p>Et10 + Et11 will now receive any traffic sent to their relevant groups.</p> <h3>Advanced features</h3> <p>In the demo, we have a static input -> output allocation in real life this can be software controlled or filter based.</p> <p>We could also truncate packets to look at only their headers, potentially useful for encrypted traffic.</p> <p>A simple traffic steering example is as below:</p> <ul> <li>For traffic coming into Eth1</li> <li>Match traffic targeting 8.8.8.8</li> <li>Send to tap group GOOGLE_DNS</li> <li>Send tap group GOOGLE_DNS to Eth20</li> </ul> <pre><code>switch(config)#ip access-list ACL_GOOGLE_DNS
switch(config-acl-ACL_GOOGLE_DNS)#permit ip any 8.8.8.8/32

switch(config)#class-map type tapagg match-any TAP_CLASS_MAP
switch(config-cmap-TAP_CLASS_MAP)#match ip access-group ACL_GOOGLE_DNS

switch(config)#policy-map type tapagg TAP_POLICY
switch(config-pmap-TAP_POLICY)#class TAP_CLASS_MAP
switch(config-pmap-TAP_POLICY-TAP_CLASS_MAP)#set aggregation-group GOOGLE_DNS

switch(config)#interface ethernet 20
switch(config-if-Et20)#description Magic Box
switch(config-if-Et20)#switchport mode tool
switch(config-if-Et20)#switchport tool group set GOOGLE_DNS

switch(config)#interface ethernet1
switch(config-if-Et1)#service-policy type tapagg input TAP_CLASS_MAP
</code></pre> <p>For software-based control, Arista provides a powerful HTTP API as well as XMPP client support and 'on-device' APIs. The Python eAPI client can be found on <a href="https://github.com/arista-eosplus/pyeapi">GitHub</a>, with some <a href="https://github.com/arista-eosplus/pyeapi/tree/develop/examples">examples</a>.</p> <h1>Summary</h1> <p>It is cost effective to deploy tap infrastructure where required. The offering from Arista is very powerful, allowing flexibility to meet any number of requirements.</p> <p>With a number of integration options (JSON API, Python API, XMPP client), having dynamic tapping capabilities is a nice spanner to have in your toolbox.</p> <p>And the cost? Basically, about the same as a 10G switch with routing functionality.</p> <p>Naturally, the cost is varied depending on physical requirements (fibre/copper runs), port speeds (1/10/25/40/100G) and port count; this is applicable to any switch or other tap based deployment.</p> <h2>Footnote</h2> <p>I would advise any tap deployments to be carefully planned, certain topologies, such as multi-stage clos networks do not make good tap targets, both due to the number of links involved and the resulting bandwidth requirements for the TAP infrastructure.</p> <p>Depending on your goals, tapping at natural points of congestion, such as the ingress/egress points for your high performance/bandwidth network segments (transit links, firewalls etc), will likely provide highly useful information at a vastly reduce capture complexity.</p> </div> </article> <section id=related> <h2>Related posts</h2> <ul id=related_posts> <li>&raquo; <a href="/2017/12/decoding-arista-ethertype-headers-with-gopacket/">Decoding Arista EtherType headers with gopacket</a></li> <li>&raquo; <a href="/2017/12/a-look-at-traffic-encryption-options/">A look at traffic encryption options</a></li> <li>&raquo; <a href="/2017/12/cluebot-wikimedia-labs-setup/">ClueBot Wikimedia Labs Setup</a></li> </ul> </section> <section id=comment> <h2>Comments</h2> <div id=disqus_thread aria-live=polite> <noscript>Please enable JavaScript to view the comments</noscript> </div> </section> <script type="text/javascript">var disqus_identifier="http://damianzaremba.co.uk/2017/12/a-look-at-low-cost-tap-aggregation/";var disqus_url="http://damianzaremba.co.uk/2017/12/a-look-at-low-cost-tap-aggregation/";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="http://damianzaremba.disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </div> <footer class=footer> <div class=container> <p class=text-muted>Copyright 2009-2017 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p> <ul id=ads> <li>Need error tracking? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li> <li>Need cloud instances? Jump on <a href="http://www.bigv.io">BigV</a></li> <li>Want my website? <a href="https://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li> </ul> </div> </footer> <script src="/assests/js/jquery.min.js?_v=5790ead7ad3ba27397aedfa3d263b867"></script> <script src="/assests/js/bootstrap.min.js?_v=046ba2b5f4cff7d2eaaa1af55caa9fd8"></script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_require","inpage_linkid","//www.google-analytics.com/plugins/ga/inpage_linkid.js"]);_gaq.push(["_setAccount","UA-11817192-1"]);_gaq.push(["_setDomainName","damianzaremba.co.uk"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src="//stats.g.doubleclick.net/dc.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//damianzaremba.disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> <!--[if lt IE 9]><script src="/assests/js/html5shiv.min.js?_v=3044234175ac91f49b03ff999c592b85"></script> <script src="/assests/js/respond.min.js?_v=afc1984a3d17110449dc90cf22de0c27"></script><![endif]--> </body> </html>