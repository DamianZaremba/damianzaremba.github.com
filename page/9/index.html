<!DOCTYPE HTML> <html> <head> <title>Damian Zaremba - Blog</title> <meta http-equiv=Content-Type content="text/html; charset=UTF-8"/> <meta name=description content="Damian Zaremba's Blog"/> <meta name=copyright content=">Copyright 2009-2013 Damian Zaremba" /> <meta name=google-site-verification content=qykIg-4DghoGe78ET4eRjKG1cx6n3gXvu4jF0FvcwRo /> <meta name=author content="Damian Zaremba"/> <link rel=alternate type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba"/> <meta name=robots content=INDEX /> <meta name=robots content=FOLLOW /> <meta name=robots content="INDEX,FOLLOW"/> <meta name=revisit content="7 days"/> <meta name=classification content=GENERAL /> <meta name=distribution content=GLOBAL /> <meta name=audience content=all /> <meta name=MSSmartTagsPreventParsing content=TRUE /> <link href="/assests/css/main.css" rel=stylesheet type="text/css"/> <link href="/assests/css/pygments.css" rel=stylesheet type="text/css"/> <script src="http://mint.damianzaremba.co.uk/?js" type="text/javascript"></script> <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-11817192-1"]);_gaq.push(["_setDomainName","damianzaremba.co.uk"]);_gaq.push(["_trackPageview"]);(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src=("https:"==document.location.protocol?"https://ssl":"http://www");b.src+=".google-analytics.com/ga.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();</script> <!--[if IE]>/* hover.htc fixes a bunch of issues with hovering objects in IE */ body { behavior: url("/assests/other/hover.htc"); }<![endif]--> </head> <body> <header> <h1><a href="/">Damian Zaremba</a> <span>Blog</span></h1> <nav> <ul id=main> <li><a href="/">Blog</a></li> <li><a href="/archives">Archives</a></li> <li><a href="/about">About</a></li> <li><a href="/cv">CV</a></li> </ul> </nav> <div id=right> <p> <a href="http://twitter.com/DamianZaremba" title=Twitter><img src="/assests/images/twitter.png"/></a> <a href="https://plus.google.com/110559147647328161061" title=GooglePlus><img src="/assests/images/googleplus.png"/></a> <a href="http://facebook.com/DamianZaremba" title=Facebook><img src="/assests/images/facebook.png"/></a> <a href="https://github.com/DamianZaremba" title=GitHub><img src="/assests/images/github.png"/></a> <a href="http://feeds.feedburner.com/DamianZaremba" title=RSS><img src="/assests/images/rss.png"/></a> </p> <form class=search action="http://google.com/search" method=get> <input class=left type=text name=q results=0> <input type=hidden name=q value="site:damianzaremba.co.uk"> </form> </div> </header> <div id=content> <article class=post> <h1 class=title><a href="/2010/12/lots-of-files-to-remove/">Lots of files to remove?</a></h1> <div class=meta> <span><img src="/assests/images/date.png"/>01 Dec 2010</span> <span><img src="/assests/images/comments.png"/><a href="/2010/12/lots-of-files-to-remove/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/foss'>FOSS</a></li><li><a href='/tag/how-to'>How-to</a></li></ul> </div> <div class=entry> <p>So I recently have a few hundred thousand files in /tmp/ (was testing something and needed to remove them all)!</p> <p>Bash as always is very helpful</p> <div class=highlight><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># rm -rf /tmp/*</span>
-bash: /bin/rm: Argument list too long”
</code></pre></div> <p>You also have this issue? Don't worry you can use find and feed the results into rm as follows</p> <div class=highlight><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/ | xargs rm</span>
</code></pre></div> <p>(You could also specify -type f or -type d if you only wanted files or directory, you may need rm -r rather than rm if you want to recurse into directories)</p> <p>If you have seen the output of find previously you will know why this works, if not then here is a quick snippet:</p> <div class=highlight><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/</span>
/tmp/repoup1291034701
/tmp/repoup1291034701/live
/tmp/repoup1291034701/live/.git
</code></pre></div> <p>xargs just converts from standard input to command line arguments as can be seen below:</p> <div class=highlight><pre><code class="bash"><span class="o">[</span>root@localhost<span class="o">]</span><span class="c"># find /tmp/ | head -n 1 | xargs echo rm</span>
rm /tmp/repoup1291034701
</code></pre></div> <p>Hope this helps</p> </div> </article> <article class=post> <h1 class=title><a href="/2010/11/compiling-nginx-and-php-fpm-on-centos-5/">Compiling nginx and PHP-FPM on CentOS 5</a></h1> <div class=meta> <span><img src="/assests/images/date.png"/>29 Nov 2010</span> <span><img src="/assests/images/comments.png"/><a href="/2010/11/compiling-nginx-and-php-fpm-on-centos-5/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/foss'>FOSS</a></li></ul> </div> <div class=entry> <p><a href="http://lukecarrier.me/">Luke Carrier</a>, founder and lead developer at <a href="http://CloudFlux.net">CloudFlux</a> recently wrote a how-to on compiling Nginx and PHP-FPM (can be found <a href="http://lukecarrier.me/?p=59">here</a>). Nginx is well known for being a high-performance HTTP server and reverse proxy, in fact this very website is running on-top of Nginx. A few websites you might know that run Nginx are:</p> <ul> <li><p><a href="http://GitHub.com">GitHub</a></p></li> <li><p><a href="http://Wordpress.com">Wordpress</a></p></li> <li><p><a href="http://Ohloh.net">Ohloh</a></p></li> <li><p><a href="http://CloudFlux.net">CloudFlux</a></p></li> </ul> <p>These sites show how Nginx can be deployed in many high traffic configurations, GitHub being well know for the use of RoR, Wordpress the use of PHP etc. Whether you are deploying PHP under FPM, RoR under Passenger, static files or data from memcached Nginx can outperform many other web servers.</p> <p>The main advantage to using Nginx is it's event-driven (asynchronous) architecture, this means that alongside providing high-performance there is a small predictable memory footprint. All the features make the server a good performer in all environments from single VPS systems to web clusters.</p> <p>Some features you'll probably love:</p> <ul> <li><p>Modules for load balancing</p></li> <li><p>Direct memcached integration</p></li> <li><p>Simple proxy configuration</p></li> <li><p>Passenger integration</p></li> <li><p>Ability to serve over 50,000 simultaneous connections</p></li> <li><p>Statistics module</p></li> <li><p>Low memory footprint</p></li> <li><p>Clean simple to edit configuration files</p></li> <li><p>Zero downtime configuration and binary updates</p></li> <li><p>PCRE based rewrite rules</p></li> </ul> <p>As you can see from <a href="http://wiki.nginx.org/NginxWhyUseIt">their site</a> Nginx as a server is highly regarded and recommended. I'd suggest taking a look, having a play and revealing what it can do for you.</p> </div> </article> <article class=post> <h1 class=title><a href="/2010/10/job-change-house-move-and-more/">Job change, house move and more</a></h1> <div class=meta> <span><img src="/assests/images/date.png"/>06 Oct 2010</span> <span><img src="/assests/images/comments.png"/><a href="/2010/10/job-change-house-move-and-more/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/work'>Work</a></li><li><a href='/tag/7tha'>7tha</a></li><li><a href='/tag/ukfast'>UKFast</a></li></ul> </div> <div class=entry> <p>So yeah it's been a busy few months. I've finished my new server setup, ready to move mail onto it. Moved flats. Made loads of progress in a project and got let go from a job.</p> <p>I moved from Bury to Manchester a month ago, it's strange living in the city it's like the world never sleeps. Currently still have a messy flat as I haven't completely un-packed but things are getting there. Hopefully won't have to move any time soon as the last time was a bit of a nightmare. Moving into the center might help improve my current non existent social life or maybe just give me reason to be in an office 24/7 working (tbc). In other news the 7th A Rochdale scout groups website had a bunch of issues completed over the last few weeks, once the images are all done and I can write the actual text content then we should be good to get it online and hopefully expand the group even further! Shame I'm not the best designer but I should be able to do a better job than the current "made in word" version ;)</p> <p>As well as all the fun times had recently I've also got a bit of a change work wise, after being "let go" from my current job at UKFast I've decided to try and find a small passionate company where I can really have an impact and do what I enjoy. Unfortunately the job I did have wasn't right for me as there was little room for diversity within the role or change.</p> <p>Currently I'm looking for a passionate small/start-up company where I can utilize my current skills, learn a lot and dedicate my time to making a difference.</p> <p>Thanks to everyone at UKFast for the fun times, advise and support. Maybe one day we will work together once again.</p> </div> </article> <article class=post> <h1 class=title><a href="/2010/09/time/">Time</a></h1> <div class=meta> <span><img src="/assests/images/date.png"/>14 Sep 2010</span> <span><img src="/assests/images/comments.png"/><a href="/2010/09/time/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/general'>General</a></li></ul> </div> <div class=entry> <p>Time is a funny thing, in one sense you seem to achieve a lot in a short amount but from another point of view you haven't even dipped your toe into the water. School, college, unit is starting again with the people working hard to pass exams and start their lives, choices we make in life seem insignificant at the time however the time passes so quickly and you don't even realise it.</p> <p>Personally I never did the whole college and uni thing, it is something that in one sense I regret but in another it's something I am proud of. The choice for me was simple, waste 5/6 years 'studying' things that weren't relevant to what I wanted to do to get a piece of paper and a few grand worth of debt or dive in at the deep end and try not to sink.</p> <p>After leaving school I pretty much wasted a year, during the time I did pretty much run a small hosting company with some friends and decide on what I was going to do going forwards but all in all progress was not anything to comment on. After passing some random exams I got my current job and that’s where I'm pretty much at now looking forward to passing some other exams and progressing my career.</p> <p>Tonight I've just been reminded that it was two years ago I left School where the projects ended and the search began, an analysis of the time spent since then yields mixed feelings. Bearing in mind I pretty much want to have filled most my career ambitions by the time I'm 20 I take the following from this reflection.</p> <p>I regret not going to college/uni - This would of let me grow as a person however could of potentially prevented my career from starting and left me without the opportunities I'm currently chasing. The main disadvantages are not being able to socialize, gain experience in certain areas such as student radio that I would of loved to have been a part of.</p> <p>I'm glad I went the hard way - Life's value is clear to me now, you have to run at every opportunity you get and never let one pass you buy. With confidence you can be much better than you currently think you are.  If I didn't chose the path I did then I most likely would not be sat in my of flat across the road from the office where I work as a Linux engineer and I wouldn't have the opportunities presented to me that I do right at this very moment.</p> <p>Time moves so very quickly and you don't often stop to think about what you have achieved. It is easy to see how far you have to go to meet your goal and think there is never any chance of hitting them but if you step back for a moment and look at where you have been and how far you have travelled then you can see there is every chance of smashing your goals.</p> <p>Slight ramble but the general point being never let anyone tell you that you can't do something, there is always a way even if you have to fight against everyone to get there. Opportunities will present themselves when needed and belief is something you should never change for other people. Time will run away from you but every so often step back and look at how much you've done - it will be amazing.</p> </div> </article> <article class=post> <h1 class=title><a href="/2010/07/powershell/">Powershell!?!?!?!</a></h1> <div class=meta> <span><img src="/assests/images/date.png"/>21 Jul 2010</span> <span><img src="/assests/images/comments.png"/><a href="/2010/07/powershell/#disqus_thread">Comments</a></span> <ul id=categories> <li><a href='/tag/fun'>Fun</a></li></ul> </div> <div class=entry> <p>Most of been bored last night, decided to have my first bash at automation in windows using powershell, kinda impressed but now where near the level that you can get in *nix :D Hack of an attempt can be seen below (it works mainly but is pretty untested for the function actions as I don't have a windows server that can run hyperv, looks right per the docs though!):</p> <div class=highlight><pre><code class="powershell"><span class="c"># Settings</span>

<span class="c">## Email</span>

<span class="nv">$email_system</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>

<span class="nv">$email_contact</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>

<span class="nv">$email_host</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span>

<span class="nv">$email_username</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span>

<span class="nv">$email_password</span> <span class="p">=</span> <span class="s1">&#39;&#39;</span>
<span class="c">## Database</span>

<span class="nv">$database_host</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>

<span class="nv">$database_name</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>

<span class="nv">$database_user</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>

<span class="nv">$database_pass</span> <span class="p">=</span> <span class="s2">&quot;&quot;</span>
<span class="c">## Run task settings</span>

<span class="nv">$run_tasks</span> <span class="p">=</span> <span class="n">1</span>

<span class="nv">$run_reboots</span> <span class="p">=</span> <span class="n">1</span>

<span class="nv">$run_poweroffs</span> <span class="p">=</span> <span class="n">1</span>

<span class="nv">$run_powerups</span> <span class="p">=</span> <span class="n">1</span>
<span class="c"># Log file directory</span>

<span class="nv">$file_log_dir</span> <span class="p">=</span> <span class="s1">&#39;C:\automation_logs\&#39;</span>
<span class="c">#</span>

<span class="c">#</span>

<span class="c">#</span>

<span class="c"># Don&#39;t touch below here</span>

<span class="c">#</span>

<span class="c">#</span>

<span class="c">#</span>
<span class="c"># Session varibles</span>
<span class="nv">$base_log_name</span> <span class="p">=</span> <span class="nv">$file_log_dir</span><span class="p">+$(</span><span class="nb">Get-Date</span> <span class="n">-format</span> <span class="s1">&#39;d-M-y-h-m-s&#39;</span><span class="p">)+</span><span class="s1">&#39;-&#39;</span>
<span class="c"># Functions</span>
<span class="c">## Core functions</span>

<span class="k">function</span> <span class="n">log</span><span class="p">(</span><span class="no">[string]</span><span class="nv">$message</span><span class="p">,</span> <span class="no">[string]</span><span class="nv">$type</span> <span class="p">=</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">if</span> <span class="p">((</span><span class="nb">Test-Path</span> <span class="n">-path</span> <span class="nv">$file_log_dir</span><span class="p">)</span> <span class="o">-ne</span> <span class="nv">$True</span><span class="p">){</span>

<span class="c"># Make log dir if it dosn&#39;t exist</span>

<span class="nb">write-host</span> <span class="s1">&#39;Making log dir&#39;</span>

<span class="nb">New-Item</span> <span class="nv">$file_log_dir</span> <span class="n">-type</span> <span class="n">directory</span>

<span class="p">}</span>
<span class="nv">$log_file</span> <span class="p">=</span> <span class="nv">$base_log_name</span><span class="p">+$(</span><span class="nv">$type</span><span class="p">)+</span><span class="s1">&#39;.log&#39;</span>

<span class="nb">write-host</span> <span class="nv">$message</span>

<span class="nb">add-content</span> <span class="nv">$log_file</span> <span class="nv">$message</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">error</span><span class="p">(</span><span class="no">[string]</span><span class="nv">$traceback</span><span class="p">)</span>

<span class="p">{</span>

<span class="nv">$error</span> <span class="p">=</span> <span class="s1">&#39;Hit exception:&#39;</span><span class="p">+</span><span class="nv">$traceback</span>

<span class="n">log</span> <span class="nv">$error</span> <span class="s1">&#39;error&#39;</span>

<span class="n">mail</span> <span class="s1">&#39;Exception encountered&#39;</span> <span class="nv">$error</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">mail</span><span class="p">(</span><span class="no">[string]</span><span class="nv">$subject</span><span class="p">,</span> <span class="no">[string]</span><span class="nv">$message</span><span class="p">)</span>

<span class="p">{</span>

<span class="c">#$smtp_handler = new-object Net.Mail.SmtpClient($email_host)</span>

<span class="c">#$smtp_handler.Credentials = New-Object System.Net.NetworkCredential($email_username, $email_password)</span>

<span class="c">#$smtp_handler.Send($email_system, $email_contact, $subject, $message)</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">marktaskFailed</span><span class="p">(</span><span class="no">[int]</span><span class="nv">$task_id</span><span class="p">)</span>

<span class="p">{</span>

<span class="nv">$time</span> <span class="p">=</span> <span class="no">[int][double]</span><span class="err">::</span><span class="n">Parse</span><span class="p">((</span><span class="nb">Get-Date</span> <span class="n">-UFormat</span> <span class="k">%</span><span class="n">s</span><span class="p">))</span>
<span class="k">try</span> <span class="p">{</span>
 <span class="nv">$command</span> <span class="p">=</span> <span class="nv">$database_handler</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">()</span>
 <span class="nv">$command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s2">&quot;update queue set status = &#39;f&#39;, run_time = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">time)</span><span class="s2">&#39; where id = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task_id)</span><span class="s2">&#39;&quot;</span>

<span class="nv">$command</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">()</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not set status = failed for task id $task_id&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="p">}</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">marktaskSuccess</span><span class="p">(</span><span class="no">[int]</span><span class="nv">$task_id</span><span class="p">)</span>

<span class="p">{</span>

<span class="nv">$time</span> <span class="p">=</span> <span class="no">[int][double]</span><span class="err">::</span><span class="n">Parse</span><span class="p">((</span><span class="nb">Get-Date</span> <span class="n">-UFormat</span> <span class="k">%</span><span class="n">s</span><span class="p">))</span>
<span class="k">try</span> <span class="p">{</span>

<span class="nv">$command</span> <span class="p">=</span> <span class="nv">$database_handler</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">()</span>

<span class="nv">$command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s2">&quot;update queue set status = &#39;c&#39;, run_time = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">time)</span><span class="s2">&#39; where id = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task_id)</span><span class="s2">&#39;&quot;</span>

<span class="nv">$command</span><span class="p">.</span><span class="n">ExecuteNonQuery</span><span class="p">()</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not set status = complete for task id $task_id&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="p">}</span>

<span class="p">}</span>
<span class="c">## Action functions</span>

<span class="k">function</span> <span class="n">rebootHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>

<span class="p">{</span>

<span class="c"># Un-tested bit but this is right according to the bizzare docs</span>

<span class="nv">$vm</span> <span class="p">=</span> <span class="n">gwmi</span> <span class="n">-namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">virtualization</span> <span class="n">-query</span> <span class="s2">&quot;SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;machine_id&#39;])</span><span class="s2">&#39;&quot;</span>

<span class="nv">$result</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">InitiateShutdown</span><span class="p">(</span><span class="s2">&quot;$true&quot;</span><span class="p">,</span> <span class="s2">&quot;Automated shutdown requested&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">.</span><span class="n">returnvalue</span> <span class="o">-match</span> <span class="s2">&quot;0&quot;</span><span class="p">){</span>

<span class="nv">$vm</span> <span class="p">=</span> <span class="n">gwmi</span> <span class="n">-namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">virtualization</span> <span class="n">-query</span> <span class="s2">&quot;SELECT * FROM msvm_computersystem WHERE SystemName = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;machine_id&#39;])</span><span class="s2">&#39;&quot;</span>

<span class="nv">$result</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">requeststatechange</span><span class="p">(</span><span class="n">2</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">.</span><span class="n">returnvalue</span> <span class="o">-match</span> <span class="s2">&quot;0&quot;</span><span class="p">){</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with success status&quot;</span>

<span class="n">marktaskSuccess</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with failed status, could not issue powerup&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with failed status, could not shutdown vm&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">poweroffHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>

<span class="p">{</span>

<span class="c"># Un-tested bit but this is right according to the bizzare docs</span>

<span class="nv">$vm</span> <span class="p">=</span> <span class="n">gwmi</span> <span class="n">-namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">virtualization</span> <span class="n">-query</span> <span class="s2">&quot;SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;machine_id&#39;])</span><span class="s2">&#39;&quot;</span>

<span class="nv">$result</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">InitiateShutdown</span><span class="p">(</span><span class="s2">&quot;$true&quot;</span><span class="p">,</span> <span class="s2">&quot;Automated shutdown requested&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">.</span><span class="n">returnvalue</span> <span class="o">-match</span> <span class="s2">&quot;0&quot;</span><span class="p">){</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with success status&quot;</span>

<span class="n">marktaskSuccess</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with failed status, could not issue reboot&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span>

<span class="p">}</span>
<span class="k">function</span> <span class="n">poweronHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>

<span class="p">{</span>

<span class="c"># Un-tested bit but this is right according to the bizzare docs</span>

<span class="nv">$vm</span> <span class="p">=</span> <span class="n">gwmi</span> <span class="n">-namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">virtualization</span> <span class="n">-query</span> <span class="s2">&quot;SELECT * FROM msvm_computersystem WHERE SystemName = &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;machine_id&#39;])</span><span class="s2">&#39;&quot;</span>

<span class="nv">$result</span> <span class="p">=</span> <span class="nv">$vm</span><span class="p">.</span><span class="n">requeststatechange</span><span class="p">(</span><span class="n">2</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">.</span><span class="n">returnvalue</span> <span class="o">-match</span> <span class="s2">&quot;0&quot;</span><span class="p">){</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with success status&quot;</span>

<span class="n">marktaskSuccess</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; (</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">) completed with failed status, could not issue powerup&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span>

<span class="p">}</span>

<span class="p">&amp;</span><span class="n">nbsp</span><span class="err">;</span>

<span class="c"># Main code</span>
<span class="c">## Load what we need!</span>

<span class="k">try</span><span class="p">{</span>

<span class="no">[void][System.Reflection.Assembly]</span><span class="err">::</span><span class="n">LoadWithPartialName</span><span class="p">(</span><span class="s2">&quot;MySql.Data&quot;</span><span class="p">)</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not load mysql.net connector&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="k">break</span>

<span class="p">}</span>
<span class="c">## Main loop</span>

<span class="k">while</span> <span class="p">(</span><span class="n">1</span><span class="p">)</span> <span class="p">{</span>

<span class="nb">write-host</span> <span class="s1">&#39;Doing run....&#39;</span>
<span class="c">## Connect to the database</span>

<span class="k">try</span><span class="p">{</span>

<span class="nv">$database_handler</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">MySql</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">MySqlClient</span><span class="p">.</span><span class="n">MySqlConnection</span>

<span class="nv">$database_handler</span><span class="p">.</span><span class="n">ConnectionString</span> <span class="p">=</span> <span class="s2">&quot;server=$database_host;uid=$database_user;pwd=$database_pass;database=$database_name;&quot;</span>

<span class="nv">$database_handler</span><span class="p">.</span><span class="n">Open</span><span class="p">()</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not connect to the database :(&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="k">break</span>

<span class="p">}</span>
<span class="nb">write-host</span> <span class="s1">&#39;Connected to database&#39;</span>
<span class="k">try</span> <span class="p">{</span>

<span class="nv">$command</span> <span class="p">=</span> <span class="nv">$database_handler</span><span class="p">.</span><span class="n">CreateCommand</span><span class="p">()</span>

<span class="nv">$command</span><span class="p">.</span><span class="n">CommandText</span> <span class="p">=</span> <span class="s2">&quot;select * from `queue` where `status` = &#39;n&#39;&quot;</span>

<span class="nv">$data</span> <span class="p">=</span> <span class="nv">$command</span><span class="p">.</span><span class="n">ExecuteReader</span><span class="p">()</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not run query against database&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="k">continue</span>

<span class="p">}</span>
<span class="nb">write-host</span> <span class="s1">&#39;Got queue from database&#39;</span>
<span class="c"># Array where we will put our tasks!</span>

<span class="nv">$tasks_to_run</span> <span class="p">=</span> <span class="err">@</span><span class="p">()</span>
<span class="nb">write-host</span> <span class="s1">&#39;Loading queue&#39;</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$data</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span> <span class="p">{</span>

<span class="c"># task</span>

<span class="k">try</span> <span class="p">{</span>

<span class="nv">$task</span> <span class="p">=</span> <span class="err">@</span><span class="p">{}</span>

<span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$data</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">1</span><span class="p">).</span><span class="n">ToString</span><span class="p">()</span>

<span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$data</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">0</span><span class="p">).</span><span class="n">ToString</span><span class="p">()</span>

<span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;machine_id&#39;</span><span class="p">]</span> <span class="p">=</span> <span class="nv">$data</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">3</span><span class="p">).</span><span class="n">ToString</span><span class="p">()</span>
<span class="c"># Add task to list of tasks to run</span>

<span class="nv">$tasks_to_run</span> <span class="p">+=</span> <span class="nv">$task</span>

<span class="nb">write-host</span> <span class="s2">&quot;Entered task </span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2"> into queue&quot;</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>

<span class="n">log</span> <span class="s2">&quot;Could not add task to queue&quot;</span>

<span class="n">error</span> <span class="nv">$_</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="k">continue</span>

<span class="p">}</span>

<span class="p">}</span>

<span class="nv">$data</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the data reader</span>

<span class="nb">write-host</span> <span class="s1">&#39;Loaded queue&#39;</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$tasks_to_run</span><span class="p">.</span><span class="n">length</span> <span class="o">-gt</span> <span class="n">0</span><span class="p">){</span>

<span class="nb">write-host</span> <span class="s2">&quot;Tasks to run: </span><span class="si">$(</span><span class="err">$</span><span class="si">tasks_to_run.length)</span><span class="s2">!&quot;</span>
<span class="c"># Loop though the list of tasks to run</span>

<span class="k">for</span> <span class="p">(</span> <span class="nv">$i</span> <span class="p">=</span> <span class="n">0</span> <span class="err">;</span> <span class="nv">$i</span> <span class="o">-lt</span> <span class="nv">$tasks_to_run</span><span class="p">.</span><span class="n">length</span><span class="err">;</span> <span class="nv">$i</span><span class="p">++</span> <span class="p">){</span>

<span class="nv">$task</span> <span class="p">=</span> <span class="nv">$tasks_to_run</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span>
<span class="n">log</span> <span class="s2">&quot;Running task </span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2"> (Action &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">&#39; for instance &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;machine_id&#39;])</span><span class="s2">&#39;)&quot;</span>
 <span class="k">if</span><span class="p">(</span><span class="nv">$run_tasks</span> <span class="o">-eq</span> <span class="n">1</span><span class="p">){</span>

<span class="c"># The bit that decides what we are going to do</span>

<span class="k">switch</span> <span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="p">{</span>

<span class="n">poweron</span> <span class="p">{</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$run_powerups</span> <span class="o">-eq</span> <span class="n">1</span><span class="p">){</span>

<span class="p">&amp;</span><span class="n">poweronHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
 <span class="n">log</span> <span class="s2">&quot;Not running task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39;, powerup tasks are disabled&quot;</span>
 <span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>
 <span class="p">}</span>

<span class="p">}</span>
<span class="n">poweroff</span> <span class="p">{</span>
 <span class="k">if</span><span class="p">(</span><span class="nv">$run_poweroffs</span> <span class="o">-eq</span> <span class="n">1</span><span class="p">){</span>

<span class="p">&amp;</span><span class="n">poweroffHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
 <span class="n">log</span> <span class="s2">&quot;Not running task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39;, poweroff tasks are disabled&quot;</span>
 <span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>
 <span class="p">}</span>

<span class="p">}</span>
<span class="n">reboot</span> <span class="p">{</span>
 <span class="k">if</span><span class="p">(</span><span class="nv">$run_reboots</span> <span class="o">-eq</span> <span class="n">1</span><span class="p">){</span>

<span class="p">&amp;</span><span class="n">rebootHyperVInstance</span><span class="p">(</span><span class="nv">$task</span><span class="p">)</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
 <span class="n">log</span> <span class="s2">&quot;Not running task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39;, reboot tasks are disabled&quot;</span>
 <span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>
 <span class="p">}</span>

<span class="p">}</span>
<span class="k">default</span> <span class="p">{</span> <span class="c"># We were asked to do something we don&#39;t understand!</span>

<span class="n">log</span> <span class="s2">&quot;Tried to run an unknown action: &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">&#39; for task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; this will need running manually!&quot;</span>

<span class="n">mail</span> <span class="s2">&quot;Tried to run an unknown action: &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;type&#39;])</span><span class="s2">&#39; for task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39; this will need running manually!&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>

<span class="p">}</span>

<span class="p">}</span>
 <span class="p">}</span><span class="k">else</span><span class="p">{</span>
 <span class="n">log</span> <span class="s2">&quot;Not running task &#39;</span><span class="si">$(</span><span class="err">$</span><span class="si">task[&#39;task_id&#39;])</span><span class="s2">&#39;, tasks are disabled&quot;</span>

<span class="n">marktaskFailed</span><span class="p">(</span><span class="nv">$task</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">])</span>
 <span class="p">}</span>

<span class="p">}</span>

<span class="nb">write-host</span> <span class="s1">&#39;Tasks run&#39;</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="nb">write-host</span> <span class="s2">&quot;No tasks to run!&quot;</span>

<span class="p">}</span>
<span class="nb">write-host</span> <span class="s1">&#39;Run complete....&#39;</span>

<span class="c"># Sleep 10 seconds until next run</span>

<span class="nb">Start-Sleep</span> <span class="n">10</span>

<span class="p">}</span>
</code></pre></div> <p>Anyway back to making this CSS I'm working on look half decent in IE!</p> </div> </article> <nav id=page_nav> <a href="/page/8/" class=prev>&laquo; Previous Page</a> <a href="/page/10/" class=next>Next Page &raquo;</a> </nav> </div> <footer> <p class=copyright>Copyright 2009-2013 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p> <p class=ads> <ul id=ads> <li>Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li> <li>Need hosting? Try <a href="http://www.vision108.com/">Vision180</a></li> <li>Want my website? <a href="http://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li> </ul> </p> </footer> <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script> <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script> <script type="text/javascript">!window.jQuery&&document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'));</script><![endif]--> <script type="text/javascript">!window.jQuery&&document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'));var disqus_shortname="damianzaremba";var disqus_script="count.js";(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="http://"+disqus_shortname+".disqus.com/"+disqus_script;(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script> </body> </html>