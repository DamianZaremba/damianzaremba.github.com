<!DOCTYPE HTML>
<html>
<head>
    <title>Damian Zaremba - Blog</title>

    <!-- General meta data -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Damian Zaremba's Blog" />
    <meta name="copyright" content=">Copyright 2009-2012 Damian Zaremba" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />
    <meta name="revisit" content="7 days" />

    <!-- M$ meta data -->
    <meta name="classification" content="GENERAL" />
    <meta name="distribution" content="GLOBAL" />
    <meta name="audience" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="TRUE" />

    <!-- CSS files -->
    <link href="/assests/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS files -->
    <script src="http://mint.damianzaremba.co.uk/?js" type="text/javascript"></script>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11817192-1']);
        _gaq.push(['_setDomainName', 'damianzaremba.co.uk']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www');
            ga.src += '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=126887194078923";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        window.___gcfg = {lang: 'en-GB'};
        (function() {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();
    </script>

    <!-- IE fixes -->
    <!--[if IE]>
        /* hover.htc fixes a bunch of issues with hovering objects in IE */
        body {
            behavior: url("/assests/other/hover.htc");
        }
    <![endif]-->

    <!--
    Site rendered at: 2012-08-18 16:46:41 +0100 by Jekyll.
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
</head>

<body>
    <header>
        <h1><a href="/">Damian Zaremba</a></h1>

        <nav class="menu">
            <ul class="main">
               <li><a href="/">Blog</a></li>
               <li><a href="/archives">Archives</a></li>
               <li><a href="/about">About</a></li>
            </ul>
        </nav>

        <div class="right">
            <form class="search" action="http://google.com/search" method="get">
                <input class="left" type="text" name="q" results="0">
                <input type="hidden" name="q" value="site:damianzaremba.co.uk">
            </form>
        </div>
</header>

<div id="content">

	
	<article class="post">
	    <h1 class="title"><a href="/2010/06/5min-hack-in-python/">5min hack in python</a></h1>
	    <div class="entry">
	        <p>So I was trying to test some SELlinux stuff out on my KVM box and was getting flooded by tail -f thanks to someone trying to brute force my box (good luck by the way because a) password auth is disabled and b) root login is disabled >.>) anyway I got bored of this for about 5min then spent the next 5min writing this:</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">bannedHosts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">failedHosts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ignoredIPs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">failLimit</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Better change this</span>
<span class="n">bannedChain</span> <span class="o">=</span> <span class="s">&quot;Hackor&quot;</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;iptables -N </span><span class="si">%s</span><span class="s"> &amp;&gt;/dev/null&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">))</span>
<span class="n">iptables</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;iptables --list </span><span class="si">%s</span><span class="s"> -n | egrep -v </span><span class="se">\&quot;</span><span class="s">target.+prot.+opt.+source.+destination</span><span class="se">\&quot;</span><span class="s"> | egrep -v </span><span class="se">\&quot;</span><span class="s">Chain </span><span class="si">%s</span><span class="s"> .+ references</span><span class="se">\&quot;</span><span class="s"> | awk &#39;{print $4}&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">,</span> <span class="n">bannedChain</span><span class="p">))</span>
<span class="k">for</span> <span class="n">bannedIP</span> <span class="ow">in</span> <span class="n">iptables</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="n">bannedHosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bannedIP</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

<span class="n">loginFailures</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;grep failure /var/log/secure | grep pam | awk -F </span><span class="se">\&quot;</span><span class="s">rhost=</span><span class="se">\&quot;</span><span class="s"> &#39;{print $2}&#39; | awk &#39;{print $1}&#39; | uniq --count&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loginFailures</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
 <span class="k">try</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="n">host</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
 <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">host</span>

<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">failLimit</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is currently over fail limit, processing&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>

<span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">bannedHosts</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is allready banned, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
 <span class="k">continue</span>

<span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ignoredIPs</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is an ingored ip, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">)</span>
 <span class="k">continue</span>

<span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> not allready banned, banning for </span><span class="si">%s</span><span class="s"> failed attempts&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
 <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;iptables -A </span><span class="si">%s</span><span class="s"> -s </span><span class="si">%s</span><span class="s"> -j DROP&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bannedChain</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
 <span class="k">else</span><span class="p">:</span>
 <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is currently under fail limit, ignoring&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span>
</code></pre>
</div>


<p>Which happens to nicely do the job as can be seen below:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@virtual1 ~<span class="o">]</span><span class="c"># ./die_hackorz.py</span>
213.225.207.41 is currently over fail limit, processing
mx-pool207-res41.momax.it not allready banned, banning <span class="k">for </span>15 failed attempts
88.191.92.219 is currently over fail limit, processing
sd-15684.dedibox.fr not already banned, banning <span class="k">for </span>1317 failed attempts
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
sd-15684.dedibox.fr is currently under fail limit, ignoring
81.5.150.24 is currently under fail limit, ignoring
88.191.92.219 is currently over fail limit, processing
sd-15684.dedibox.fr not already banned, banning <span class="k">for </span>1014 failed attempts
114.207.245.128 is currently over fail limit, processing
114.207.245.128 not already banned, banning <span class="k">for </span>1350 failed attempts
62.182.30.165 is currently over fail limit, processing
30-165.kartel.komi.me not already banned, banning <span class="k">for </span>171 failed attempts
</code></pre>
</div>


<p>Oh yeah and I know the code is rubbish, it was very much a make it work thing ;) Also even though this "makes" the chain in iptables you still need to do:</p>

<div class="highlight"><pre><code class="bash">iptables -I INPUT -j Hackor
iptables -I OUTPUT -j Hackor
iptables -I FORWARD -j Hackor
</code></pre>
</div>


<p>Because I didn't add in any code to check if they existed, nor the chain for that matter. Without them traffic won't get processed by these rules, also make sure they go near the top above any other allow rule C=</p>

	    </div>
	</article>
	
	<article class="post">
	    <h1 class="title"><a href="/2010/05/the-difference/">The difference</a></h1>
	    <div class="entry">
	        <p>I have nothing but python to post at the moment so I shall post the difference instead! Once I have some cool stable python up I will be posting more.
<a href="http://damianzaremba.co.uk/wp-content/uploads/2010/05/the_difference.jpg"><img src="http://damianzaremba.co.uk/wp-content/uploads/2010/05/the_difference.jpg" alt="" /></a></p>

	    </div>
	</article>
	
	<article class="post">
	    <h1 class="title"><a href="/2010/04/why-i-love-python/">Why I love Python</a></h1>
	    <div class="entry">
	        <p>So I've been playing with python a lot recently and it is just so amazing!</p>

<p>Here are some quick example that all took less than 10mins to write:</p>

<p>SMTP proxy to allow you to connect to a server via the specified port and it be silently forwarded to another server on another port! (Note it's a bad idea to use localhost as it will make you an open proxy)</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Meta data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">__author__</span><span class="o">=</span><span class="s">&quot;Damian Zaremba&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Import modules</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">smtpd</span>
<span class="kn">import</span> <span class="nn">asyncore</span>

<span class="n">smtpd</span><span class="o">.</span><span class="n">PureProxy</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">2535</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;mail.damianzaremba.co.uk&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</code></pre>
</div>


<p>Email parser to allow you to process email using a IMAP connection. This is really slow atm and would be improved massively by threading but it's still really cool and took about 10min to write!</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Meta data</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">__author__</span><span class="o">=</span><span class="s">&quot;Damian Zaremba&quot;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Import modules</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">imaplib</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="n">MH</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4</span><span class="p">(</span><span class="s">&#39;mail.damianzaremba.co.uk&#39;</span><span class="p">)</span>
<span class="n">MH</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">&#39;inboximporter-text@damianzaremba.co.uk&#39;</span><span class="p">,</span> <span class="s">&#39;testy&#39;</span><span class="p">)</span>
<span class="n">MH</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;INBOX&#39;</span><span class="p">)</span>

<span class="n">emails</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">MH</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;ALL&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
 <span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">MH</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s">&#39;(RFC822)&#39;</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s">&#39;OK&#39;</span><span class="p">:</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">attachments</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

<span class="n">email_data</span> <span class="o">=</span> <span class="n">emails</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
 <span class="s">&#39;message_id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;from&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;to&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s">&#39;attachments&#39;</span><span class="p">:</span> <span class="p">[]</span>
 <span class="p">}</span>

<span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">value</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
 <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Message-ID:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;message_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Date:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;Subject:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;From:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
 <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;To:&#39;</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
 <span class="n">email_data</span><span class="p">[</span><span class="s">&#39;attachments&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attachment</span><span class="p">)</span>

<span class="n">MH</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">MH</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
<span class="k">print</span> <span class="n">emails</span>
</code></pre>
</div>


<p>Now I just need to learn Django properly and I can do some really cool socket based interfaces to things! Hopefully if I can get what I'm working on at the moment to function correctly I can reveal some cool things in the future!</p>

	    </div>
	</article>
	


<nav id="page_nav">
	
    <a href="" class="prev">Previous</a>
    

    <a href="/archives/" class="center">Blog Archives</a>

	
</nav>
</div>

<footer>
    <p class="copyright">Copyright 2009-2012 Damian Zaremba</p>
    <p class="ads">
        <ul class="ads">
            <li>Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li>
            <li>Need hosting? Try <a href="http://www.vision108.com/">Vision180</a></li>
        </ul>
    </p>
</footer>

<script src="/assests/js/jquery.fancybox.pack.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
<![endif]-->

<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))

    var disqus_shortname = 'damianzaremba';
    var disqus_script = 'count.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</body>
</html>