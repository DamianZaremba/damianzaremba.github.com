<!DOCTYPE HTML>
<html>
<head>
    <title>Damian Zaremba - Blog</title>

    <!-- General meta data -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Damian Zaremba's Blog" />
    <meta name="copyright" content=">Copyright 2009-2012 Damian Zaremba" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />
    <meta name="revisit" content="7 days" />

    <!-- M$ meta data -->
    <meta name="classification" content="GENERAL" />
    <meta name="distribution" content="GLOBAL" />
    <meta name="audience" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="TRUE" />

    <!-- CSS files -->
    <link href="/assests/css/main.css" rel="stylesheet" type="text/css" />

    <!-- JS files -->
    <script src="http://mint.damianzaremba.co.uk/?js" type="text/javascript"></script>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-11817192-1']);
        _gaq.push(['_setDomainName', 'damianzaremba.co.uk']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www');
            ga.src += '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=126887194078923";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        window.___gcfg = {lang: 'en-GB'};
        (function() {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();
    </script>

    <!-- IE fixes -->
    <!--[if IE]>
        /* hover.htc fixes a bunch of issues with hovering objects in IE */
        body {
            behavior: url("/assests/other/hover.htc");
        }
    <![endif]-->

    <!--
    Site rendered at: 2012-08-19 00:37:20 +0100 by Jekyll.
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
</head>

<body>
    <header>
        <h1><a href="/">Damian Zaremba</a> <span>Blog</span></h1>

        <nav>
            <ul id="main">
               <li><a href="/">Blog</a></li>
               <li><a href="/archives">Archives</a></li>
               <li><a href="/about">About</a></li>
               <li><a href="/cv">CV</a></li>
            </ul>
        </nav>

        <div id="right">
            <p>
                <a href="http://twitter.com/DamianZaremba" title="Twitter"><img src="/assests/images/twitter.png" /></a>
                <a href="https://github.com/DamianZaremba" title="GitHub"><img src="/assests/images/github.png" /></a>
                <a href="http://feeds.feedburner.com/DamianZaremba" title="RSS"><img src="/assests/images/rss.png" /></a>
            </p>
            <form class="search" action="http://google.com/search" method="get">
                <input class="left" type="text" name="q" results="0">
                <input type="hidden" name="q" value="site:damianzaremba.co.uk">
            </form>
        </div>
</header>

<div id="content">

	
	<article class="post">
	    <h1 class="title"><a href="/2010/09/time/">Time</a></h1>
	    <div class="meta">
        	<span><img src="/assests/images/date.png" />14 Sep 2010</span>
        	<span><img src="/assests/images/comments.png" /><a href="/2010/09/time/#disqus_thread">Comments</a></span>
 			
	        	<ul id="categories">
	        	<li><a href='General'>General</a></li></ul>
	    	
	    </div>
	    <div class="entry">
	        <p>Time is a funny thing, in one sense you seem to achieve a lot in a short amount but from another point of view you haven't even dipped your toe into the water. School, college, unit is starting again with the people working hard to pass exams and start their lives, choices we make in life seem insignificant at the time however the time passes so quickly and you don't even realise it.</p>

<p>Personally I never did the whole college and uni thing, it is something that in one sense I regret but in another it's something I am proud of. The choice for me was simple, waste 5/6 years 'studying' things that weren't relevant to what I wanted to do to get a piece of paper and a few grand worth of debt or dive in at the deep end and try not to sink.</p>

<p>After leaving school I pretty much wasted a year, during the time I did pretty much run a small hosting company with some friends and decide on what I was going to do going forwards but all in all progress was not anything to comment on. After passing some random exams I got my current job and that’s where I'm pretty much at now looking forward to passing some other exams and progressing my career.</p>

<p>Tonight I've just been reminded that it was two years ago I left School where the projects ended and the search began, an analysis of the time spent since then yields mixed feelings. Bearing in mind I pretty much want to have filled most my career ambitions by the time I'm 20 I take the following from this reflection.</p>

<p>I regret not going to college/uni - This would of let me grow as a person however could of potentially prevented my career from starting and left me without the opportunities I'm currently chasing. The main disadvantages are not being able to socialize, gain experience in certain areas such as student radio that I would of loved to have been a part of.</p>

<p>I'm glad I went the hard way - Life's value is clear to me now, you have to run at every opportunity you get and never let one pass you buy. With confidence you can be much better than you currently think you are.  If I didn't chose the path I did then I most likely would not be sat in my of flat across the road from the office where I work as a Linux engineer and I wouldn't have the opportunities presented to me that I do right at this very moment.</p>

<p>Time moves so very quickly and you don't often stop to think about what you have achieved. It is easy to see how far you have to go to meet your goal and think there is never any chance of hitting them but if you step back for a moment and look at where you have been and how far you have travelled then you can see there is every chance of smashing your goals.</p>

<p>Slight ramble but the general point being never let anyone tell you that you can't do something, there is always a way even if you have to fight against everyone to get there. Opportunities will present themselves when needed and belief is something you should never change for other people. Time will run away from you but every so often step back and look at how much you've done - it will be amazing.</p>

	    </div>
	</article>
	
	<article class="post">
	    <h1 class="title"><a href="/2010/07/powershell/">Powershell!?!?!?!</a></h1>
	    <div class="meta">
        	<span><img src="/assests/images/date.png" />21 Jul 2010</span>
        	<span><img src="/assests/images/comments.png" /><a href="/2010/07/powershell/#disqus_thread">Comments</a></span>
 			
	        	<ul id="categories">
	        	<li><a href='Fun'>Fun</a></li></ul>
	    	
	    </div>
	    <div class="entry">
	        <p>Most of been bored last night, decided to have my first bash at automation in windows using powershell, kinda impressed but now where near the level that you can get in *nix :D
Hack of an attempt can be seen below (it works mainly but is pretty untested for the function actions as I don't have a windows server that can run hyperv, looks right per the docs though!):</p>

<p>[powershell]</p>

<h1>Settings</h1>

<h2>Email</h2>

<p>$email_system = ""</p>

<p>$email_contact = ""</p>

<p>$email_host = ''</p>

<p>$email_username = ''</p>

<p>$email_password = ''</p>

<h2>Database</h2>

<p>$database_host = ""</p>

<p>$database_name = ""</p>

<p>$database_user = ""</p>

<p>$database_pass = ""</p>

<h2>Run task settings</h2>

<p>$run_tasks = 1</p>

<p>$run_reboots = 1</p>

<p>$run_poweroffs = 1</p>

<p>$run_powerups = 1</p>

<h1>Log file directory</h1>

<p>$file_log_dir = 'C:\automation_logs\'
#</p>

<p>#</p>

<p>#</p>

<h1>Don't touch below here</h1>

<p>#</p>

<p>#</p>

<p>#</p>

<h1>Session varibles</h1>

<p>$base_log_name = $file_log_dir+$(Get-Date -format 'd-M-y-h-m-s')+'-'</p>

<h1>Functions</h1>

<h2>Core functions</h2>

<p>function log([string]$message, [string]$type = 'info')</p>

<p>{</p>

<p>if ((Test-Path -path $file_log_dir) -ne $True){</p>

<h1>Make log dir if it dosn't exist</h1>

<p>write-host 'Making log dir'</p>

<p>New-Item $file_log_dir -type directory</p>

<p>}
$log_file = $base_log_name+$($type)+'.log'</p>

<p>write-host $message</p>

<p>add-content $log_file $message</p>

<p>}
function error([string]$traceback)</p>

<p>{</p>

<p>$error = 'Hit exception:'+$traceback</p>

<p>log $error 'error'</p>

<p>mail 'Exception encountered' $error</p>

<p>}
function mail([string]$subject, [string]$message)</p>

<p>{</p>

<h1>$smtp_handler = new-object Net.Mail.SmtpClient($email_host)</h1>

<h1>$smtp_handler.Credentials = New-Object System.Net.NetworkCredential($email_username, $email_password)</h1>

<h1>$smtp_handler.Send($email_system, $email_contact, $subject, $message)</h1>

<p>}
function marktaskFailed([int]$task_id)</p>

<p>{</p>

<p>$time = [int][double]::Parse((Get-Date -UFormat %s))
try {
 $command = $database_handler.CreateCommand()
 $command.CommandText = "update queue set status = 'f', run_time = '$($time)' where id = '$($task_id)'"</p>

<p>$command.ExecuteNonQuery()</p>

<p>} catch {</p>

<p>log "Could not set status = failed for task id $task_id"</p>

<p>error $_.Exception.ToString()</p>

<p>}</p>

<p>}
function marktaskSuccess([int]$task_id)</p>

<p>{</p>

<p>$time = [int][double]::Parse((Get-Date -UFormat %s))
try {</p>

<p>$command = $database_handler.CreateCommand()</p>

<p>$command.CommandText = "update queue set status = 'c', run_time = '$($time)' where id = '$($task_id)'"</p>

<p>$command.ExecuteNonQuery()</p>

<p>} catch {</p>

<p>log "Could not set status = complete for task id $task_id"</p>

<p>error $_.Exception.ToString()</p>

<p>}</p>

<p>}</p>

<h2>Action functions</h2>

<p>function rebootHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.InitiateShutdown("$true", "Automated shutdown requested")
if($result.returnvalue -match "0"){</p>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM msvm_computersystem WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.requeststatechange(2)
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue powerup"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not shutdown vm"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
function poweroffHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM Msvm_ShutdownComponent WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.InitiateShutdown("$true", "Automated shutdown requested")
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue reboot"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
function poweronHyperVInstance($task)</p>

<p>{</p>

<h1>Un-tested bit but this is right according to the bizzare docs</h1>

<p>$vm = gwmi -namespace root\virtualization -query "SELECT * FROM msvm_computersystem WHERE SystemName = '$($task['machine_id'])'"</p>

<p>$result = $vm.requeststatechange(2)
if($result.returnvalue -match "0"){</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with success status"</p>

<p>marktaskSuccess($task['task_id'])</p>

<p>}else{</p>

<p>log "Task '$($task['task_id'])' ($($task['type'])) completed with failed status, could not issue powerup"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}</p>

<p>&nbsp;</p>

<h1>Main code</h1>

<h2>Load what we need!</h2>

<p>try{</p>

<p>[void][System.Reflection.Assembly]::LoadWithPartialName("MySql.Data")</p>

<p>} catch {</p>

<p>log "Could not load mysql.net connector"</p>

<p>error $_.Exception.ToString()</p>

<p>break</p>

<p>}</p>

<h2>Main loop</h2>

<p>while (1) {</p>

<p>write-host 'Doing run....'</p>

<h2>Connect to the database</h2>

<p>try{</p>

<p>$database_handler = New-Object MySql.Data.MySqlClient.MySqlConnection</p>

<p>$database_handler.ConnectionString = "server=$database_host;uid=$database_user;pwd=$database_pass;database=$database_name;"</p>

<p>$database_handler.Open()</p>

<p>} catch {</p>

<p>log "Could not connect to the database :("</p>

<p>error $_.Exception.ToString()</p>

<p>break</p>

<p>}
write-host 'Connected to database'
try {</p>

<p>$command = $database_handler.CreateCommand()</p>

<p>$command.CommandText = "select * from <code>queue</code> where <code>status</code> = 'n'"</p>

<p>$data = $command.ExecuteReader()</p>

<p>} catch {</p>

<p>log "Could not run query against database"</p>

<p>error $_.Exception.ToString()</p>

<p>continue</p>

<p>}
write-host 'Got queue from database'</p>

<h1>Array where we will put our tasks!</h1>

<p>$tasks_to_run = @()
write-host 'Loading queue'
while ($data.Read()) {</p>

<h1>task</h1>

<p>try {</p>

<p>$task = @{}</p>

<p>$task['type'] = $data.GetValue(1).ToString()</p>

<p>$task['task_id'] = $data.GetValue(0).ToString()</p>

<p>$task['machine_id'] = $data.GetValue(3).ToString()</p>

<h1>Add task to list of tasks to run</h1>

<p>$tasks_to_run += $task</p>

<p>write-host "Entered task $($task['task_id']) into queue"</p>

<p>} catch {</p>

<p>log "Could not add task to queue"</p>

<p>error $_.Exception.ToString()</p>

<p>continue</p>

<p>}</p>

<p>}</p>

<p>$data.close() # Close the data reader</p>

<p>write-host 'Loaded queue'
if($tasks_to_run.length -gt 0){</p>

<p>write-host "Tasks to run: $($tasks_to_run.length)!"</p>

<h1>Loop though the list of tasks to run</h1>

<p>for ( $i = 0 ; $i -lt $tasks_to_run.length; $i++ ){</p>

<p>$task = $tasks_to_run[$i]
log "Running task $($task['task_id']) (Action '$($task['type'])' for instance '$($task['machine_id'])')"
 if($run_tasks -eq 1){</p>

<h1>The bit that decides what we are going to do</h1>

<p>switch ($task['type']) {</p>

<p>poweron {</p>

<p>if($run_powerups -eq 1){</p>

<p>&amp;poweronHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', powerup tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
poweroff {
 if($run_poweroffs -eq 1){</p>

<p>&amp;poweroffHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', poweroff tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
reboot {
 if($run_reboots -eq 1){</p>

<p>&amp;rebootHyperVInstance($task)
 }else{
 log "Not running task '$($task['task_id'])', reboot tasks are disabled"
 marktaskFailed($task['task_id'])
 }</p>

<p>}
default { # We were asked to do something we don't understand!</p>

<p>log "Tried to run an unknown action: '$($task['type'])' for task '$($task['task_id'])' this will need running manually!"</p>

<p>mail "Tried to run an unknown action: '$($task['type'])' for task '$($task['task_id'])' this will need running manually!"</p>

<p>marktaskFailed($task['task_id'])</p>

<p>}</p>

<p>}
 }else{
 log "Not running task '$($task['task_id'])', tasks are disabled"</p>

<p>marktaskFailed($task['task_id'])
 }</p>

<p>}</p>

<p>write-host 'Tasks run'</p>

<p>}else{</p>

<p>write-host "No tasks to run!"</p>

<p>}
write-host 'Run complete....'</p>

<h1>Sleep 10 seconds until next run</h1>

<p>Start-Sleep 10</p>

<p>}
[/powershell]</p>

<p>Anyway back to making this CSS I'm working on look half decent in IE!</p>

	    </div>
	</article>
	
	<article class="post">
	    <h1 class="title"><a href="/2010/07/virt-install-is-a-life-server/">virt-install is a life server</a></h1>
	    <div class="meta">
        	<span><img src="/assests/images/date.png" />06 Jul 2010</span>
        	<span><img src="/assests/images/comments.png" /><a href="/2010/07/virt-install-is-a-life-server/#disqus_thread">Comments</a></span>
 			
	        	<ul id="categories">
	        	<li><a href='Fun'>Fun</a></li><li><a href='General'>General</a></li></ul>
	    	
	    </div>
	    <div class="entry">
	        <p>So on one of my many servers that sit around doing nothing all day I have KVM installed, recently I've been playing about with this quite a bit. Still trying to figure out libvirt and the api to it which is like a black hole when it comes to documented functions as the python classes (which is what I'm using) are generated pretty much straight off the C api stuff. Anyway as I was playing with that and rrdtool trying to make a cool graphing utility I got bored of having to type loads to install a new dom. So thanks to the power of lighttpd to serve my kickstats, virt-install to do the leg work and the amazing thing called lvm I hacked up a bash script to do the hard work for me. Find it as follows:</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="nv">VG</span><span class="o">=</span><span class="s1">&#39;/dev/virtual_disks&#39;</span>
<span class="nv">KS_ADDR</span><span class="o">=</span><span class="s1">&#39;http://192.168.100.1:5843/kickstarts&#39;</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
 centos<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; ks=$KS_ADDR/centos_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://mirror.limestonenetworks.com/centos/5.5/os/x86_64/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 fedora<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; ks=$KS_ADDR/fedora_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://www.mirrorservice.org/sites/download.fedora.redhat.com/pub/fedora/linux/releases/13/Fedora/x86_64/os/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 debian<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; url=$KS_ADDR/debian_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;http://debian.intergenia.de/debian/dists/lenny/main/installer-amd64/&#39;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 ubuntu<span class="o">)</span>
 <span class="nb">test</span> -z <span class="nv">$2</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$3</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="nb">test</span> -z <span class="nv">$4</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>5
 <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$5</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39; url=$KS_ADDR/ubuntu_$5.ks&quot;</span>
 <span class="k">else</span>
<span class="k"> </span><span class="nv">extra</span><span class="o">=</span><span class="s2">&quot;auto=true hostname=$4 domain=&#39;&#39;&quot;</span>
 <span class="k">fi</span>
<span class="k"> </span><span class="nb">echo</span> <span class="s2">&quot;Installing vm $4 with $2G disk and $3 ram allocation passing kernel arguments &#39;$extra&#39;&quot;</span>
 <span class="nv">location</span><span class="o">=</span><span class="s2">&quot;http://ubuntu.intergenia.de/ubuntu/dists/lucid/main/installer-amd64/&quot;</span>
 lvcreate --name <span class="nv">$4</span> --size <span class="nv">$2G</span> virtual_disks
 virt-install --connect qemu:///system --name <span class="nv">$4</span> --ram <span class="nv">$3</span> --hvm --file <span class="nv">$VG</span>/<span class="nv">$4</span> --vnc --location<span class="o">=</span><span class="nv">$location</span> --noautoconsole --extra<span class="o">=</span><span class="s2">&quot;$extra&quot;</span>
 virsh vncdisplay <span class="nv">$4</span>
 ;;
 *<span class="o">)</span>
 <span class="nb">echo</span> <span class="s2">$&quot;Usage: $0 {centos|fedora|debian|ubuntu} {Disk Size} {Ram Allocation} {Name} {Kickstart}&quot;</span>
 <span class="nb">exit </span>2
 ;;
<span class="k">esac</span>
</code></pre>
</div>


<p>Example usage:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>root@virtual1 ~<span class="o">]</span><span class="c"># ./vm_install.sh fedora 50 1024 CharityHosting1 basic</span>
Installing vm CharityHosting1 with 50G disk and 1024 ram allocation passing kernel arguments <span class="s1">&#39;auto=true hostname=CharityHosting1 domain=&#39;&#39; ks=http://192.168.100.1:5843/kickstarts/fedora_basic.ks&#39;</span>
 Logical volume <span class="s2">&quot;CharityHosting1&quot;</span> created
Starting install...
Retrieving file .treeinfo... | 2.4 kB 00:00 ...
Retrieving file vmlinuz... | 6.7 MB 00:01 ...
Retrieving file initrd.img... | 57 MB 00:15 ...
Creating domain... | 0 B 00:00
Domain installation still in progress. You can reconnect to
the console to <span class="nb">complete </span>the installation process.
:0
</code></pre>
</div>


<p>The :0 thrown out at the end is the VNC port you can connect to which is pretty much the console on the vm. Bear in mind this does very very little validation, if a domain is already defined it will error out at that stage so your pretty safe but for example if you tell it to use a lvm that already exists it will error but carry on installing and wipe everything off :-)</p>

<p>2 Variables are as follows:
VG - This is the volume group the lvm's are going to reside in, the path is the format that you would use when calling lvcreate (duh)
KS_ADDR - This is the base http path to where the kick-starts are located, I personally use lighttpd to do this basic job. All kickstats have the format $distro"_"$name".ks"</p>

<p>The main work is done in the kick-start file, at the moment they are pretty static but eventually will be built dynamically out of a database so you can customize things like the root password, set static ips, install packages etc without having to write out a custom one.</p>

<p>The other thing I do along side this is make dnsmasq hand out "static" ips to servers because I use NAT for mapping the public to private addresses, this is because I only run a couple of production vms on that server (Such as the charity hosting servers and graphing server) and the rest are test servers with no need for public addresses.</p>

<p>Setup for dnsmasq/the script to make the assignments static are as follows:
DNSMASQ config:</p>

<div class="highlight"><pre><code class="text">domain-needed
bogus-priv
strict-order
bind-interfaces
listen-address=192.168.100.1
except-interface=lo
dhcp-range=192.168.100.2,192.168.100.254
dhcp-lease-max=253
conf-dir=/etc/dnsmasq.d/
</code></pre>
</div>


<p>/root/fix_leases.py script (this runs every 2min)</p>

<div class="highlight"><pre><code class="python"><span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">leases</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">known_hosts</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/var/lib/dnsmasq/dnsmasq.leases&#39;</span><span class="p">):</span>
 <span class="n">leases_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/var/lib/dnsmasq/dnsmasq.leases&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">leases_fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">clientid</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
 <span class="n">leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
 <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
 <span class="s">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
 <span class="s">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">clientid</span><span class="p">,</span>
 <span class="p">}</span>

<span class="n">leases_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">):</span>
 <span class="n">known_host_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">known_host_fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
 <span class="k">if</span> <span class="s">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;# Host&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
 <span class="k">elif</span> <span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
 <span class="k">if</span> <span class="n">hostname</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s">&#39;Unknown&#39;</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
 <span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
 <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s">&#39;ip&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
 <span class="s">&#39;hostname&#39;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
 <span class="p">}</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<span class="n">new_leases</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">leases</span><span class="p">:</span>
 <span class="k">if</span> <span class="n">mac</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_hosts</span><span class="p">:</span>
 <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span> <span class="o">=</span> <span class="n">leases</span><span class="p">[</span><span class="n">mac</span><span class="p">]</span>

<span class="n">hosts</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/dnsmasq.d/static_leases&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">known_hosts</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">known_hosts</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>
 <span class="n">hosts</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Host </span><span class="si">%s</span><span class="se">\n</span><span class="s">dhcp-host=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>

<span class="k">for</span> <span class="n">mac</span> <span class="ow">in</span> <span class="n">new_leases</span><span class="p">:</span>
 <span class="n">ip</span> <span class="o">=</span> <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
 <span class="n">hostname</span> <span class="o">=</span> <span class="n">new_leases</span><span class="p">[</span><span class="n">mac</span><span class="p">][</span><span class="s">&#39;hostname&#39;</span><span class="p">]</span>
 <span class="n">hosts</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# Host </span><span class="si">%s</span><span class="se">\n</span><span class="s">dhcp-host=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>

<span class="n">hosts</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;Updating done :)&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;service dnsmasq reload&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>To make the above work I run dnsmasq outside of libvirt which is not the default (you have to enable dhcp in libvirt to do it) but it works pretty well for me, just have to clear the leases out every now and then ;-)</p>

<p>Until next time which may include some C as I'm currently working on a DNS management app for the iPhone (I will probably give up on it soon though due to time constrictions!)</p>

	    </div>
	</article>
	


<nav id="page_nav">
	
    <a href="/page/15/" class="prev">Previous</a>
    

    <a href="/archives/" class="center">Blog Archives</a>

	
    <a href="/page/15/" class="next">Next</a>
    
</nav>
</div>

<footer>
    <p class="copyright">Copyright 2009-2012 <a href="http://damianzaremba.co.uk">Damian Zaremba</a></p>
    <p class="ads">
        <ul id="ads">
            <li>Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a></li>
            <li>Need hosting? Try <a href="http://www.vision108.com/">Vision180</a></li>
            <li>Want my website? <a href="http://github.com/DamianZaremba/damianzaremba.co.uk/">Source</a></li>
        </ul>
    </p>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
<![endif]-->

<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="/assests/js/jquery.js"%3E%3C/script%3E'))

    var disqus_shortname = 'damianzaremba';
    var disqus_script = 'count.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</body>
</html>