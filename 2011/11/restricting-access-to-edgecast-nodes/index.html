<!DOCTYPE HTML>
<html>
<head>
    <title>Damian Zaremba - Restricting access to EdgeCast nodes</title>

    <!-- General meta data -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <meta name="copyright" content=">Copyright 2009-2012 Damian Zaremba" />
    <meta name="author" content="Damian Zaremba" />
    <link rel="alternate" type="application/rss+xml" title="Damian Zaremba's Blog" href="http://feeds.feedburner.com/DamianZaremba" />

    <!-- Robot meta data -->
    <meta name="robots" content="INDEX" />
    <meta name="robots" content="FOLLOW" />
    <meta name="robots" content="INDEX,FOLLOW" />
    <meta name="revisit" content="7 days" />

    <!-- M$ meta data -->
    <meta name="classification" content="GENERAL" />
    <meta name="distribution" content="GLOBAL" />
    <meta name="audience" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="TRUE" />

    <!-- CSS files -->
    <link href="http://10.44.200.5:4039/assests/css/main.css" rel="stylesheet" type="text/css" />

    <!-- IE fixes -->
    <!--[if IE]>
        /* hover.htc fixes a bunch of issues with hovering objects in IE */
        body {
            behavior: url("http://10.44.200.5:4039/assests/other/hover.htc");
        }
    <![endif]-->

    <!--
    Site rendered at:  2012-08-17 22:13:46 +0100 by Jekyll.
    RIPA NOTICE: No consent is given for the interception of this page transmission
    -->
</head>

<body>

    <header>
        <h1><a href="/">Damian Zaremba's Blog</a></h1>

        <nav class="menu">
            <ul class="main">
               <li><a href="/">Blog</a></li>
               <li><a href="/archives">Archives</a></li>
               <li><a href="/about">About</a></li>
            </ul>
        </nav>

        <div class="right">
            <form class="search" action="http://google.com/search" method="get">
                <input class="left" type="text" name="q" results="0">
                <input type="hidden" name="q" value="site:damianzaremba.co.uk">
            </form>

            <div class="social">
                <a class="twitter" href="http://twitter.com/DamianZaremba" title="Twitter">Twitter</a>
                <a class="github" href="https://github.com/DamianZaremba" title="GitHub">GitHub</a>
                <a class="rss" href="http://feeds.feedburner.com/DamianZaremba" title="RSS">RSS</a>
           </div>
        </div>
</header>

<div id="content">
<div id="post">
<p>Today one of our clients published a mix track that was around 140mb, hosted on their account. This was no problem until he started to get hundreds of people downloading the mix which resulted in silly amounts of bandwidth being used.</p>

<p>We quickly had to move him on to the CDN to ensure the traffic impact wasn't affecting performance for him or others as well as reduce his bandwidth charges substantially.</p>

<p>Once the CDN was all set up and the content pushed out onto the nodes we started to send traffic over.</p>

<p>Due to the impact of social media and people linking directly to the content we had to devise a plan to enable access to the content for the CDN but redirect anyone linking directly to the CDNified subdomain.</p>

<p>In comes mod_rewrite. Now it appears EdgeCast don't publish their IP ranges in any format that helps my sanity, they are in fact published in a html table. To find them, login to my.edgecast.com, browse to HTTP Large, click on Customer Origin and scroll down to the bottom.</p>

<p>Linux to the rescue! First we just copy the list into a file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>cat &gt; edgecast_ranges
Asia Hong Kong 117.18.234.0 - 117.18.234.255
110.232.176.0 - 110.232.176.255
Asia Singapore 117.18.236.0 - 117.18.236.255
46.22.71.0 - 46.22.71.255
Asia Tokyo 117.18.233.0 - 117.18.233.255
110.232.177.0 - 110.232.177.255
Australia Sydney 117.18.235.0 - 117.18.235.255
110.232.179.0 - 110.232.179.255
Europe Amsterdam 93.184.208.0 - 93.184.208.255
93.184.209.0 - 93.184.209.255
93.184.217.0 - 93.184.217.255
46.22.70.0 - 46.22.70.255
46.22.72.0 - 46.22.73.255
Europe Frankfurt 72.21.89.0 - 72.21.89.255
93.184.212.0 - 93.184.212.255
93.184.213.0 - 93.184.213.255
Europe London 72.21.90.0 - 72.21.90.255
93.184.210.0 - 93.184.210.255
93.184.211.0 - 93.184.211.255
46.22.74.0 - 46.22.75.255
Europe Madrid 46.22.66.0 - 46.22.67.255
Europe Paris 93.184.214.0 - 93.184.214.255
North America Ashburn 72.21.83.0 - 72.21.83.255
68.232.36.0 - 68.232.36.255
North America Atlanta 72.21.88.0 - 72.21.88.255
72.21.93.0 - 72.21.93.255
North America Chicago 72.21.87.0 - 72.21.87.255
68.232.38.0 - 68.232.38.255
North America Dallas 72.21.86.0 - 72.21.86.255
68.232.39.0 - 68.232.39.255
North America Los Angeles 72.21.84.0 - 72.21.84.255
68.232.40.0 - 68.232.40.255
72.21.94.0 - 72.21.94.255
93.184.218.0 - 93.184.218.255
46.22.69.0 - 46.22.69.255
North America Miami 46.22.64.0 - 46.22.65.255
North America New York 72.21.95.0 - 72.21.95.255
68.232.37.0 - 68.232.37.255
North America San Jose
North America San Jose 72.21.82.0 - 72.21.82.255
68.232.41.0 - 68.232.41.255
North America Seattle 72.21.85.0 - 72.21.85.255
Other N/A 72.21.80.0 - 72.21.80.255
72.21.81.0 - 72.21.81.255
72.21.91.0 - 72.21.91.255
72.21.92.0 - 72.21.92.255
117.18.232.0 - 117.18.232.255
93.184.221.0 - 93.184.221.255
93.184.220.0 - 93.184.220.255
93.184.219.0 - 93.184.219.255
117.18.237.0 - 117.18.237.255
93.184.215.0 - 93.184.215.255
93.184.216.0 - 93.184.216.255
68.232.32.0 - 68.232.32.255
68.232.33.0 - 68.232.33.255
68.232.34.0 - 68.232.34.255
68.232.35.0 - 68.232.35.255
68.232.42.0 - 68.232.42.255
68.232.43.0 - 68.232.43.255
68.232.44.0 - 68.232.44.255
68.232.45.0 - 68.232.45.255
68.232.46.0 - 68.232.46.255
68.232.47.0 - 68.232.47.255
93.184.222.0 - 93.184.222.255
93.184.223.0 - 93.184.223.255
110.232.178.0 - 110.232.178.255
117.18.237.0 - 117.18.237.255
117.18.238.0 - 117.18.238.255
117.18.239.0 - 117.18.239.255
</code></pre>
</div>


<p>Next we need to clear out all the names etc that are randomly dumped in the file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/^.*\s.*\s//g&#39;</span> edgecast_ranges <span class="c"># Get rid of place names</span>
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;/^\s*$/d&#39;</span> edgecast_ranges <span class="c"># Get rid of blank lines</span>
</code></pre>
</div>


<p>Now let's actually turn these IP ranges into something Apache can understand (they are all /24's so we can cheat):</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/^/RewriteCond %{REMOTE_ADDR} !^/g&#39;</span> edgecast_ranges <span class="c"># Add the rewrite cond</span>
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>sed -i <span class="s1">&#39;s/\.255$/.*$/g&#39;</span> edgecast_ranges <span class="c"># Add the wildcard</span>
</code></pre>
</div>


<p>Now let's create the actual htaccess file:</p>

<div class="highlight"><pre><code class="bash"><span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;RewriteEngine On&#39;</span> &gt;&gt; .htaccess
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span>cat edgecast_ranges &gt;&gt; .htaccess
<span class="o">[</span>damian@finnix ~<span class="o">]</span><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;RewriteRule ^downloads/(.*)$ http://media.example.com/$1 [R,L]&#39;</span> &gt;&gt; .htaccess
</code></pre>
</div>


<p>You should end up with something looking like this:</p>

<div class="highlight"><pre><code class="bash">RewriteEngine On
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.234.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.176.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.236.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.71.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.233.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.177.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.235.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.179.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.208.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.209.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.217.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.70.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.72.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.89.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.212.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.213.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.90.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.210.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.211.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.74.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.66.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.214.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.83.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.36.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.88.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.93.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.87.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.38.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.86.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.39.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.84.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.40.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.94.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.218.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.69.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^46.22.64.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.95.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.37.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.82.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.41.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.85.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.80.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.81.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.91.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^72.21.92.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.232.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.221.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.220.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.219.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.237.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.215.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.216.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.32.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.33.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.34.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.35.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.42.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.43.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.44.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.45.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.46.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^68.232.47.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.222.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^93.184.223.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^110.232.178.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.237.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.238.*<span class="err">$</span>
RewriteCond %<span class="o">{</span>REMOTE_ADDR<span class="o">}</span> !^117.18.239.*<span class="err">$</span>
RewriteRule ^downloads/<span class="o">(</span>.*<span class="o">)</span><span class="nv">$ </span>http://media.example.com/<span class="nv">$1</span> <span class="o">[</span>R,L<span class="o">]</span>
</code></pre>
</div>


<p>If you browse to http://example.com/downloads/ you should be redirected to http://media.example.com/ unless you are coming from an Edgecast IP range.</p>

<p>Now you can go back to reading slashdot ;)</p>

</div>

<section id="related">
	<h1>Comments</h1>
	<ul class="posts">
	
		<li><span>07 Dec 2010</span> &raquo; <a href="/2010/12/system-activity-reporter">System activity reporter</a></li>
	
		<li><span>28 Jun 2011</span> &raquo; <a href="/2011/06/meth-stove">Meth stove</a></li>
	
		<li><span>06 Jul 2010</span> &raquo; <a href="/2010/07/virt-install-is-a-life-server">virt-install is a life server</a></li>
	
	</ul>
</section>

<section id="comment">
	<h1>Comments</h1>
	<div id="disqus_thread" aria-live="polite">
		<noscript>Please enable JavaScript to view the comments</noscript>
	</div>
</section>

<script type="text/javascript">
    var disqus_shortname = 'damianzaremba';
    var disqus_identifier = '';
    var disqus_url = '';
    var disqus_script = 'embed.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</div>

<footer>
    <p>Copyright 2009-2012 Damian Zaremba</p>
    <p>
        Need error logging? Try <a href="https://getsentry.com/signup/r_D0ZW/">Sentry</a> &dash;
        Need hosting? Try <a href="http://www.vision108.com/">Vision180</a>
    </p>
</footer>

<script src="http://10.44.200.5:4039/assests/js/jquery.fancybox.pack.js"></script>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="http://10.44.200.5:4039/assests/js/jquery.js"%3E%3C/script%3E'))
</script>
<![endif]-->

<script type="text/javascript">
    !window.jQuery && document.write(unescape('%3Cscript src="http://10.44.200.5:4039/assests/js/jquery.js"%3E%3C/script%3E'))

    var disqus_shortname = 'damianzaremba';
    var disqus_script = 'count.js';

    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
</body>
</html>